<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gerenciador de Games</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: Inter, system-ui, sans-serif; background:#0b0b0b; color:#e6e6e6; }
    
    /* Card estilo "Antigo" mas com cores Novas */
    .card { 
        background:#151515; 
        border:1px solid #2a2a2a; 
        transition:all .2s; 
        display: flex;
        flex-direction: column; /* Garante imagem em cima, texto em baixo */
    }
    .card:hover { 
        border-color:#B9314F; 
        transform:translateY(-4px); 
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
    }
    
    .btn-primary { background:#B9314F; color: white; }
    .btn-primary:hover { background:#99233b; }
    
    .modal-input, .filter-input {
      background-color: #1f2937; 
      border: 1px solid #374151; 
      color: white;
    }
    .modal-input:focus, .filter-input:focus {
      outline: none;
      border-color: #B9314F;
    }
  </style>
</head>
<body class="min-h-screen">

  <div id="loading-spinner" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60">
    <div class="animate-spin h-16 w-16 border-4 border-t-transparent border-[#B9314F] rounded-full"></div>
  </div>

  <div id="main-app" class="container mx-auto p-6 max-w-7xl hidden">
    
    <header class="bg-[#1f1f1f] p-4 flex flex-col sm:flex-row sm:items-center sm:justify-between shadow-lg rounded-lg border border-[#2a2a2a]">
      <div class="flex flex-col w-full">
        <div class="flex justify-between items-center">
          <button 
            onclick="window.location.href='home.html'"
            class="text-2xl font-bold text-[#B9314F] hover:text-[#992743] transition-colors"
          >
            My Hub
          </button>
          <h1 class="text-2xl font-bold text-white">My Games</h1>
        </div>
        <div class="flex justify-between items-center mt-2 border-t border-gray-700 pt-2">
          <div class="text-sm text-gray-400">
            Usu√°rio: <span id="user-id-display" class="text-[#B9314F] font-mono">...</span>
          </div>
          <button id="auth-btn" class="text-xs text-red-400 hover:text-red-300 underline">Sair</button>
        </div>
      </div>
    </header>

    <div class="mt-6 mb-6 flex justify-between items-center gap-4 flex-wrap">
      <button 
        id="add-item-btn"
        class="bg-[#B9314F] hover:bg-[#992743] px-4 py-2 rounded-md text-white shadow-md font-medium"
      >
        + Adicionar Game
      </button>

      <button 
        id="search-btn" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-md text-white border border-gray-700">
        Mostrar Filtros
      </button>
    </div>

    <div id="search-and-sort-container" class="hidden bg-[#151515] border border-[#2a2a2a] p-4 rounded-lg mb-6 shadow-md">
      <section class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <input id="search-input" type="text" placeholder="Pesquisar..." class="p-2 rounded filter-input">
        <select id="status-filter" class="p-2 rounded filter-input"></select>
        <select id="stars-filter" class="p-2 rounded filter-input">
            <option value="">Todas as estrelas</option>
            <option value="5">5 Estrelas</option>
            <option value="4">4 Estrelas</option>
            <option value="3">3 Estrelas</option>
            <option value="2">2 Estrelas</option>
            <option value="1">1 Estrela</option>
        </select>
        <select id="sort-select" class="p-2 rounded filter-input">
            <option value="createdAt-desc">Mais Recentes</option>
            <option value="name-asc">Nome (A-Z)</option>
            <option value="stars-desc">Melhores Avaliados</option>
            <option value="hours-desc">Mais Jogados</option>
        </select>
      </section>
    </div>

    <div id="cards-view" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
    
    <div id="empty-state" class="text-center p-8 hidden col-span-full">
        <p class="text-xl text-gray-500">Nenhum jogo encontrado.</p>
    </div>

  </div>

  <div id="item-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50 p-4 overflow-y-auto">
    <div class="bg-[#1a1a1a] rounded-lg w-full max-w-lg p-6 border border-gray-700 shadow-2xl relative">
      <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
      
      <h2 id="modal-title" class="text-xl font-bold text-white mb-6 border-b border-gray-800 pb-2">Novo Jogo</h2>
      
      <form id="item-form" class="space-y-4">
        <input type="hidden" id="item-id">
        
        <div>
          <label class="block text-sm text-gray-400 mb-1">Nome do Jogo</label>
          <input id="item-name" type="text" class="w-full p-2 rounded modal-input" required>
        </div>
        
        <div>
          <label class="block text-sm text-gray-400 mb-1">Imagem (URL)</label>
          <input id="item-image" type="url" class="w-full p-2 rounded modal-input" placeholder="https://...">
        </div>
        
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm text-gray-400 mb-1">Estrelas</label>
            <select id="item-stars" class="w-full p-2 rounded modal-input">
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-1">Status</label>
            <select id="item-status" class="w-full p-2 rounded modal-input"></select>
          </div>
        </div>

        <div class="grid grid-cols-3 gap-2 bg-[#252525] p-2 rounded border border-gray-800">
            <div>
                <label class="block text-xs text-gray-500 mb-1">In√≠cio</label>
                <input id="item-date-start" type="date" class="w-full p-1 rounded modal-input text-xs">
            </div>
            <div>
                <label class="block text-xs text-gray-500 mb-1">Fim</label>
                <input id="item-date-end" type="date" class="w-full p-1 rounded modal-input text-xs">
            </div>
            <div>
                <label class="block text-xs text-gray-500 mb-1">Horas</label>
                <input id="item-count-games" type="number" min="0" class="w-full p-1 rounded modal-input text-xs">
            </div>
        </div>

        <details id="arts_group" class="bg-[#1f1f1f] p-3 mb-3 shadow-xl rounded-xl border border-[#2a2a2a] group/details">
            <summary class="cursor-pointer text-[#B9314F] font-bold list-none flex justify-between items-center select-none">
                <span class="flex items-center gap-2">
                    üé® Arts e Prints (<span id="arts_count" class="text-white">0</span>)
                </span>
                <span class="text-gray-500 group-open/details:rotate-180 transition-transform">‚ñº</span>
            </summary>

            <div class="mt-4 grid grid-cols-1 sm:grid-cols-4 gap-3 bg-[#151515] p-3 rounded-lg border border-[#333]">
                <select id="art-type" class="bg-[#1f2937] border border-gray-700 text-white rounded px-2 py-2 text-sm focus:border-[#B9314F] outline-none">
                    <option value="Art">Art</option>
                    <option value="Print">Print</option>
                </select>

                <input id="art-name" type="text" placeholder="Nome (Opcional)" 
                       class="bg-[#1f2937] border border-gray-700 text-white rounded px-2 py-2 text-sm focus:border-[#B9314F] outline-none sm:col-span-3">

                <input id="art-url" type="url" placeholder="URL da Imagem (https://...)" 
                       class="bg-[#1f2937] border border-gray-700 text-white rounded px-2 py-2 text-sm focus:border-[#B9314F] outline-none sm:col-span-3">

                <button type="button" id="btn-add-art"
                        class="bg-[#B9314F] hover:bg-[#99233b] text-white rounded px-2 py-2 text-sm font-bold transition-colors shadow-md">
                    Adicionar
                </button>
            </div>

            <ul id="arts-list" class="mt-4 space-y-2 max-h-60 overflow-y-auto pr-1 scrollbar-thin scrollbar-thumb-gray-700 scrollbar-track-transparent">
                </ul>
        </details>

        <div>
          <label class="block text-sm text-gray-400 mb-1">Observa√ß√µes</label>
          <textarea id="item-notes" rows="3" class="w-full p-2 rounded modal-input"></textarea>
        </div>

        <div class="flex justify-end gap-3 pt-4 border-t border-gray-800">
          <button type="button" onclick="document.getElementById('item-modal').classList.add('hidden')" class="px-4 py-2 rounded bg-gray-700 hover:bg-gray-600 text-white">Cancelar</button>
          <button id="delete-item-btn" type="button" class="px-4 py-2 rounded bg-red-900/50 hover:bg-red-600 text-red-200 hover:text-white border border-red-900 hidden">Excluir</button>
          <button type="submit" class="px-4 py-2 rounded btn-primary font-medium">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <div id="image-view-modal" class="fixed inset-0 bg-black bg-opacity-90 hidden items-center justify-center z-[60] p-4">
        <div class="relative max-w-4xl w-full flex flex-col items-center">
            <button onclick="document.getElementById('image-view-modal').classList.add('hidden')" 
                    class="absolute -top-10 right-0 text-white hover:text-[#B9314F] text-3xl font-bold transition-colors">
                &times;
            </button>
            <img id="view-modal-img" src="" class="max-h-[80vh] w-auto rounded-lg border-2 border-[#B9314F] shadow-2xl object-contain">
            <p id="view-modal-caption" class="text-white mt-4 text-lg font-semibold bg-[#151515] px-4 py-2 rounded-full border border-[#333]"></p>
        </div>
    </div>

  <div id="message-box" class="fixed bottom-4 right-4 p-4 rounded-lg text-white font-medium z-50 hidden shadow-lg"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, query, onSnapshot, addDoc, setDoc, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- CONFIGURA√á√ÉO FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyDsbiLPBOda119Qr6Ji69j8TZLpiFixBWI",
        authDomain: "list-games-9bddd.firebaseapp.com",
        projectId: "list-games-9bddd",
        storageBucket: "list-games-9bddd.appspot.com",
        messagingSenderId: "756898313156",
        appId: "1:756898313156:web:9bc660d0a2f4cd07882a91",
        measurementId: "G-GLM50YVLXP"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Vari√°veis
    let userId = null;
    let allGames = [];
    let authChecked = false;
    let currentArts = [];

    // DOM Elements
    const els = {
        loading: document.getElementById('loading-spinner'),
        app: document.getElementById('main-app'),
        cards: document.getElementById('cards-view'),
        empty: document.getElementById('empty-state'),
        msgBox: document.getElementById('message-box'),
        filterCont: document.getElementById('search-and-sort-container'),
        search: document.getElementById('search-input'),
        sort: document.getElementById('sort-select'),
        stars: document.getElementById('stars-filter'),
        status: document.getElementById('status-filter'),
        addBtn: document.getElementById('add-item-btn'),
        searchBtn: document.getElementById('search-btn'),
        authBtn: document.getElementById('auth-btn'),
        modal: document.getElementById('item-modal'),
        closeModal: document.getElementById('close-modal-btn'),
        form: document.getElementById('item-form'),
        modalTitle: document.getElementById('modal-title'),
        deleteBtn: document.getElementById('delete-item-btn'),
        userIdDisp: document.getElementById('user-id-display'),
        inputs: {
            id: document.getElementById('item-id'),
            name: document.getElementById('item-name'),
            image: document.getElementById('item-image'),
            stars: document.getElementById('item-stars'),
            start: document.getElementById('item-date-start'),
            end: document.getElementById('item-date-end'),
            hours: document.getElementById('item-count-games'),
            status: document.getElementById('item-status'),
            notes: document.getElementById('item-notes')
        }
    };

    const statusOptions = [
        { value: "N√£o Jogou", text: "N√£o Jogou" },
        { value: "Jogando", text: "Jogando" },
        { value: "Zerado", text: "Zerado" },
        { value: "Dropei", text: "Dropei" },
        { value: "Jogado", text: "Jogado" },
        { value: "N√£o Lan√ßado", text: "N√£o Lan√ßado" }
    ];

    // Helpers
    const toggleLoading = (show) => {
        if(show) { els.loading.classList.remove('hidden'); els.app.classList.add('hidden'); }
        else { els.loading.classList.add('hidden'); els.app.classList.remove('hidden'); }
    };

    const showMsg = (txt, isErr = false) => {
        els.msgBox.textContent = txt;
        els.msgBox.className = `fixed bottom-4 right-4 p-4 rounded-lg text-white font-medium z-50 shadow-lg ${isErr ? 'bg-red-600' : 'bg-green-600'}`;
        els.msgBox.classList.remove('hidden');
        setTimeout(() => els.msgBox.classList.add('hidden'), 3000);
    };

    const formatDate = (d) => {
        if (!d) return '--/--';
        if (typeof d === 'string' && d.includes('-')) {
            const [y,m,day] = d.split('-'); return `${day}/${m}/${y.slice(2)}`;
        }
        return d;
    };

    // --- RENDERIZA√á√ÉO DOS CARDS (GRID + IMAGEM HORIZONTAL) ---
    const renderCard = (item) => {
        const hours = (item.hours || 0) + 'h';
        const stars = parseInt(item.stars) || 0;
        
        let statusColor = 'bg-gray-700 text-gray-200';
        if(item.status === 'Zerado') statusColor = 'bg-green-900 text-green-100 border border-green-700';
        else if(item.status === 'Jogando') statusColor = 'bg-blue-900 text-blue-100 border border-blue-700';
        else if(item.status === 'Dropei') statusColor = 'bg-red-900 text-red-100 border border-red-700';

        // Layout: Card Vertical (Flex-Col) com Imagem Larga no topo
        return `
        <div data-id="${item.id}" class="card rounded-lg overflow-hidden cursor-pointer relative group">
            
            <div class="relative w-full h-48 bg-gray-800">
                <img src="${item.image || ''}" 
                     class="w-full h-full object-cover"
                     onerror="this.src='https://placehold.co/600x400/1a1a1a/333?text=Sem+Imagem'">
                
                <span class="absolute top-2 right-2 text-xs font-bold px-2 py-1 rounded shadow-md ${statusColor}">
                    ${item.status || 'Status?'}
                </span>
            </div>

            <div class="p-4 flex flex-col gap-2">
                
                <div>
                    <h3 class="text-lg font-bold text-white leading-tight truncate" title="${item.name}">${item.name}</h3>
                    <div class="text-yellow-400 text-sm mt-1">
                        ${'‚òÖ'.repeat(stars)}${'<span class="text-gray-600">‚òÖ</span>'.repeat(5-stars)}
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-1 mt-2 pt-3 border-t border-gray-800 text-xs">
                    <div class="flex flex-col">
                        <span class="text-gray-500 uppercase text-[10px]">In√≠cio</span>
                        <span class="text-gray-300 font-mono">${formatDate(item.dateStart)}</span>
                    </div>
                     <div class="flex flex-col text-center border-l border-r border-gray-800">
                        <span class="text-gray-500 uppercase text-[10px]">Horas</span>
                        <span class="text-[#B9314F] font-mono font-bold">${hours}</span>
                    </div>
                    <div class="flex flex-col text-right">
                        <span class="text-gray-500 uppercase text-[10px]">Fim</span>
                        <span class="text-gray-300 font-mono">${formatDate(item.dateEnd)}</span>
                    </div>
                </div>

            </div>
        </div>
        `;
    };

    const filterSortRender = () => {
        let list = [...allGames];
        const sTxt = els.search.value.toLowerCase();
        const sStatus = els.status.value;
        const sStars = els.stars.value;
        const sSort = els.sort.value;

        list = list.filter(i => {
            return (i.name||'').toLowerCase().includes(sTxt) &&
                   (!sStatus || i.status === sStatus) &&
                   (!sStars || (i.stars||0) == sStars);
        });

        list.sort((a,b) => {
            switch(sSort) {
                case 'name-asc': return (a.name||'').localeCompare(b.name||'');
                case 'stars-desc': return (b.stars||0) - (a.stars||0);
                case 'hours-desc': return (b.hours||0) - (a.hours||0);
                default: return (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0);
            }
        });

        els.cards.innerHTML = list.map(renderCard).join('');
        if(list.length === 0) els.empty.classList.remove('hidden');
        else els.empty.classList.add('hidden');
    };

    // --- A√ß√µes ---
    const openModal = (id = null) => {
        els.form.reset();
        els.inputs.id.value = '';
        els.deleteBtn.classList.add('hidden');
        els.modalTitle.textContent = id ? 'Editar Jogo' : 'Novo Jogo';
        
        // Resetar lista de Arts
        currentArts = [];
        renderArtsList(); 

        if(id) {
            const item = allGames.find(i => i.id === id);
            if(item) {
                els.inputs.id.value = item.id;
                els.inputs.name.value = item.name || '';
                els.inputs.image.value = item.image || '';
                els.inputs.stars.value = item.stars || '0';
                els.inputs.start.value = item.dateStart || '';
                els.inputs.end.value = item.dateEnd || '';
                els.inputs.hours.value = item.hours || '';
                els.inputs.status.value = item.status || '';
                els.inputs.notes.value = item.notes || '';
                
                // CARREGAR ARTS SE EXISTIREM
                if (item.arts && Array.isArray(item.arts)) {
                    currentArts = [...item.arts];
                    renderArtsList();
                }

                els.deleteBtn.classList.remove('hidden');
            }
        }
        els.modal.classList.remove('hidden');
        els.modal.classList.add('flex');
    };

    // --- ATUALIZAR A FUN√á√ÉO HANDLESUBMIT ---
    const handleSubmit = async (e) => {
        e.preventDefault();
        if(!userId) return;

        const id = els.inputs.id.value;
        const d = {
            name: els.inputs.name.value.trim(),
            image: els.inputs.image.value.trim(),
            stars: parseInt(els.inputs.stars.value) || 0,
            dateStart: els.inputs.start.value,
            dateEnd: els.inputs.end.value,
            hours: parseInt(els.inputs.hours.value) || 0,
            status: els.inputs.status.value,
            notes: els.inputs.notes.value,
            
            // ADICIONAR O ARRAY DE ARTS NO PAYLOAD
            arts: currentArts, 
            
            updatedAt: serverTimestamp()
        };

        try {
            if(id) {
                await setDoc(doc(db, 'users', userId, 'games', id), d, { merge: true });
                showMsg('Atualizado com sucesso!');
            } else {
                d.createdAt = serverTimestamp();
                await addDoc(collection(db, 'users', userId, 'games'), d);
                showMsg('Criado com sucesso!');
            }
            els.modal.classList.add('hidden');
        } catch(err) { console.error(err); showMsg('Erro ao salvar', true); }
    };

    const handleDelete = async () => {
        const id = els.inputs.id.value;
        if(!id || !userId) return;
        try {
            await deleteDoc(doc(db, 'users', userId, 'games', id));
            showMsg('Exclu√≠do!');
            els.modal.classList.add('hidden');
        } catch(err) { showMsg('Erro ao excluir', true); }
    };

    // --- FUN√á√ïES DE ARTS E PRINTS ---

    // 1. Renderizar a lista na tela
    const renderArtsList = () => {
        const listEl = document.getElementById('arts-list');
        const countEl = document.getElementById('arts_count');
        
        listEl.innerHTML = '';
        countEl.textContent = currentArts.length;

        currentArts.forEach((art, index) => {
            const li = document.createElement('li');
            li.className = "flex items-center justify-between bg-[#252525] p-2 rounded border border-[#333] hover:border-[#444] transition-colors";
            
            // √çcones SVG
            const iconEye = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>`;
            const iconEdit = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`;
            const iconTrash = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`;

            li.innerHTML = `
                <div class="flex items-center gap-3 overflow-hidden">
                    <span class="text-xs font-bold uppercase px-2 py-1 rounded bg-[#1f1f1f] text-gray-400 border border-gray-700 min-w-[50px] text-center">
                        ${art.type}
                    </span>
                    <span class="text-sm text-gray-200 truncate" title="${art.name || 'Sem nome'}">
                        ${art.name || art.url}
                    </span>
                </div>
                <div class="flex gap-2 shrink-0 ml-2">
                    <button type="button" class="btn-view-art p-1.5 rounded bg-blue-900/40 text-blue-400 hover:bg-blue-900 hover:text-white transition-colors" data-idx="${index}" title="Visualizar">
                        ${iconEye}
                    </button>
                    <button type="button" class="btn-edit-art p-1.5 rounded bg-yellow-900/40 text-yellow-400 hover:bg-yellow-900 hover:text-white transition-colors" data-idx="${index}" title="Editar">
                        ${iconEdit}
                    </button>
                    <button type="button" class="btn-delete-art p-1.5 rounded bg-red-900/40 text-red-400 hover:bg-red-900 hover:text-white transition-colors" data-idx="${index}" title="Excluir">
                        ${iconTrash}
                    </button>
                </div>
            `;
            listEl.appendChild(li);
        });

        // Reatribuir eventos aos bot√µes din√¢micos
        document.querySelectorAll('.btn-view-art').forEach(btn => 
            btn.onclick = (e) => viewArt(e.currentTarget.dataset.idx));
        
        document.querySelectorAll('.btn-delete-art').forEach(btn => 
            btn.onclick = (e) => deleteArt(e.currentTarget.dataset.idx));
            
        document.querySelectorAll('.btn-edit-art').forEach(btn => 
            btn.onclick = (e) => editArt(e.currentTarget.dataset.idx));
    };

    // 2. Adicionar Item
    const addArt = () => {
        const typeEl = document.getElementById('art-type');
        const nameEl = document.getElementById('art-name');
        const urlEl = document.getElementById('art-url');

        if (!urlEl.value.trim()) {
            showMsg('Insira a URL da imagem!', true);
            return;
        }

        currentArts.push({
            type: typeEl.value,
            name: nameEl.value.trim(),
            url: urlEl.value.trim()
        });

        // Limpar inputs
        nameEl.value = '';
        urlEl.value = '';
        typeEl.value = 'Art'; // Resetar para o padr√£o
        
        renderArtsList();
    };

    // 3. Deletar Item
    const deleteArt = (index) => {
        currentArts.splice(index, 1);
        renderArtsList();
    };

    // 4. Editar Item (Remove da lista e joga de volta nos inputs)
    const editArt = (index) => {
        const item = currentArts[index];
        document.getElementById('art-type').value = item.type;
        document.getElementById('art-name').value = item.name;
        document.getElementById('art-url').value = item.url;
        
        deleteArt(index); // Remove para n√£o duplicar ao salvar
        document.getElementById('art-url').focus(); // Foca no input
    };

    // 5. Visualizar Item (Abre Modal de Imagem)
    const viewArt = (index) => {
        const item = currentArts[index];
        const viewModal = document.getElementById('image-view-modal');
        const imgEl = document.getElementById('view-modal-img');
        const captionEl = document.getElementById('view-modal-caption');

        imgEl.src = item.url;
        captionEl.textContent = item.name || item.type;
        captionEl.classList.toggle('hidden', !item.name); // Esconde legenda se n√£o tiver nome

        viewModal.classList.remove('hidden');
        viewModal.classList.add('flex');
    };

    const setupEvents = () => {
        els.addBtn.onclick = () => openModal();
        els.searchBtn.onclick = () => els.filterCont.classList.toggle('hidden');
        els.closeModal.onclick = () => els.modal.classList.add('hidden');
        els.form.onsubmit = handleSubmit;
        els.deleteBtn.onclick = handleDelete;
        els.authBtn.onclick = () => signOut(auth);

        document.getElementById('btn-add-art').onclick = addArt;

        els.cards.onclick = (e) => {
            const c = e.target.closest('.card');
            if(c) openModal(c.dataset.id);
        };

        [els.search, els.sort, els.stars, els.status].forEach(i => i.oninput = filterSortRender);

        // Preencher selects
        const fill = (sel) => statusOptions.forEach(o => sel.innerHTML += `<option value="${o.value}">${o.text}</option>`);
        els.inputs.status.innerHTML = '<option value="">Selecione...</option>';
        els.status.innerHTML = '<option value="">Todos os Status</option>';
        fill(els.inputs.status);
        fill(els.status);
    };

    // --- Init ---
    onAuthStateChanged(auth, (u) => {
        if(u) {
            userId = u.uid;
            els.userIdDisp.textContent = u.email || u.uid;
            const q = query(collection(db, 'users', userId, 'games'));
            onSnapshot(q, (snap) => {
                allGames = [];
                snap.forEach(d => allGames.push({ id:d.id, ...d.data() }));
                filterSortRender();
                toggleLoading(false);
            });
        } else {
            userId = null;
            if(authChecked) window.location.href = 'index.html';
        }
        authChecked = true;
    });

    window.onload = () => {
        setupEvents();
        toggleLoading(true);
    };
  </script>
</body>
</html>
