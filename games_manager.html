<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gerenciador de Games — My Hub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
      /* Configurações Base */
      :root {
          --accent-color: #B9314F;
          --bg-dark: #0b0b0b;
          --bg-panel: #151515;
      }
      body {
          background-color: var(--bg-dark);
          color: #e6e6e6;
          font-family: 'Inter', system-ui, sans-serif;
          /* Gradiente de fundo sutil estilo Xbox */
          background-image: radial-gradient(circle at top right, rgba(185, 49, 79, 0.1), transparent 40%),
                            radial-gradient(circle at bottom left, rgba(20, 20, 20, 1), transparent 40%);
          min-height: 100vh;
      }

      /* Utilitários de Estilo */
      .text-accent { color: var(--accent-color); }
      .bg-accent { background-color: var(--accent-color); }
      
      /* Painéis translúcidos */
      .glass-panel {
          background: rgba(21, 21, 21, 0.8);
          backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.05);
      }

      /* Cards com efeito Xbox */
      .task-card {
          background: rgba(30, 30, 30, 0.4);
          backdrop-filter: blur(12px);
          -webkit-backdrop-filter: blur(12px);
          border: 1px solid rgba(255, 255, 255, 0.05);
          transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
          box-shadow: 0 8px 16px -4px rgba(0, 0, 0, 0.4);
      }
      .task-card:hover {
          transform: translateY(-4px);
          background: rgba(40, 40, 40, 0.6);
          border-color: rgba(185, 49, 79, 0.3);
          box-shadow: 0 12px 24px -5px rgba(0, 0, 0, 0.6), 0 0 15px rgba(185, 49, 79, 0.1);
      }

      /* Inputs estilo Xbox */
      input, select, textarea {
          background: rgba(0, 0, 0, 0.4);
          border: 2px solid rgba(255, 255, 255, 0.1);
          transition: all 0.3s;
          color: white;
          color-scheme: dark;
      }
      input:focus, select:focus, textarea:focus {
          border-color: var(--accent-color);
          box-shadow: 0 0 0 3px rgba(185, 49, 79, 0.1);
          outline: none;
      }

      option {
          background-color: var(--bg-panel);
          color: #e6e6e6;
          padding: 10px;
      }

      /* Botões com efeito Xbox */
      .xbox-button {
          position: relative;
          overflow: hidden;
          transition: all 0.3s;
      }
      .xbox-button::before {
          content: '';
          position: absolute;
          inset: 0;
          background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
          transform: translateX(-100%);
          transition: transform 0.6s;
      }
      .xbox-button:hover::before {
          transform: translateX(100%);
      }
      .xbox-button:hover {
          transform: scale(1.02);
          box-shadow: 0 0 20px rgba(185, 49, 79, 0.4);
      }

      /* Scrollbar customizada */
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: var(--bg-dark); }
      ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: var(--accent-color); }

      /* Sidebar retrátil */
      .sidebar {
          position: fixed;
          left: 0;
          top: 0;
          bottom: 0;
          width: 80px;
          transform: translateX(0);
          transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
          z-index: 50;
      }
      .sidebar.hidden {
          transform: translateX(-100%);
      }
      
      .main-content {
          margin-left: 80px;
          transition: margin-left 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      }
      .main-content.sidebar-hidden {
          margin-left: 0;
      }

      .toggle-sidebar-btn {
          transition: all 0.3s;
      }
      .toggle-sidebar-btn:hover {
          transform: scale(1.1);
          box-shadow: 0 0 15px rgba(185, 49, 79, 0.4);
      }
  </style>
</head>
<body class="flex h-screen overflow-hidden">

  <!-- OVERLAY DE CARREGAMENTO -->
  <div id="loading-spinner" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm">
    <div class="animate-spin h-16 w-16 border-4 border-t-transparent border-[#B9314F] rounded-full"></div>
  </div>

  <!-- SIDEBAR RETRÁTIL -->
  <aside id="sidebar" class="sidebar flex flex-col w-20 bg-[#121212] border-r border-white/10 items-center py-6 flex-shrink-0 glass-panel">
      <div class="text-accent mb-8">
          <i data-lucide="sparkle" class="w-10 h-10"></i>
      </div>
      
      <nav class="flex flex-col gap-3 md:gap-6 items-center flex-1">
          <a href="home.html" class="text-gray-500 hover:text-gray-200 p-1.5 md:p-2 hover:bg-white/5 rounded-xl transition" title="Home">
              <i data-lucide="home" class="w-5 h-5 md:w-7 md:h-7"></i>
          </a>

          <a href="#" class="text-accent p-1.5 md:p-2 bg-white/5 rounded-xl transition" title="Games">
              <i data-lucide="gamepad-2" class="w-5 h-5 md:w-7 md:h-7"></i>
          </a>

          <a href="animes_manager.html" class="text-gray-500 hover:text-gray-200 p-1.5 md:p-2 hover:bg-white/5 rounded-xl transition" title="Animes">
              <i data-lucide="tv" class="w-5 h-5 md:w-7 md:h-7"></i>
          </a>

          <a href="cards_manager.html" class="text-gray-500 hover:text-gray-200 p-1.5 md:p-2 hover:bg-white/5 rounded-xl transition" title="Cards">
              <i data-lucide="layers" class="w-5 h-5 md:w-7 md:h-7"></i>
          </a>

          <a href="hqs_manager.html" class="text-gray-500 hover:text-gray-200 p-1.5 md:p-2 hover:bg-white/5 rounded-xl transition" title="HQs">
              <i data-lucide="book-open-text" class="w-5 h-5 md:w-7 md:h-7"></i>
          </a>

          <a href="manga_manager.html" class="text-gray-500 hover:text-gray-200 p-1.5 md:p-2 hover:bg-white/5 rounded-xl transition" title="Mangás">
              <i data-lucide="notebook-text" class="w-5 h-5 md:w-7 md:h-7"></i>
          </a>

          <a href="manhwa_manager.html" class="text-gray-500 hover:text-gray-200 p-1.5 md:p-2 hover:bg-white/5 rounded-xl transition" title="Manhwas">
              <i data-lucide="smartphone" class="w-5 h-5 md:w-7 md:h-7"></i>
          </a>

          <a href="academia_exercicios.html" class="text-gray-500 hover:text-gray-200 p-1.5 md:p-2 hover:bg-white/5 rounded-xl transition" title="Academia">
              <i data-lucide="dumbbell" class="w-5 h-5 md:w-7 md:h-7"></i>
          </a>

          <a href="to_do.html" class="text-gray-500 hover:text-gray-200 p-1.5 md:p-2 hover:bg-white/5 rounded-xl transition" title="To Do">
              <i data-lucide="check-square" class="w-5 h-5 md:w-7 md:h-7"></i>
          </a>
      </nav>

      <button id="logout-btn" class="mt-auto text-red-500 hover:text-red-400 p-1.5 md:p-2 hover:bg-red-500/10 rounded-xl transition" title="Sair">
          <i data-lucide="log-out" class="w-5 h-5 md:w-7 md:h-7"></i>
      </button>
  </aside>

  <!-- CONTEÚDO PRINCIPAL -->
  <main id="main-content" class="main-content flex-1 flex flex-col overflow-hidden relative">
    
    <!-- HEADER -->
    <header class="flex justify-between items-center p-6 md:px-8 bg-transparent z-10 border-b border-white/5">
      <div class="flex items-center gap-3">
          <button id="toggle-sidebar" class="toggle-sidebar-btn p-2 bg-white/5 hover:bg-white/10 rounded-xl text-gray-400 hover:text-accent transition" title="Mostrar/Ocultar Menu">
              <i data-lucide="menu" class="w-5 h-5"></i>
          </button>
          <div>
              <h2 class="text-2xl md:text-3xl font-bold text-white flex items-center gap-3">
                  <i data-lucide="gamepad-2" class="text-accent"></i> My Games
              </h2>
          </div>
      </div>
      <div class="hidden sm:block text-sm text-gray-400 bg-white/5 px-4 py-2 rounded-xl border border-white/5">
          Usuário: <span id="user-id-display" class="text-accent font-mono font-bold">...</span>
      </div>
    </header>

    <!-- ÁREA DE CONTEÚDO -->
    <div id="main-app" class="flex-1 overflow-y-auto p-6 md:px-8 pb-8 hidden">
      <div class="max-w-7xl mx-auto">
        
        <!-- AÇÕES TOPO -->
        <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mb-6">
          <button id="add-item-btn" class="xbox-button w-full sm:w-auto bg-accent text-white px-6 py-2.5 rounded-xl font-bold flex items-center justify-center gap-2">
            <i data-lucide="plus-circle" class="w-5 h-5"></i> Adicionar Game
          </button>

          <button id="search-btn" class="w-full sm:w-auto bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white px-6 py-2.5 rounded-xl border border-white/10 transition-all font-bold text-sm flex items-center justify-center gap-2">
            <i data-lucide="filter" class="w-4 h-4"></i> Mostrar Filtros
          </button>
        </div>

        <!-- PAINEL DE FILTROS -->
        <div id="search-and-sort-container" class="glass-panel p-6 rounded-2xl mb-6 hidden">
          <section class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-xs text-gray-500 mb-2 uppercase font-semibold">Pesquisa</label>
                <input id="search-input" type="text" placeholder="Pesquisar..." class="w-full rounded-xl px-4 py-2.5">
            </div>
            <div>
                <label class="block text-xs text-gray-500 mb-2 uppercase font-semibold">Status</label>
                <select id="status-filter" class="w-full rounded-xl px-4 py-2.5"></select>
            </div>
            <div>
                <label class="block text-xs text-gray-500 mb-2 uppercase font-semibold">Avaliação</label>
                <select id="stars-filter" class="w-full rounded-xl px-4 py-2.5">
                    <option value="">Todas as estrelas</option>
                    <option value="5">5 Estrelas</option>
                    <option value="4">4 Estrelas</option>
                    <option value="3">3 Estrelas</option>
                    <option value="2">2 Estrelas</option>
                    <option value="1">1 Estrela</option>
                </select>
            </div>
            <div>
                <label class="block text-xs text-gray-500 mb-2 uppercase font-semibold">Ordenar por:</label>
                <select id="sort-select" class="w-full rounded-xl px-4 py-2.5 text-sm">
                    <option value="createdAt-desc">Mais Recentes</option>
                    <option value="name-asc">Nome (A-Z)</option>
                    <option value="stars-desc">Melhores Avaliados</option>
                    <option value="hours-desc">Mais Jogados</option>
                </select>
            </div>
          </section>
        </div>

        <!-- CARDS VIEW -->
        <div id="cards-view" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        
        <div id="empty-state" class="text-center py-16 hidden">
            <i data-lucide="ghost" class="w-16 h-16 mx-auto mb-4 opacity-20 text-gray-500"></i>
            <p class="text-lg text-gray-500 font-semibold">Nenhum jogo encontrado.</p>
        </div>

      </div>
    </div>

    <!-- BOTÃO FLUTUANTE (LISTA DE TIMES) -->
    <a href="games_teams.html" class="fixed bottom-24 sm:bottom-8 right-4 sm:right-8 xbox-button bg-accent hover:bg-[#99233b] text-white p-3.5 sm:p-4 rounded-full shadow-[0_0_20px_rgba(185,49,79,0.5)] border border-white/10 z-50 flex items-center justify-center gap-2 group" title="Lista de Times">
          <i data-lucide="gamepad-2" class="w-6 h-6"></i>
          <span class="max-w-0 overflow-hidden whitespace-nowrap group-hover:max-w-xs transition-all duration-300 font-bold text-sm">Lista de Times</span>
      </a>

  </main>

  <!-- MODAL DE ITEM -->
  <div id="item-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50 p-4 overflow-y-auto">
    <div class="glass-panel rounded-2xl w-full max-w-xl p-6 border border-white/10 shadow-2xl relative">
      <div class="flex justify-between items-center mb-6 border-b border-white/5 pb-4">
          <h2 id="modal-title" class="text-xl font-bold text-white flex items-center gap-2">
              <i data-lucide="gamepad-2" class="w-5 h-5 text-accent"></i> Novo Jogo
          </h2>
          <button id="close-modal-btn" class="text-gray-500 hover:text-white transition bg-white/5 p-2 rounded-xl hover:bg-white/10">
              <i data-lucide="x" class="w-5 h-5"></i>
          </button>
      </div>
      
      <form id="item-form" class="space-y-4">
        <input type="hidden" id="item-id">
        
        <div>
          <label class="block text-xs text-gray-500 mb-1.5 uppercase font-semibold">Nome do Jogo</label>
          <input id="item-name" type="text" class="w-full rounded-xl px-4 py-3 text-sm" required placeholder="Ex: Halo Infinite">
        </div>
        
        <div>
          <label class="block text-xs text-gray-500 mb-1.5 uppercase font-semibold">Imagem (URL)</label>
          <input id="item-image" type="url" class="w-full rounded-xl px-4 py-3 text-sm" placeholder="https://...">
        </div>
        
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-xs text-gray-500 mb-1.5 uppercase font-semibold">Estrelas</label>
            <select id="item-stars" class="w-full rounded-xl px-4 py-3 text-sm">
              <option value="0">0 Estrelas</option>
              <option value="1">1 Estrela</option>
              <option value="2">2 Estrelas</option>
              <option value="3">3 Estrelas</option>
              <option value="4">4 Estrelas</option>
              <option value="5">5 Estrelas</option>
            </select>
          </div>
          <div>
            <label class="block text-xs text-gray-500 mb-1.5 uppercase font-semibold">Status</label>
            <select id="item-status" class="w-full rounded-xl px-4 py-3 text-sm"></select>
          </div>
        </div>

        <div class="grid grid-cols-3 gap-3 bg-black/40 p-3 rounded-xl border border-white/10">
            <div>
                <label class="block text-[10px] text-gray-500 mb-1 uppercase font-semibold">Início</label>
                <input id="item-date-start" type="date" class="w-full rounded-lg px-2 py-2 text-xs">
            </div>
            <div>
                <label class="block text-[10px] text-gray-500 mb-1 uppercase font-semibold">Fim</label>
                <input id="item-date-end" type="date" class="w-full rounded-lg px-2 py-2 text-xs">
            </div>
            <div>
                <label class="block text-[10px] text-gray-500 mb-1 uppercase font-semibold">Horas</label>
                <input id="item-count-games" type="number" min="0" class="w-full rounded-lg px-2 py-2 text-xs" placeholder="Ex: 50">
            </div>
        </div>

        <details id="arts_group" class="bg-black/20 p-4 mb-3 shadow-xl rounded-xl border border-white/10 group/details">
            <summary class="cursor-pointer text-accent font-bold list-none flex justify-between items-center select-none">
                <span class="flex items-center gap-2">
                    <i data-lucide="image" class="w-4 h-4"></i> Arts e Prints (<span id="arts_count" class="text-white">0</span>)
                </span>
                <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500 group-open/details:rotate-180 transition-transform"></i>
            </summary>

            <!-- NOVO CAMPO: URL DO ÁLBUM -->
            <div class="mt-4 flex gap-2 items-end border-b border-white/5 pb-4 mb-4">
                <div class="flex-1">
                    <label class="block text-[10px] text-gray-500 mb-1 uppercase font-semibold">URL do Álbum</label>
                    <input id="item-album-url" type="url" class="w-full rounded-xl px-3 py-2 text-sm bg-black/40 border-white/10 text-white focus:border-accent outline-none" placeholder="https://imgur.com/a/...">
                </div>
                <button type="button" id="btn-view-album" class="p-2 rounded-xl bg-blue-500/10 text-blue-400 hover:bg-blue-500 hover:text-white transition-colors h-[38px] flex items-center justify-center" title="Visualizar Álbum">
                    <i data-lucide="eye" class="w-5 h-5"></i>
                </button>
            </div>

            <div class="mt-4 grid grid-cols-1 sm:grid-cols-4 gap-3 bg-white/5 p-3 rounded-xl border border-white/10">
                <select id="art-type" class="w-full rounded-xl px-3 py-2 text-sm bg-black/40 border-white/10 text-white focus:border-accent outline-none">
                    <option value="Art">Art</option>
                    <option value="Print">Print</option>
                </select>

                <input id="art-name" type="text" placeholder="Nome (Opcional)" 
                       class="w-full rounded-xl px-3 py-2 text-sm bg-black/40 border-white/10 text-white focus:border-accent outline-none sm:col-span-3">

                <input id="art-url" type="url" placeholder="URL da Imagem (https://...)" 
                       class="w-full rounded-xl px-3 py-2 text-sm bg-black/40 border-white/10 text-white focus:border-accent outline-none sm:col-span-3">

                <button type="button" id="btn-add-art" class="xbox-button bg-accent hover:bg-[#99233b] text-white rounded-xl px-3 py-2 text-sm font-bold transition-colors shadow-md flex items-center justify-center gap-2">
                    Adicionar
                </button>
            </div>

            <ul id="arts-list" class="mt-4 space-y-2 max-h-48 overflow-y-auto pr-1"></ul>
        </details>

        <div>
          <label class="block text-xs text-gray-500 mb-1.5 uppercase font-semibold">Observações</label>
          <textarea id="item-notes" rows="3" class="w-full rounded-xl px-4 py-3 text-sm resize-none" placeholder="Detalhes da sua jogatina..."></textarea>
        </div>

        <div class="flex items-center gap-3 pt-4 border-t border-white/5 mt-4">
            <button id="delete-item-btn" type="button" class="px-4 py-3 rounded-xl bg-red-500/10 text-red-500 hover:bg-red-500/20 font-bold transition flex items-center justify-center hidden" title="Excluir">
                <i data-lucide="trash-2" class="w-5 h-5"></i>
            </button>
            
            <button type="submit" class="xbox-button flex-1 bg-accent text-white px-4 py-3 rounded-xl font-bold flex items-center justify-center gap-2">
                <i data-lucide="save" class="w-5 h-5"></i> Salvar
            </button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL DE VISUALIZAÇÃO DE IMAGEM -->
  <div id="image-view-modal" class="fixed inset-0 bg-black/90 backdrop-blur-md hidden items-center justify-center z-[60] p-4">
      <div class="relative max-w-4xl w-full flex flex-col items-center">
          <button onclick="document.getElementById('image-view-modal').classList.add('hidden')" 
                  class="absolute -top-12 right-0 bg-white/10 hover:bg-accent text-white p-2 rounded-xl transition-colors">
              <i data-lucide="x" class="w-6 h-6"></i>
          </button>
          <img id="view-modal-img" src="" class="max-h-[80vh] w-auto rounded-xl border border-white/10 shadow-2xl object-contain">
          <p id="view-modal-caption" class="text-white mt-4 text-sm font-semibold glass-panel px-6 py-2 rounded-full border border-white/10"></p>
      </div>
  </div>

  <!-- CAIXA DE MENSAGEM -->
  <div id="message-box" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 p-4 rounded-xl text-white font-bold z-[100] hidden shadow-2xl glass-panel text-sm text-center flex items-center gap-2 transition-opacity"></div>

  <!-- SCRIPT PARA UI DA SIDEBAR E ÍCONES -->
  <script>
      lucide.createIcons();
      
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('main-content');
      const toggleBtn = document.getElementById('toggle-sidebar');
      
      toggleBtn.addEventListener('click', () => {
          sidebar.classList.toggle('hidden');
          mainContent.classList.toggle('sidebar-hidden');
      });
  </script>

  <!-- FIREBASE E LÓGICA -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, query, onSnapshot, addDoc, setDoc, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- CONFIGURAÇÃO FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyDsbiLPBOda119Qr6Ji69j8TZLpiFixBWI",
        authDomain: "list-games-9bddd.firebaseapp.com",
        projectId: "list-games-9bddd",
        storageBucket: "list-games-9bddd.appspot.com",
        messagingSenderId: "756898313156",
        appId: "1:756898313156:web:9bc660d0a2f4cd07882a91",
        measurementId: "G-GLM50YVLXP"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Variáveis
    let userId = null;
    let allGames = [];
    let authChecked = false;
    let currentArts = [];

    // DOM Elements
    const els = {
        loading: document.getElementById('loading-spinner'),
        app: document.getElementById('main-app'),
        cards: document.getElementById('cards-view'),
        empty: document.getElementById('empty-state'),
        msgBox: document.getElementById('message-box'),
        filterCont: document.getElementById('search-and-sort-container'),
        search: document.getElementById('search-input'),
        sort: document.getElementById('sort-select'),
        stars: document.getElementById('stars-filter'),
        status: document.getElementById('status-filter'),
        addBtn: document.getElementById('add-item-btn'),
        searchBtn: document.getElementById('search-btn'),
        authBtn: document.getElementById('logout-btn'), // Atualizado ID
        modal: document.getElementById('item-modal'),
        closeModal: document.getElementById('close-modal-btn'),
        form: document.getElementById('item-form'),
        modalTitle: document.getElementById('modal-title'),
        deleteBtn: document.getElementById('delete-item-btn'),
        userIdDisp: document.getElementById('user-id-display'),
        inputs: {
            id: document.getElementById('item-id'),
            name: document.getElementById('item-name'),
            image: document.getElementById('item-image'),
            stars: document.getElementById('item-stars'),
            start: document.getElementById('item-date-start'),
            end: document.getElementById('item-date-end'),
            hours: document.getElementById('item-count-games'),
            status: document.getElementById('item-status'),
            notes: document.getElementById('item-notes')
        }
    };

    const statusOptions = [
        { value: "Não Jogou", text: "Não Jogou" },
        { value: "Jogando", text: "Jogando" },
        { value: "Zerado", text: "Zerado" },
        { value: "Dropei", text: "Dropei" },
        { value: "Jogado", text: "Jogado" },
        { value: "Não Lançado", text: "Não Lançado" }
    ];

    // Helpers
    const toggleLoading = (show) => {
        if(show) { els.loading.classList.remove('hidden'); els.app.classList.add('hidden'); }
        else { els.loading.classList.add('hidden'); els.app.classList.remove('hidden'); }
    };

    const showMsg = (txt, isErr = false) => {
        els.msgBox.innerHTML = `<i data-lucide="${isErr ? 'alert-circle' : 'check-circle'}" class="w-5 h-5"></i> ${txt}`;
        els.msgBox.className = `fixed bottom-6 left-1/2 transform -translate-x-1/2 p-4 rounded-xl text-white font-bold z-[100] shadow-2xl glass-panel text-sm text-center flex items-center gap-2 transition-opacity ${isErr ? 'border border-red-500 bg-red-500/20 text-red-100' : 'border border-green-500 bg-green-500/20 text-green-100'}`;
        els.msgBox.classList.remove('hidden');
        lucide.createIcons();
        setTimeout(() => els.msgBox.classList.add('hidden'), 3000);
    };

    const formatDate = (d) => {
        if (!d) return '--/--';
        if (typeof d === 'string' && d.includes('-')) {
            const [y,m,day] = d.split('-'); return `${day}/${m}/${y.slice(2)}`;
        }
        return d;
    };

    // --- RENDERIZAÇÃO DOS CARDS ESTILO XBOX ---
    const renderCard = (item) => {
        const hours = (item.hours || 0) + 'h';
        const stars = parseInt(item.stars) || 0;
        
        let statusColor = 'bg-white/5 border-white/10 text-gray-300';
        if(item.status === 'Zerado') statusColor = 'bg-green-500/20 border-green-500/30 text-green-400';
        else if(item.status === 'Jogando') statusColor = 'bg-blue-500/20 border-blue-500/30 text-blue-400';
        else if(item.status === 'Dropei') statusColor = 'bg-red-500/20 border-red-500/30 text-red-400';

        return `
        <div data-id="${item.id}" class="task-card rounded-2xl overflow-hidden cursor-pointer relative flex flex-col group">
            
            <div class="relative w-full h-48 bg-gray-900 flex-shrink-0">
                <img src="${item.image || ''}" 
                     class="w-full h-full object-cover"
                     onerror="this.src='https://placehold.co/600x400/151515/333?text=Sem+Imagem'">
                
                <span class="absolute top-3 right-3 text-[10px] uppercase font-bold px-2.5 py-1 rounded-lg backdrop-blur-md border shadow-lg ${statusColor}">
                    ${item.status || 'Status?'}
                </span>
            </div>

            <div class="p-5 flex flex-col gap-3 flex-1 justify-between">
                <div>
                    <h3 class="text-lg font-bold text-white leading-tight truncate" title="${item.name}">${item.name}</h3>
                    <div class="text-yellow-500 text-sm mt-1 tracking-widest">
                        ${'★'.repeat(stars)}${'<span class="opacity-30">★</span>'.repeat(5-stars)}
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-2 pt-3 border-t border-white/5 text-xs">
                    <div class="flex flex-col">
                        <span class="text-gray-500 uppercase text-[10px] font-semibold mb-1">Início</span>
                        <span class="text-gray-300 font-mono">${formatDate(item.dateStart)}</span>
                    </div>
                     <div class="flex flex-col text-center border-l border-r border-white/5">
                        <span class="text-gray-500 uppercase text-[10px] font-semibold mb-1">Horas</span>
                        <span class="text-accent font-mono font-bold">${hours}</span>
                    </div>
                    <div class="flex flex-col text-right">
                        <span class="text-gray-500 uppercase text-[10px] font-semibold mb-1">Fim</span>
                        <span class="text-gray-300 font-mono">${formatDate(item.dateEnd)}</span>
                    </div>
                </div>
            </div>
        </div>
        `;
    };

    const filterSortRender = () => {
        let list = [...allGames];
        const sTxt = els.search.value.toLowerCase();
        const sStatus = els.status.value;
        const sStars = els.stars.value;
        const sSort = els.sort.value;

        list = list.filter(i => {
            return (i.name||'').toLowerCase().includes(sTxt) &&
                   (!sStatus || i.status === sStatus) &&
                   (!sStars || (i.stars||0) == sStars);
        });

        list.sort((a,b) => {
            switch(sSort) {
                case 'name-asc': return (a.name||'').localeCompare(b.name||'');
                case 'stars-desc': return (b.stars||0) - (a.stars||0);
                case 'hours-desc': return (b.hours||0) - (a.hours||0);
                default: return (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0);
            }
        });

        els.cards.innerHTML = list.map(renderCard).join('');
        if(list.length === 0) els.empty.classList.remove('hidden');
        else els.empty.classList.add('hidden');
    };

    // --- Ações ---
    const openModal = (id = null) => {
        els.form.reset();
        els.inputs.id.value = '';
        els.deleteBtn.classList.add('hidden');
        els.modalTitle.innerHTML = id ? '<i data-lucide="edit-3" class="w-5 h-5 text-accent"></i> Editar Jogo' : '<i data-lucide="gamepad-2" class="w-5 h-5 text-accent"></i> Novo Jogo';
        lucide.createIcons();

        // Resetar lista de Arts
        currentArts = [];
        renderArtsList(); 

        els.inputs.id.value = '';
        document.getElementById('item-album-url').value = ''; // Limpa o campo de álbum

        if(id) {
            const item = allGames.find(i => i.id === id);
            if(item) {
                els.inputs.id.value = item.id;
                els.inputs.name.value = item.name || '';
                els.inputs.image.value = item.image || '';
                els.inputs.stars.value = item.stars || '0';
                els.inputs.start.value = item.dateStart || '';
                els.inputs.end.value = item.dateEnd || '';
                els.inputs.hours.value = item.hours || '';
                els.inputs.status.value = item.status || '';
                els.inputs.notes.value = item.notes || '';

                document.getElementById('item-album-url').value = item.albumUrl || '';
                
                if (item.arts && Array.isArray(item.arts)) {
                    currentArts = [...item.arts];
                    renderArtsList();
                }

                els.deleteBtn.classList.remove('hidden');
            }
        }
        els.modal.classList.remove('hidden');
        els.modal.classList.add('flex');
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if(!userId) return;

        const id = els.inputs.id.value;
        const d = {
            name: els.inputs.name.value.trim(),
            image: els.inputs.image.value.trim(),
            stars: parseInt(els.inputs.stars.value) || 0,
            dateStart: els.inputs.start.value,
            dateEnd: els.inputs.end.value,
            hours: parseInt(els.inputs.hours.value) || 0,
            status: els.inputs.status.value,
            notes: els.inputs.notes.value,
            albumUrl: document.getElementById('item-album-url').value.trim(),
            arts: currentArts, 
            updatedAt: serverTimestamp()
        };

        try {
            if(id) {
                await setDoc(doc(db, 'users', userId, 'games', id), d, { merge: true });
                showMsg('Atualizado com sucesso!');
            } else {
                d.createdAt = serverTimestamp();
                await addDoc(collection(db, 'users', userId, 'games'), d);
                showMsg('Criado com sucesso!');
            }
            els.modal.classList.add('hidden');
        } catch(err) { console.error(err); showMsg('Erro ao salvar', true); }
    };

    const handleDelete = async () => {
        const id = els.inputs.id.value;
        if(!id || !userId) return;
        try {
            await deleteDoc(doc(db, 'users', userId, 'games', id));
            showMsg('Excluído!');
            els.modal.classList.add('hidden');
        } catch(err) { showMsg('Erro ao excluir', true); }
    };

    // --- FUNÇÕES DE ARTS E PRINTS ---
    const renderArtsList = () => {
        const listEl = document.getElementById('arts-list');
        const countEl = document.getElementById('arts_count');
        
        listEl.innerHTML = '';
        countEl.textContent = currentArts.length;

        currentArts.forEach((art, index) => {
            const li = document.createElement('li');
            li.className = "flex items-center justify-between bg-white/5 p-2.5 rounded-xl border border-white/10 hover:border-white/20 transition-colors";
            
            li.innerHTML = `
                <div class="flex items-center gap-3 overflow-hidden">
                    <span class="text-[10px] font-bold uppercase px-2 py-1 rounded-lg bg-black/40 text-gray-400 border border-white/10 min-w-[50px] text-center">
                        ${art.type}
                    </span>
                    <span class="text-sm text-gray-200 truncate font-medium" title="${art.name || 'Sem nome'}">
                        ${art.name || art.url}
                    </span>
                </div>
                <div class="flex gap-2 shrink-0 ml-2">
                    <button type="button" class="btn-view-art p-2 rounded-lg bg-blue-500/10 text-blue-400 hover:bg-blue-500 hover:text-white transition-colors" data-idx="${index}" title="Visualizar">
                        <i data-lucide="eye" class="w-4 h-4"></i>
                    </button>
                    <button type="button" class="btn-edit-art p-2 rounded-lg bg-yellow-500/10 text-yellow-400 hover:bg-yellow-500 hover:text-white transition-colors" data-idx="${index}" title="Editar">
                        <i data-lucide="edit-2" class="w-4 h-4"></i>
                    </button>
                    <button type="button" class="btn-delete-art p-2 rounded-lg bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white transition-colors" data-idx="${index}" title="Excluir">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
            listEl.appendChild(li);
        });

        lucide.createIcons();

        document.querySelectorAll('.btn-view-art').forEach(btn => 
            btn.onclick = (e) => viewArt(e.currentTarget.dataset.idx));
        
        document.querySelectorAll('.btn-delete-art').forEach(btn => 
            btn.onclick = (e) => deleteArt(e.currentTarget.dataset.idx));
            
        document.querySelectorAll('.btn-edit-art').forEach(btn => 
            btn.onclick = (e) => editArt(e.currentTarget.dataset.idx));
    };

    const addArt = () => {
        const typeEl = document.getElementById('art-type');
        const nameEl = document.getElementById('art-name');
        const urlEl = document.getElementById('art-url');

        if (!urlEl.value.trim()) {
            showMsg('Insira a URL da imagem!', true);
            return;
        }

        currentArts.push({
            type: typeEl.value,
            name: nameEl.value.trim(),
            url: urlEl.value.trim()
        });

        nameEl.value = '';
        urlEl.value = '';
        typeEl.value = 'Art';
        
        renderArtsList();
    };

    const deleteArt = (index) => {
        currentArts.splice(index, 1);
        renderArtsList();
    };

    const editArt = (index) => {
        const item = currentArts[index];
        document.getElementById('art-type').value = item.type;
        document.getElementById('art-name').value = item.name;
        document.getElementById('art-url').value = item.url;
        
        deleteArt(index);
        document.getElementById('art-url').focus(); 
    };

    const viewArt = (index) => {
        const item = currentArts[index];
        const viewModal = document.getElementById('image-view-modal');
        const imgEl = document.getElementById('view-modal-img');
        const captionEl = document.getElementById('view-modal-caption');

        imgEl.src = item.url;
        captionEl.textContent = item.name || item.type;
        captionEl.classList.toggle('hidden', !item.name);

        viewModal.classList.remove('hidden');
        viewModal.classList.add('flex');
    };

    const setupEvents = () => {
        els.addBtn.onclick = () => openModal();
        
        els.searchBtn.onclick = () => {
            const isHidden = els.filterCont.classList.toggle('hidden');
            if (isHidden) {
                els.searchBtn.innerHTML = '<i data-lucide="filter" class="w-4 h-4"></i> Mostrar Filtros';
            } else {
                els.searchBtn.innerHTML = '<i data-lucide="x" class="w-4 h-4"></i> Esconder Filtros';
            }
            lucide.createIcons();
        };

        els.closeModal.onclick = () => els.modal.classList.add('hidden');
        els.form.onsubmit = handleSubmit;
        els.deleteBtn.onclick = handleDelete;
        els.authBtn.onclick = () => signOut(auth);

        document.getElementById('btn-add-art').onclick = addArt;

        document.getElementById('btn-view-album').onclick = () => {
            const url = document.getElementById('item-album-url').value.trim();
            if(url) {
                window.open(url, '_blank');
            } else {
                showMsg('Insira uma URL de álbum primeiro!', true);
            }
        };

        els.cards.onclick = (e) => {
            const c = e.target.closest('.task-card');
            if(c) openModal(c.dataset.id);
        };

        [els.search, els.sort, els.stars, els.status].forEach(i => i.oninput = filterSortRender);

        const fill = (sel) => statusOptions.forEach(o => sel.innerHTML += `<option value="${o.value}">${o.text}</option>`);
        els.inputs.status.innerHTML = '<option value="">Selecione...</option>';
        els.status.innerHTML = '<option value="">Todos os Status</option>';
        fill(els.inputs.status);
        fill(els.status);
    };

    // --- Init ---
    onAuthStateChanged(auth, (u) => {
        if(u) {
            userId = u.uid;
            els.userIdDisp.textContent = u.email || u.uid;
            const q = query(collection(db, 'users', userId, 'games'));
            onSnapshot(q, (snap) => {
                allGames = [];
                snap.forEach(d => allGames.push({ id:d.id, ...d.data() }));
                filterSortRender();
                toggleLoading(false);
            });
        } else {
            userId = null;
            if(authChecked) window.location.href = 'index.html';
        }
        authChecked = true;
    });

    window.onload = () => {
        setupEvents();
        toggleLoading(true);
    };
  </script>
</body>
</html>
