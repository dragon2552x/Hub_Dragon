<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Class Animes</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    body {
      background: #0b0b0b;
      font-family: Inter, system-ui, sans-serif;
      color: #e6e6e6;
      padding-bottom: 100px; /* espa√ßo para menu inferior */
    }

    .menu {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #151515;
      border-top: 1px solid #2a2a2a;
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
    }

    .menu-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #b3b3b3;
      font-size: 0.75rem;
      transition: all 0.2s;
    }

    .menu-btn:hover,
    .menu-btn.active {
      color: #B9314F;
    }

    .menu-btn svg {
      width: 22px;
      height: 22px;
      margin-bottom: 4px;
    }

    /* --- Estilos do Menu Inferior (Navega√ß√£o) --- */
        .header-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #151515;
            border-bottom: 1px solid #2a2a2a;
            padding: 10px 20px;
            z-index: 10;
        }


        .menu-btn i {
            margin-bottom: 4px;
        }
        
        /* --- Estilos do Dropdown de Mais Op√ß√µes --- */
        .dropdown-item {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 8px 10px;
            color: #e6e6e6;
            font-size: 0.875rem; /* text-sm */
            border-radius: 6px; /* rounded-lg */
            transition: background-color 0.2s;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
        }

        .dropdown-item:hover {
            background-color: #2a2a2a;
        }

        /* --- Estilos do Dropdown de Filtro Customizado (VISUAL MELHORADO) --- */
        .filter-dropdownMenu {
            position: absolute;
            top: 100%;
            left: 0;
            z-index: 20;
            width: 100%;
            background: #1f1f1f;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 4px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        .filter-option {
            /* Estilos para parecer um item de lista clic√°vel */
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.15s;
            
            /* Adicionando estilos para √≠cones e alinhamento */
            display: flex;
            align-items: center;
            gap: 10px; /* Espa√ßamento entre √≠cone e texto */
            
            /* Para usar como <button> e parecer um item de lista */
            width: 100%; 
            text-align: left; 
            background: none;
            border: none;
            color: inherit; /* Garante que o texto herde a cor do body/pai */
            font-size: 1rem; /* Tamanho da fonte padr√£o */
        }

        .filter-option:hover {
            background-color: #2a2a2a;
        }

        .filter-option.selected {
            background-color: #B9314F;
            color: #ffffff;
        }

        /* --- Estilos do Card de Anime --- */
        .anime-card {
            background: #151515;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .anime-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(185, 49, 79, 0.2);
        }

        .card-image {
            width: 100%;
            padding-top: 150%; /* 3:2 Aspect Ratio */
            position: relative;
        }

        .card-image img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .modal-top {
            z-index: 99999 !important;
        }
  </style>
</head>
<body>

<div id="app" class="container mx-auto max-w-6xl px-4 pt-4">

  <!-- MENU SUPERIOR -->
  <header class="bg-[#1f1f1f] p-2 mb-3 shadow-xl rounded-xl border border-[#2a2a2a]">
    
    <!-- Linha 1 -->
    <div class="flex justify-between items-center">
      <button onclick="window.location.href='home.html'"
              class="text-2xl font-bold text-[#B9314F] hover:text-[#992743] transition-colors duration-200">
        My Hub
      </button>

      <h1 class="text-2xl font-bold text-white">My Animes</h1>
    </div>

    <!-- Linha 2 -->
    <div class="text-sm text-gray-300 mt-1">
      Usu√°rio: <span id="user-email" class="text-[#B9314F] font-mono">Carregando...</span>
    </div>

  </header>

  <!-- CONTE√öDO PRINCIPAL DA P√ÅGINA -->
    <main class="container mx-auto p-4 pt-6">

        <!-- Removido: <h2 class="text-3xl font-extrabold mb-6 text-white">Minha Lista de Animes</h2> -->

        <!-- NOVO DROPDOWN DE VISUALIZA√á√ÉO (Filtros) - Ajustado para w-full (responsivo) -->
        <div class="relative w-full mb-6">
            <button id="dropdown-toggle"
                    class="w-full flex justify-between items-center px-4 py-2 bg-[#1f1f1f] text-white
                           border border-[#333] rounded-lg shadow-md hover:bg-[#2a2a2a] transition-colors"
                    onclick="toggleFilterDropdown()">
                <span id="selected-filter-text">Todos</span>
                <i data-lucide="chevron-down" class="w-5 h-5 transition-transform duration-200"></i>
            </button>

            <div id="dropdownMenu" class="filter-dropdownMenu hidden">
                <div class="filter-option selected" onclick="selecionarOpcaoMenu('inacabados', this)">
                    Todos inacabados
                </div>
                <div class="filter-option" onclick="selecionarOpcaoMenu('temporada', this)">
                    Temporada Atual
                </div>
                <div class="filter-option" onclick="selecionarOpcaoMenu('ult_temporada', this)">
                    √öltima Temporada
                </div>
                <div class="filter-option" onclick="selecionarOpcaoMenu('andamento', this)">
                    Andamento
                </div>
                <div class="filter-option" onclick="selecionarOpcaoMenu('selecionar_anime', this)">
                    Selecionar Anime
                </div>
                <div class="filter-option" onclick="selecionarOpcaoMenu('selecionar_temporada', this)">
                    Selecionar Temporada
                </div>
            </div>
        </div>
        
        <!-- CARREGAMENTO/ERRO -->
        <div id="loading-indicator" class="text-center p-10 hidden">
            <i data-lucide="loader-2" class="w-8 h-8 mx-auto animate-spin text-[#B9314F]"></i>
            <p class="mt-2 text-sm text-gray-400">Carregando animes...</p>
        </div>
        <div id="error-message" class="text-center p-10 hidden bg-red-900/20 border border-red-700/50 rounded-lg">
            <p class="text-red-400 text-sm">Ocorreu um erro ao carregar os dados. Verifique sua conex√£o.</p>
        </div>
        
        <!-- GRID DE CARDS -->
        <div id="anime-list-grid" class="grid grid-cols-2 gap-4 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5">
            <!-- Cards de animes ser√£o injetados aqui -->
        </div>
    </main>
</div>


<!-- MODAL DE ANIME -->
<div id="anime-modal" class="fixed inset-0 bg-black/90 hidden z-50 flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm transition-all">
    <div class="bg-[#151515] w-full max-w-lg sm:rounded-xl border-t sm:border border-[#2a2a2a] shadow-2xl overflow-hidden max-h-[90vh] flex flex-col animate-in slide-in-from-bottom-10 duration-300">
        
        <div class="relative h-32 bg-[#111] shrink-0">
            <img id="modal-bg-blur" src="" class="absolute inset-0 w-full h-full object-cover opacity-30 blur-md">
            <div class="absolute inset-0 bg-gradient-to-t from-[#151515] to-transparent"></div>
            
            <button onclick="fecharModalAnime()" 
                class="absolute top-4 right-4 z-[60] w-9 h-9 flex items-center justify-center bg-black/60 text-white rounded-full hover:bg-[#B9314F] hover:scale-110 active:scale-95 transition-all shadow-lg border border-white/10"
                aria-label="Fechar Modal">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>

            <div class="absolute -bottom-4 left-5 flex items-end gap-4 z-10 w-full pr-5">
                <img id="modal-imagem" src="" class="w-24 h-32 object-cover rounded-lg border-2 border-[#2a2a2a] shadow-lg bg-[#111]">
                <div class="pb-6 flex-1 min-w-0">
                    <h2 id="modal-nome" class="text-lg sm:text-xl font-bold text-white truncate leading-tight drop-shadow-md">
                        Nome do Anime
                    </h2>
                    
                    <div class="flex flex-wrap items-center gap-x-3 gap-y-2 mt-1.5">
                        
                        <span id="modal-tag-estilo" class="text-[9px] uppercase font-black px-1.5 py-0.5 rounded bg-[#B9314F] text-white tracking-tighter">
                            Anime
                        </span>

                        <div class="flex items-center gap-2 text-[11px] text-gray-400 font-medium">
                            <span id="modal-ano" class="font-mono">2024</span>
                            <span class="text-[#2a2a2a]">|</span>
                            <div class="flex items-center gap-1">
                                <i data-lucide="play-circle" class="w-3 h-3 text-gray-500"></i>
                                <span id="modal-epsa" class="text-gray-200">0</span>
                                <span class="text-gray-600">/</span>
                                <span id="modal-epst">0</span>
                            </div>
                        </div>

                        <div class="flex items-center gap-1.5 bg-white/5 px-2 py-0.5 rounded-md border border-white/10">
                            <span class="text-[9px] text-gray-500 font-bold uppercase tracking-widest">Nota F.</span>
                            <span id="modal-tag-nota-f" class="text-xs font-black text-[#B9314F]">0.00</span>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>

        <div class="p-5 pt-8 overflow-y-auto custom-scroll flex-1">
            
            <div class="grid grid-cols-3 gap-3 mb-6">
                <div>
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1 tracking-wider">Estado</label>
                    <select id="modal-estado" class="w-full bg-[#0a0a0a] border border-[#333] text-gray-200 text-xs rounded p-2 focus:border-[#B9314F] outline-none transition-colors" placeholder="0-5">
                        <option value="Completo">Completo</option>
                        <option value="Andamento">Andamento</option>
                        <option value="Incompleto">Incompleto</option>
                        <option value="Assistido">Assistido</option>
                        <option value="Desist√™ncia">Desist√™ncia</option>
                        <option value="N. Come√ßado">N. Come√ßado</option>
                        <option value="N. Assistido">N. Assistido</option>
                        <option value="N. Lan√ßado">N. Lan√ßado</option>
                        <option value="N. Sei">N. Sei</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1 tracking-wider">Nota MAL</label>
                    <div class="relative">
                        <input id="modal-mal" type="number" step="0.01" 
                            class="w-full bg-[#0a0a0a] border border-[#333] text-gray-200 text-xs rounded p-2 pl-2 pr-9 focus:border-[#B9314F] outline-none transition-colors" 
                            placeholder="0.0">
                        
                        <button type="button" onclick="pegarDoMAL()" 
                            class="absolute right-1 top-1 bottom-1 px-2 bg-blue-600 hover:bg-blue-500 text-white rounded flex items-center justify-center transition-colors shadow-sm">
                            <i data-lucide="search" class="w-3.5 h-3.5"></i>
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1 tracking-wider">Stars</label>
                    <div class="relative">
                        <select id="modal-stars" type="number" step="0.5" max="5" class="w-full bg-[#0a0a0a] border border-[#333] text-gray-200 text-xs rounded p-2 focus:border-[#B9314F] outline-none transition-colors" placeholder="0-5">
                            <option value="">-</option>
                            <option value="‚ú∂">ü•á R1</option>
                            <option value="‚ú∂ ‚ú∂">ü•à R2</option>
                            <option value="‚ú∂ ‚ú∂ ‚ú∂">ü•â R3</option>
                            <option value="5">5 ‚≠ê</option>
                            <option value="4">4 ‚≠ê</option>
                            <option value="3">3 ‚≠ê</option>
                            <option value="2">2 ‚≠ê</option>
                            <option value="1">1 ‚≠ê</option>
                            <option value="0">0 ‚≠ê</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="h-[1px] bg-[#2a2a2a] w-full mb-5"></div>

            <div id="notas_content">
                </div>

        </div>

        <div class="p-4 bg-[#111] border-t border-[#2a2a2a] flex gap-3">
            <button id="btn-mais-um-ep" class="flex-1 bg-[#222] hover:bg-[#333] text-white border border-[#333] py-3 rounded-lg flex items-center justify-center gap-2 transition group">
                <div class="bg-[#B9314F] rounded-full p-1 group-hover:scale-110 transition">
                    <i data-lucide="plus" class="w-3 h-3 text-white"></i>
                </div>
                <div class="text-left leading-none">
                    <span class="block text-[10px] text-gray-400 font-bold uppercase">Progresso</span>
                    <span class="text-sm font-bold">+1 Epis√≥dio</span>
                </div>
            </button>

            <button id="btn-salvar-tudo" class="flex-[2] bg-[#B9314F] hover:bg-[#a02641] text-white font-bold py-3 rounded-lg shadow-lg shadow-red-900/20 transition flex items-center justify-center gap-2">
                <i data-lucide="save" class="w-4 h-4"></i>
                <span>Salvar Altera√ß√µes</span>
            </button>
        </div>
    </div>
</div>

<!-- MODAL DE PESQUISA -->
<div id="modal-selecao" class="fixed inset-0 bg-black/90 z-[100] hidden flex items-center justify-center p-4">
    <div class="bg-[#151515] w-full max-w-md rounded-2xl border border-[#333] flex flex-col max-h-[80vh]">
        <div class="p-4 border-b border-[#333] flex justify-between items-center">
            <h3 id="titulo-modal-selecao" class="text-lg font-bold">Selecionar</h3>
            <button onclick="fecharModalSelecao()" class="text-gray-400"><i data-lucide="x"></i></button>
        </div>
        
        <div class="p-4">
            <input type="text" id="input-busca-selecao" placeholder="Buscar..." 
                   class="w-full bg-[#0b0b0b] border border-[#333] rounded-lg px-4 py-2 text-white focus:outline-none focus:border-[#B9314F]">
        </div>

        <div id="lista-selecao" class="overflow-y-auto p-2 space-y-1">
            </div>
    </div>
</div>


<!-- MENU INFERIOR -->
<nav class="menu fixed bottom-0 left-0 w-full bg-[#151515] border-t border-[#2a2a2a] flex justify-around py-2 z-40">
    
    <button class="menu-btn" onclick="window.location.href='animes_manager.html'">
        <i data-lucide="home" class="w-6 h-6 mb-1"></i>
        <span class="text-[10px]">In√≠cio</span>
    </button>

    <button class="menu-btn" onclick="window.location.href='animes_cadastro.html'">
        <i data-lucide="file-edit" class="w-6 h-6 mb-1"></i>
        <span class="text-[10px]">Gest√£o</span>
    </button>

    <button class="menu-btn active" onclick="window.location.href='anime_lista.html'">
        <i data-lucide="list" class="w-6 h-6 mb-1"></i>
        <span class="text-[10px]">Lista</span>
    </button>

    <div class="relative flex">
        <button id="more-options-btn" class="menu-btn" onclick="toggleMoreOptions(event)">
            <i data-lucide="more-horizontal" class="w-6 h-6 mb-1"></i>
            <span class="text-[10px]">Mais</span>
        </button>

        <div id="more-options-dropdown"
             class="absolute bottom-full mb-3 right-0 w-48 bg-[#1f1f1f] border border-[#333] rounded-xl shadow-2xl p-1 hidden z-50 flex flex-col">

            <button class="w-full text-left px-4 py-3 text-sm text-gray-300 hover:bg-[#2a2a2a] hover:text-white rounded-lg transition-colors flex items-center gap-3" 
                    onclick="window.location.href='animes_classificacoes.html'">
                <i data-lucide="bar-chart-2" class="w-4 h-4 text-[#B9314F]"></i> 
                <span>Classifica√ß√£o</span>
            </button>
            
            <button class="w-full text-left px-4 py-3 text-sm text-gray-300 hover:bg-[#2a2a2a] hover:text-white rounded-lg transition-colors flex items-center gap-3" 
                    onclick="window.location.href='animes_estrelas.html'">
                <i data-lucide="trophy" class="w-4 h-4 text-[#B9314F]"></i> 
                <span>Estrelas</span>
            </button>
            
            <button class="w-full text-left px-4 py-3 text-sm text-gray-300 hover:bg-[#2a2a2a] hover:text-white rounded-lg transition-colors flex items-center gap-3" 
                    onclick="window.location.href='animes_torneio.html'">
                <i data-lucide="trophy" class="w-4 h-4 text-[#B9314F]"></i> 
                <span>Torneio</span>
            </button>

            <button class="w-full text-left px-4 py-3 text-sm text-gray-300 hover:bg-[#2a2a2a] hover:text-white rounded-lg transition-colors flex items-center gap-3" 
                    onclick="window.location.href='animes_serie.html'">
                <i data-lucide="layers" class="w-4 h-4 text-[#B9314F]"></i> 
                <span>Serie</span>
            </button>
        </div>
    </div>
</nav>

<script>
  lucide.createIcons();
  function abrirPagina(pagina) {
    window.location.href = pagina;
  }
</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, query, where, updateDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- CONFIGURA√á√ÉO FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyDsbiLPBOda119Qr6Ji69j8TZLpiFixBWI",
        authDomain: "list-games-9bddd.firebaseapp.com",
        projectId: "list-games-9bddd",
        storageBucket: "list-games-9bddd.firebasestorage.app",
        messagingSenderId: "756898313156",
        appId: "1:756898313156:web:9bc660d0a2f4cd07882a91",
        measurementId: "G-GLM50YVLXP"
    };

    const firebaseApp = initializeApp(firebaseConfig);
    const auth = getAuth(firebaseApp);
    const db = getFirestore(firebaseApp);

    // --- VARI√ÅVEIS GLOBAIS ---
    window.animeCache = [];
    window._notasAnime = { ep1: "", eps: [], epf: "" }; // Estado tempor√°rio das notas

    // --- 1. CARREGAMENTO DE DADOS ---
    async function carregarAnimesParaCache() {
        const user = auth.currentUser;
        if (!user) return [];

        try {
            const ref = collection(db, "users", user.uid, "animes");
            const snapshot = await getDocs(ref);
            // Mapeia doc.id para facilitar updates futuros
            const dados = snapshot.docs.map(d => ({ firestoreId: d.id, ...d.data() }));
            
            window.animeCache = dados;
            localStorage.setItem(`animes_${user.uid}`, JSON.stringify(dados));
            return dados;
        } catch (e) {
            console.error("Erro ao carregar do Firebase:", e);
            return [];
        }
    }

    async function loadAnimeList(filtro = "inacabados") {        
        const user = auth.currentUser;
        if (!user) return;

        // Recupera√ß√£o Inteligente (Mem√≥ria > LocalStorage > Firebase)
        if (!window.animeCache || window.animeCache.length === 0) {
            const cachedData = localStorage.getItem(`animes_${user.uid}`);
            if (cachedData) {
                window.animeCache = JSON.parse(cachedData);
            } else {
                await carregarAnimesParaCache();
            }
        }

        let lista = [...window.animeCache];

        // Filtros
        if (filtro === "andamento") {
            lista = lista.filter(a => a.ESTADO === "Andamento");
        } else if (filtro === "inacabados") {
            lista = lista.filter(a => !["Completo", "Assistido", "Desist√™ncia"].includes(a.ESTADO));
        } else if (filtro === "temporada" || filtro === "ult_temporada") {
            let anoAlvo = new Date().getFullYear();
            let tempAlvo = getTemporadaAtual();

            if (filtro === "ult_temporada") {
                if (tempAlvo === 1) { tempAlvo = 10; anoAlvo--; }
                else tempAlvo -= 3;
            }

            lista = lista.filter(anime => {
                const t = (anime.TEMPORADA || "").toLowerCase();
                const a = Number(anime.ANO);
                if (!t || a !== anoAlvo || t.includes("outra")) return false;
                return t.includes(`(${tempAlvo})`);
            });
        } else {
            lista = lista.filter(a => (a.ESTADO || "").toLowerCase() === String(filtro).toLowerCase());
        }

        // Ordena√ß√£o por N√∫mero (assumindo campo N ou Num)
        lista.sort((a, b) => (Number(a.N) || 0) - (Number(b.N) || 0));

        renderAnimeCards(lista);
    }
    window.loadAnimeList = loadAnimeList;

    function getTemporadaAtual() {
        const mes = new Date().getMonth() + 1;
        if (mes <= 3) return 1;
        if (mes <= 6) return 4;
        if (mes <= 9) return 7;
        return 10;
    }

    // --- 2. RENDERIZA√á√ÉO DA LISTA ---
    function renderAnimeCards(lista) {        
        const grid = document.getElementById("anime-list-grid");
        if (!grid) return;
        grid.innerHTML = "";

        if (lista.length === 0) {
            grid.innerHTML = `<div class="col-span-full text-center text-gray-500 py-10">Nenhum anime encontrado.</div>`;
            return;
        }
        
        lista.forEach(anime => {            
            const div = document.createElement("div");
            div.className = "anime-card cursor-pointer bg-[#151515] rounded-lg overflow-hidden shadow-md border border-[#2a2a2a] hover:border-[#B9314F] transition-all";
            div.innerHTML = `
                <div class="w-full h-40 bg-[#111] relative">
                    <img src="${anime.IMAGEM || ''}" class="w-full h-full object-cover" onerror="this.style.display='none'">
                    <div class="absolute bottom-0 left-0 bg-black/70 px-2 py-1 text-[10px] text-white font-bold rounded-tr-lg">
                        ${anime.ASSIS || 0}/${anime.TOTAIS || '?'}
                    </div>
                </div>
                <div class="p-3">
                    <h3 class="font-bold text-sm text-white truncate mb-1">${anime.NOME}</h3>
                    <p class="text-xs text-gray-400">${anime.ESTILO || "Anime"} ‚Ä¢ ${anime.ANO || "?"}</p>
                    <span class="inline-block mt-2 text-[10px] px-2 py-0.5 rounded bg-[#222] text-gray-300 border border-[#333]">${anime.ESTADO}</span>
                </div>
            `;
            div.onclick = () => abrirModalAnime(anime.NOME);
            grid.appendChild(div);
        });
    }

    // --- 3. MODAL DE EDI√á√ÉO (L√≥gica Principal) ---
    function abrirModalAnime(nome) {
        const anime = window.animeCache.find(a => a.NOME === nome);
        if (!anime) return console.error("Anime n√£o encontrado:", nome);

        const ref = doc(db, "users", auth.currentUser.uid, "animes", nome);

        const modal = document.getElementById("anime-modal");
        modal.classList.remove("hidden");

        // 1. Preenche Topo (Capa e Infos)
        document.getElementById("modal-nome").textContent = anime.NOME;
        document.getElementById("modal-imagem").src = anime.IMAGEM || "https://placehold.co/150x200/111/333?text=?";
        document.getElementById("modal-bg-blur").src = anime.IMAGEM || ""; // Fundo desfocado
        document.getElementById("modal-tag-estilo").textContent = anime.ESTILO || "Anime";
        document.getElementById("modal-ano").textContent = anime.ANO || "????";
        document.getElementById("modal-epsa").textContent = anime.ASSIS || "0";
        document.getElementById("modal-epst").textContent = anime.TOTAIS || "0";

        document.getElementById("modal-tag-nota-f").textContent = 
            (anime.NOTA_F !== undefined && anime.NOTA_F !== null && anime.NOTA_F !== '')
            ? anime.NOTA_F.toFixed(2)
            : "";
        
        // 2. Preenche Edi√ß√£o B√°sica (Estado, MAL, Stars)
        // Usa valores existentes ou padr√µes vazios
        document.getElementById("modal-estado").value = anime.ESTADO || "Andamento";
        document.getElementById("modal-mal").value = anime.N_MAL || ""; // Assumindo campo MAL no banco
        document.getElementById("modal-stars").value = anime.STARS || ""; // Assumindo campo STARS no banco

        // 3. Prepara Notas (L√≥gica de Estilo)
        const estilo = anime.ESTILO || "Anime";
        
        // Normaliza "Anime Inf" para comportar como "Anime"
        const isSerie = estilo === "Anime" || estilo === "Anime Inf";

        if (isSerie) {
            const rawEps = anime.EPS || anime.N_Eps || "";
            window._notasAnime = {
                ep1: anime.EP1 || anime.N_Ep_1 || "",
                eps: rawEps ? rawEps.split(",") : new Array(16).fill(""),
                epf: anime.EPF || anime.N_Ep_F || ""
            };
        } else {
            window._notasAnime = { ep1: "", eps: [], epf: "" };
        }

        renderizarFormularioNotas(estilo, anime);

        // 4. Configura Bot√µes de A√ß√£o
        let epAtual = parseInt(anime.ASSIS || 0);
        
        // Bot√£o +1 EP (Apenas visual update no bot√£o at√© salvar, ou salva direto?)
        // Aqui faremos ele atualizar o contador visual e preparar o save.
        const btnEp = document.getElementById("btn-mais-um-ep");
        btnEp.onclick = () => {
            epAtual++;
            document.getElementById("modal-epsa").textContent = epAtual;
        };

        // Bot√£o Salvar Tudo
        const btnSalvar = document.getElementById("btn-salvar-tudo");

        btnSalvar.disabled = false;
        btnSalvar.textContent = "SALVAR ALTERA√á√ïES";
        btnSalvar.classList.remove("bg-green-600"); // Caso voc√™ mude a cor ao salvar
        btnSalvar.classList.add("bg-[#B9314F]");    // Garante a cor original
        
        // Limpa o dataset de epis√≥dios da busca anterior
        document.getElementById("modal-nome").dataset.tempTotalEps = "";

        btnSalvar.onclick = async () => {
            btnSalvar.disabled = true;
            btnSalvar.textContent = "PROCESSANDO NOTAS...";

            const ESTILO = document.getElementById("modal-tag-estilo").textContent;
            const MAL = parseFloat(document.getElementById("modal-mal").value) || 0;
            const STARS = parseFloat(document.getElementById("modal-stars").value) || 0;
            const nomeAnime = document.getElementById("modal-nome").textContent;
            const totalEps = document.getElementById("modal-nome").dataset.tempTotalEps || anime.TOTAIS;

            let payloadNotas = {};

            let dadosNotas = {
                notasAnime: null,
                notasOpening: null,
                notaFilme: null,
                notaEspecial: null,
                notaInf: null,
            };

            // --- SUA L√ìGICA DE FILTRAGEM POR ESTILO ---
            if (ESTILO === "Anime") {
                const notas = window._notasAnime || { ep1: "", eps: [], epf: "" };
                const OP_FINAL = parseFloat(anime.OP) || 0;
                const OP_FORMATADA = OP_FINAL.toFixed(2);

                dadosNotas.notasAnime = notas;
                dadosNotas.notaOp = OP_FORMATADA;

                payloadNotas = {
                    ...payloadNotas,
                    N_Ep_1: notas.ep1,
                    N_Ep_F: notas.epf,
                    N_Eps: notas.eps.join(","),
                };

            } else if (ESTILO === "Filme") {
                const NOTA_FILME = document.getElementById("edit_nota_unica")?.value || "";
                dadosNotas.notaFilme = NOTA_FILME;
                payloadNotas = {
                    ...payloadNotas,
                    "N. FILME ESP.": NOTA_FILME,
                };

            } else if (ESTILO === "Especial") {
                const NOTA_ESPECIAL = document.getElementById("edit_nota_unica")?.value || "";
                dadosNotas.notaEspecial = NOTA_ESPECIAL;
                payloadNotas = {
                    ...payloadNotas,
                    "N. FILME ESP.": NOTA_ESPECIAL,
                };
            } else if (ESTILO === "Anime Inf.") {
                const arcos = window._arcosAnime || {};
                let totalSomasMediasArcos = 0, totalContagemArcos = 0;

                Object.values(arcos).forEach(arco => {
                    const notasValidas = [arco.i, arco.m, arco.f].map(n => parseFloat(n) || 0).filter(n => n > 0);
                    if (notasValidas.length > 0) {
                        totalSomasMediasArcos += (notasValidas.reduce((a, b) => a + b, 0) / notasValidas.length);
                        totalContagemArcos++;
                    }
                });

                const MEDIA_ARCOS = totalContagemArcos > 0 ? (totalSomasMediasArcos / totalContagemArcos).toFixed(2) : "";
                
                // C√°lculo Openings Inf.
                const openings = window._openingsAnime || {};
                let totalSomasOpenings = 0, totalContagemOpenings = 0;
                Object.values(openings).forEach(op => {
                    const scoreOp = (parseFloat(op.musica) || 0) + (parseFloat(op.animacao) || 0);
                    if (scoreOp > 0) { totalSomasOpenings += scoreOp; totalContagemOpenings++; }
                });
                const MEDIA_OPENINGS = totalContagemOpenings > 0 ? (totalSomasOpenings / totalContagemOpenings).toFixed(2) : "";

                dadosNotas.notaInf = MEDIA_ARCOS;
                dadosNotas.notaInfOpenings = MEDIA_OPENINGS;

                payloadNotas = {
                    ...payloadNotas,
                    "N_INFT": MEDIA_ARCOS,
                    "OP": MEDIA_OPENINGS,
                    "N. A+ e INFT.": JSON.stringify(arcos),
                    "OPENINGS_INFT": JSON.stringify(openings)
                };
            }

            // --- C√ÅLCULO DA NOTA FINAL ---
            const NOTA_F = calcularNotaFinal(ESTILO, MAL, STARS, dadosNotas);

            let payload = {
                ESTADO: document.getElementById("modal-estado").value,
                STARS: STARS,
                N_MAL: MAL,
                TOTAIS: parseInt(totalEps) || 0,
                ASSIS: epAtual, // Vari√°vel do controle de epis√≥dios
                ultima_atualizacao: new Date().toISOString(),

                // Nota Final (Calculada)
                NOTA_F: NOTA_F,

                // Notas e listas estruturadas
                ...payloadNotas
            };

            console.log("payload:", payload);

            try {
                // Salvar no Firebase
                const docRef = doc(db, "users", auth.currentUser.uid, "animes", nomeAnime);
                await setDoc(ref, payload, { merge: true });

                // Atualizar Cache Local
                const idx = window.animeCache.findIndex(a => a.NOME === nomeAnime);
                if (idx !== -1) {
                    window.animeCache[idx] = { ...window.animeCache[idx], ...payload };
                    localStorage.setItem(`animes_${auth.currentUser.uid}`, JSON.stringify(window.animeCache));
                }

                btnSalvar.textContent = "SALVO COM SUCESSO!";
                setTimeout(() => {
                    fecharModalAnime();
                    loadAnimeList();
                }, 1000);
            } catch (err) {
                console.error(err);
                alert("Erro ao salvar notas.");
                btnSalvar.disabled = false;
                btnSalvar.textContent = "Tentar Novamente";
            }
        };
        
        lucide.createIcons();
    }

    function calcularNotaFinal(estilo, mal, stars, dadosNotas) {
        let nota_f = "";

        // ====================================================================
        // 1. M.A.L. + Stars (mal_star_d)
        // ====================================================================

        const n_mal = parseFloat(mal) || 0;
        const n_mal_d = n_mal / 2;

        const star_map = { "": 0, "0": 3, "1": 7, "2": 8, "3": 9, "4": 10, "5": 10.2, "‚ú∂ ‚ú∂ ‚ú∂": 10.3, "‚ú∂ ‚ú∂": 10.4, "‚ú∂": 10.5 };
        const star_n = star_map[stars] !== undefined ? star_map[stars] : 0;

        const mal_star_d = (n_mal_d + star_n) / 1.5;

        // ====================================================================
        // 2. C√°lculo Base por Estilo
        // ====================================================================

        if (estilo === "Anime") {
            // NOTAS DE EPIS√ìDIOS
            const notas = dadosNotas.notasAnime;
            const opNotas = dadosNotas.notasOpening;
            const ep_tot = parseInt(dadosNotas.TOTAIS) || 0;

            const n_eps_list = notas.eps.map(n => parseFloat(n)).filter(n => !isNaN(n) && n > 0);
            
            const n_a = n_eps_list.length > 0 ? n_eps_list.reduce((sum, current) => sum + current, 0) / n_eps_list.length : 0;

            // --- Regi√£o Eps + Op + Eps a+ (n_f_1) ---
            const ep1 = parseFloat(notas.ep1) || 0;
            const epf = parseFloat(notas.epf) || 0;
            const nota_op = parseFloat(dadosNotas.notaOp) || 0;

            const notas_para_media = [];

            if (ep1 > 0) notas_para_media.push(ep1);
            
            notas_para_media.push(...n_eps_list); 

            if (epf > 0) notas_para_media.push(epf);
            
            if (nota_op > 0) notas_para_media.push(nota_op);

            let n_f_1 = 0;
            if (notas_para_media.length > 0) {
                // Soma todas as notas e divide pela quantidade
                n_f_1 = notas_para_media.reduce((sum, current) => sum + current, 0) / notas_para_media.length;
            }

            // --- Regi√£o Adi√ß√£o por quantidade de eps (bonus_ep) ---
            let bonus_ep = 0.00;
            if (ep_tot > 0) {
                if (ep_tot <= 15) {
                    bonus_ep = 0.01;
                } else if (ep_tot <= 26) {
                    bonus_ep = 0.02;
                } else {
                    bonus_ep = 0.03;
                }
            }

            // --- F√≥rmula final ANIME ---
            if (n_f_1 > 0 || mal_star_d > 0) {
                nota_f = (((n_f_1 + mal_star_d) / 2) + bonus_ep).toFixed(2);
            }
        } 
        else if (estilo === "Anime Inf.") {
            const notaArcos = parseFloat(dadosNotas.notaInf) || 0;
            const notaOpenings = parseFloat(dadosNotas.notaInfOpenings) || 0;

            let n_f_1 = 0;

            if (notaArcos > 0 && notaOpenings > 0) {
                // Se ambas as notas (Arcos e Openings) forem v√°lidas, calcula a m√©dia
                n_f_1 = (notaArcos + notaOpenings) / 2;
            } else if (notaArcos > 0) {
                // Se somente a nota de Arcos for v√°lida, usa ela
                n_f_1 = notaArcos;
            } else if (notaOpenings > 0) {
                // Se somente a nota de Openings for v√°lida, usa ela
                n_f_1 = notaOpenings;
            }

            // --- F√≥rmula final ANIME INF. ---
            if (n_f_1 > 0 || mal_star_d > 0) {
                // Assumindo um b√¥nus de 0.04 fixo para Anime Inf.
                nota_f = (((n_f_1 + mal_star_d) / 2) + 0.04).toFixed(2);
            }

        } 
        else if (estilo === "Filme") {
            
            // Nota espec√≠fica de Filme
            const n_f_e = parseFloat(dadosNotas.notaFilme) || 0;
            
            // --- F√≥rmula final FILME ---
            if (n_f_e > 0 || mal_star_d > 0) {
                nota_f = ((n_f_e + mal_star_d) / 2).toFixed(2);
            }
        } 
        else if (estilo === "Especial") {
                // Nota espec√≠fica de Especial
                const n_f_e = parseFloat(dadosNotas.notaEspecial) || 0;

                // --- F√≥rmula final ESPECIAL ---
                if (n_f_e > 0 || mal_star_d > 0) {
                    nota_f = ((n_f_e + mal_star_d) / 2).toFixed(2);
                }
        }

        return nota_f !== "" ? parseFloat(nota_f) : "";
    }

    // --- 4. RENDERIZADORES DE CAMPOS (Visual Atualizado) ---
    function renderizarFormularioNotas(estilo, anime) {
        const container = document.getElementById("notas_content");
        container.innerHTML = "";

        // T√≠tulo da Se√ß√£o
        const header = `<div class="mb-3 flex items-center gap-2"><i data-lucide="notebook-pen" class="w-4 h-4 text-[#B9314F]"></i><h3 class="text-sm font-bold text-white uppercase">Notas de Epis√≥dios</h3></div>`;

        if (estilo === "Filme" || estilo === "Especial") {
            container.innerHTML = `
                ${header}
                <div class="bg-[#0a0a0a] p-4 rounded-lg border border-[#2a2a2a]">
                    <label class="text-[10px] font-bold text-gray-500 uppercase">Nota Geral (${estilo})</label>
                    <input id="edit_nota_unica" type="number" step="0.1" value="${anime["N. FILME ESP."] || ''}" 
                        class="w-full bg-[#151515] border border-[#333] text-white p-3 rounded mt-2 focus:border-[#B9314F] outline-none text-lg font-mono">
                </div>`;
        } 
        else if (estilo === "Anime Inf.") {
            // 1. PRIMEIRO: Injete o HTML base que cont√©m os IDs 'ai_media_arcos', 'ai_arco_lista', etc.
            container.innerHTML = `
                ${header}
                <div class="space-y-4 bg-[#0a0a0a] p-3 rounded-lg border border-[#2a2a2a]">
                    
                    <div class="border-b border-[#333] pb-4">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-[#31B94F] text-xs uppercase">Notas por Arco</h3>
                            <span id="ai_media_arcos" class="text-[10px] font-mono text-gray-400">M√©dia: --</span>
                        </div>
                        
                        <div>
                            <label class="font-bold text-[10px] text-gray-500 uppercase mb-1 block">Selecionar Arco</label>
                            <select id="ai_arco_select" class="w-full px-2 py-2 bg-[#151515] border border-[#333] text-white text-xs rounded focus:border-[#31B94F] outline-none transition-colors">
                                </select>
                        </div>

                        <div class="grid grid-cols-3 gap-2 mt-2">
                            <div>
                                <label class="font-bold text-[9px] text-gray-500 uppercase text-center block mb-1">In√≠cio</label>
                                <input id="ai_nota_i" type="number" min="0" max="10" step="0.5" placeholder="-"
                                    class="w-full px-1 py-2 bg-[#151515] border border-[#333] text-white rounded text-center text-xs focus:border-[#31B94F] outline-none">
                            </div>
                            <div>
                                <label class="font-bold text-[9px] text-gray-500 uppercase text-center block mb-1">Meio</label>
                                <input id="ai_nota_m" type="number" min="0" max="10" step="0.5" placeholder="-"
                                    class="w-full px-1 py-2 bg-[#151515] border border-[#333] text-white rounded text-center text-xs focus:border-[#31B94F] outline-none">
                            </div>
                            <div>
                                <label class="font-bold text-[9px] text-gray-500 uppercase text-center block mb-1">Fim</label>
                                <input id="ai_nota_f" type="number" min="0" max="10" step="0.5" placeholder="-"
                                    class="w-full px-1 py-2 bg-[#151515] border border-[#333] text-white rounded text-center text-xs focus:border-[#31B94F] outline-none">
                            </div>
                        </div>

                        <div class="flex gap-2 mt-3">
                            <button class="flex-1 bg-[#1d8f3c]/10 border border-[#1d8f3c]/30 text-[#1d8f3c] hover:bg-[#1d8f3c] hover:text-white py-1.5 rounded text-[10px] font-bold uppercase transition"
                                    onclick="aiAdicionarArco()">Salvar Arco</button>
                            <button class="flex-1 bg-[#7a0e20]/10 border border-[#7a0e20]/30 text-[#7a0e20] hover:bg-[#7a0e20] hover:text-white py-1.5 rounded text-[10px] font-bold uppercase transition"
                                    onclick="aiExcluirArco()">Excluir</button>
                        </div>

                        <div id="ai_arco_lista" class="bg-[#111] border border-[#333] rounded p-2 h-24 overflow-y-auto custom-scroll text-xs mt-3 flex flex-col gap-1">
                            <span class="text-gray-600 italic text-[10px] p-1">Carregando arcos...</span>
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-[#B9314F] text-xs uppercase">Openings</h3>
                            <span id="ai_media_ops" class="text-[10px] font-mono text-gray-400">M√©dia: --</span>
                        </div>

                        <div>
                            <label class="font-bold text-[10px] text-gray-500 uppercase mb-1 block">Opening (Op)</label>
                            <select id="ai_op_select" class="w-full px-2 py-2 bg-[#151515] border border-[#333] text-white text-xs rounded focus:border-[#B9314F] outline-none transition-colors">
                                <option value="">-- Nova Opening --</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-2 gap-2 mt-2">
                            <div>
                                <label class="font-bold text-[9px] text-gray-500 uppercase text-center block mb-1">M√∫sica</label>
                                <input id="ai_op_musica" type="number" min="0" max="5" step="0.5" placeholder="0-5"
                                    class="w-full px-1 py-2 bg-[#151515] border border-[#333] text-white rounded text-center text-xs focus:border-[#B9314F] outline-none">
                            </div>
                            <div>
                                <label class="font-bold text-[9px] text-gray-500 uppercase text-center block mb-1">Anima√ß√£o</label>
                                <input id="ai_op_animacao" type="number" min="0" max="5" step="0.5" placeholder="0-5"
                                    class="w-full px-1 py-2 bg-[#151515] border border-[#333] text-white rounded text-center text-xs focus:border-[#B9314F] outline-none">
                            </div>
                        </div>

                        <div class="flex gap-2 mt-3">
                            <button class="flex-1 bg-[#1d8f3c]/10 border border-[#1d8f3c]/30 text-[#1d8f3c] hover:bg-[#1d8f3c] hover:text-white py-1.5 rounded text-[10px] font-bold uppercase transition"
                                    onclick="aiAdicionarOpening()">Salvar OP</button>
                            <button class="flex-1 bg-[#7a0e20]/10 border border-[#7a0e20]/30 text-[#7a0e20] hover:bg-[#7a0e20] hover:text-white py-1.5 rounded text-[10px] font-bold uppercase transition"
                                    onclick="aiExcluirOpening()">Excluir</button>
                        </div>

                        <div id="ai_op_lista" class="bg-[#111] border border-[#333] rounded p-2 h-24 overflow-y-auto custom-scroll text-xs mt-3 flex flex-col gap-1">
                            <span class="text-gray-600 italic text-[10px] p-1">Nenhuma OP cadastrada.</span>
                        </div>
                    </div>
                </div>
            `;
            
            // 2. AGORA SIM: Chame as fun√ß√µes de atualiza√ß√£o, pois os elementos j√° existem no DOM.
            atualizarVisualizacaoArcos();
            atualizarVisualizacaoOpenings();
            
            // Carregar selects tamb√©m, se necess√°rio
            // renderizarListaArcos();     // Preenche o <select> de Arcos
            // renderizarListaOpenings();  // Preenche o <select> de Openings
        
        }
        else {
            // Anime
            let opts = `<option value="1">Epis√≥dio 1</option>`;
            // Gera faixas
            for(let i=1; i<=16; i++) { // Simplificado para mostrar indices do array
                // A logica visual de "2-3", "4-6" depende de como voc√™ quer mapear.
                // Vamos manter a l√≥gica visual anterior:
                if(i==1) opts += `<option value="2-3">Eps 2-3</option>`;
                else {
                    let start = 4 + (i-2)*3;
                    opts += `<option value="${start}-${start+2}">Eps ${start}-${start+2}</option>`;
                }
            }
            opts += `<option value="Final">Epis√≥dio Final</option>`;

            container.innerHTML = `
                ${header}
                <div class="bg-[#0a0a0a] p-3 rounded-lg border border-[#2a2a2a]">
                    <div class="flex gap-2 mb-3">
                        <div class="flex-[2]">
                            <label class="text-[10px] text-gray-500 font-bold uppercase mb-1 block">Selecionar Faixa</label>
                            <select id="nota_faixa" class="w-full bg-[#151515] border border-[#333] text-gray-300 p-2.5 rounded text-xs focus:border-[#B9314F] outline-none">${opts}</select>
                        </div>
                        <div class="flex-1">
                            <label class="text-[10px] text-gray-500 font-bold uppercase mb-1 block">Nota</label>
                            <input id="nota_valor" type="number" step="0.1" class="w-full bg-[#151515] border border-[#333] text-white p-2.5 rounded text-xs font-bold text-center focus:border-[#B9314F] outline-none">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <button onclick="addNotaAnime()" class="bg-[#1d8f3c]/10 text-[#1d8f3c] border border-[#1d8f3c]/30 hover:bg-[#1d8f3c] hover:text-white py-2 rounded text-[10px] font-bold uppercase transition">Adicionar</button>
                        <button onclick="editNotaAnime()" class="bg-[#B97E0F]/10 text-[#B97E0F] border border-[#B97E0F]/30 hover:bg-[#B97E0F] hover:text-white py-2 rounded text-[10px] font-bold uppercase transition">Atualizar</button>
                        <button onclick="deleteNotaAnime()" class="bg-[#7a0e20]/10 text-[#7a0e20] border border-[#7a0e20]/30 hover:bg-[#7a0e20] hover:text-white py-2 rounded text-[10px] font-bold uppercase transition">Apagar</button>
                    </div>
                    
                    <div class="text-[10px] font-bold text-gray-500 uppercase mb-2">Resumo das Notas</div>
                    <div id="anime_notas_visualizacao" class="flex flex-wrap gap-2 min-h-[40px] p-2 bg-[#111] rounded border border-[#222]">
                        </div>
                </div>
            `;
            atualizarVisualizacaoNotasAnime();
        }
        lucide.createIcons();
    }

    function atualizarVisualizacaoArcos() {
        const lista = document.getElementById("ai_arco_lista");
        const dados = window._dadosAnimeInf?.arcos || []; // Supondo que voc√™ guarde aqui
        
        // C√°lculo da M√©dia Geral dos Arcos para exibir no topo
        const mediaGeral = dados.length > 0 
            ? (dados.reduce((acc, curr) => acc + ((parseFloat(curr.i)+parseFloat(curr.m)+parseFloat(curr.f))/3), 0) / dados.length).toFixed(2)
            : "--";
        document.getElementById("ai_media_arcos").textContent = `M√©dia: ${mediaGeral}`;

        if (dados.length === 0) {
            lista.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-gray-600 opacity-50">
                <i data-lucide="layers" class="w-6 h-6 mb-1"></i>
                <span class="text-[10px]">Sem arcos</span>
            </div>`;
            lucide.createIcons();
            return;
        }

        lista.innerHTML = dados.map((arco, index) => {
            // Calcula m√©dia do arco individual
            const mediaArco = ((parseFloat(arco.i) + parseFloat(arco.m) + parseFloat(arco.f)) / 3).toFixed(1);
            
            return `
            <div class="group flex items-center justify-between bg-[#151515] hover:bg-[#1a1a1a] p-2 rounded border-l-2 border-[#31B94F] transition-all mb-1">
                
                <div class="flex flex-col overflow-hidden mr-2">
                    <span class="text-[11px] font-bold text-gray-200 truncate" title="${arco.nome}">${arco.nome}</span>
                    <span class="text-[9px] font-mono text-[#31B94F] opacity-80">M√©d: ${mediaArco}</span>
                </div>

                <div class="flex items-center gap-2">
                    <div class="flex gap-1 bg-black/40 p-1 rounded">
                        <div class="flex flex-col items-center w-5">
                            <span class="text-[7px] text-gray-500 uppercase">I</span>
                            <span class="text-[10px] font-bold text-white">${arco.i}</span>
                        </div>
                        <div class="w-px bg-white/10"></div>
                        <div class="flex flex-col items-center w-5">
                            <span class="text-[7px] text-gray-500 uppercase">M</span>
                            <span class="text-[10px] font-bold text-white">${arco.m}</span>
                        </div>
                        <div class="w-px bg-white/10"></div>
                        <div class="flex flex-col items-center w-5">
                            <span class="text-[7px] text-gray-500 uppercase">F</span>
                            <span class="text-[10px] font-bold text-white">${arco.f}</span>
                        </div>
                    </div>

                    <button onclick="aiRemoverArco(${index})" 
                        class="text-gray-600 hover:text-red-500 p-1 rounded-md transition-colors" title="Remover Arco">
                        <i data-lucide="trash-2" class="w-3 h-3"></i>
                    </button>
                </div>
            </div>
        `}).join("");

        lucide.createIcons();
    }

    function atualizarVisualizacaoOpenings() {
        const lista = document.getElementById("ai_op_lista");
        const dados = window._dadosAnimeInf?.openings || [];

        // C√°lculo da M√©dia Geral das Openings
        const mediaGeral = dados.length > 0 
            ? (dados.reduce((acc, curr) => acc + ((parseFloat(curr.musica)+parseFloat(curr.animacao))/2), 0) / dados.length).toFixed(2)
            : "--";
        document.getElementById("ai_media_ops").textContent = `M√©dia: ${mediaGeral}`;

        if (dados.length === 0) {
            lista.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-gray-600 opacity-50">
                <i data-lucide="music" class="w-6 h-6 mb-1"></i>
                <span class="text-[10px]">Sem openings</span>
            </div>`;
            lucide.createIcons();
            return;
        }

        lista.innerHTML = dados.map((op, index) => {
            // M√©dia da OP
            const mediaOp = ((parseFloat(op.musica) + parseFloat(op.animacao)) / 2).toFixed(1);

            return `
            <div class="group flex items-center justify-between bg-[#151515] hover:bg-[#1a1a1a] p-2 rounded border-l-2 border-[#B9314F] transition-all mb-1">
                
                <div class="flex items-center gap-2 mr-2">
                    <span class="text-[10px] font-bold text-[#B9314F] bg-[#B9314F]/10 px-1.5 rounded">OP ${index + 1}</span>
                    <span class="text-[11px] font-medium text-gray-300 truncate max-w-[80px]" title="${op.nome || 'Opening ' + (index+1)}">${op.nome || 'Tema'}</span>
                </div>

                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-2">
                        <div class="flex items-center gap-1" title="M√∫sica">
                            <i data-lucide="music-2" class="w-3 h-3 text-gray-500"></i>
                            <span class="text-[10px] font-bold text-white">${op.musica}</span>
                        </div>
                        <div class="flex items-center gap-1" title="Anima√ß√£o">
                            <i data-lucide="film" class="w-3 h-3 text-gray-500"></i>
                            <span class="text-[10px] font-bold text-white">${op.animacao}</span>
                        </div>
                    </div>
                    
                    <div class="h-3 w-px bg-white/10"></div>

                    <span class="text-[10px] font-mono font-bold text-[#B9314F] w-6 text-right">${mediaOp}</span>

                    <button onclick="aiRemoverOpening(${index})" 
                        class="text-gray-600 hover:text-red-500 p-1 rounded-md transition-colors ml-1">
                        <i data-lucide="trash-2" class="w-3 h-3"></i>
                    </button>
                </div>
            </div>
        `}).join("");

        lucide.createIcons();
    }
        
    // --- 5. LOGICA DE MANIPULA√á√ÉO DE NOTAS (ANIME) ---
    function faixaParaIndice(faixa) {
        if (faixa === "2-3") return 0;
        const [ini] = faixa.split("-").map(n => parseInt(n));
        return Math.floor((ini - 4) / 3) + 1;
    }

    function addNotaAnime() {
        const faixa = document.getElementById("nota_faixa").value;
        const valor = document.getElementById("nota_valor").value;
        if (!valor) return alert("Digite uma nota!");

        if (faixa === "1") window._notasAnime.ep1 = valor;
        else if (faixa === "Final") window._notasAnime.epf = valor;
        else window._notasAnime.eps[faixaParaIndice(faixa)] = valor;

        atualizarVisualizacaoNotasAnime();
        document.getElementById("nota_valor").value = "";
    }
    window.addNotaAnime = addNotaAnime; // Expor para HTML

    function editNotaAnime() {
        addNotaAnime(); // Mesma l√≥gica, sobrescreve
    }
    window.editNotaAnime = editNotaAnime;

    function deleteNotaAnime() {
        const faixa = document.getElementById("nota_faixa").value;
        if (faixa === "1") window._notasAnime.ep1 = "";
        else if (faixa === "Final") window._notasAnime.epf = "";
        else window._notasAnime.eps[faixaParaIndice(faixa)] = "";
        
        atualizarVisualizacaoNotasAnime();
    }
    window.deleteNotaAnime = deleteNotaAnime;

    function atualizarVisualizacaoNotasAnime() {
        const box = document.getElementById("anime_notas_visualizacao");
        if (!box) return;
        
        const { ep1, eps, epf } = window._notasAnime;
        let html = "";

        if (ep1) html += `<div class="bg-[#B9314F]/20 border border-[#B9314F] text-[#B9314F] px-2 py-1 rounded text-xs whitespace-nowrap"><b>Ep 1:</b> ${ep1}</div>`;
        
        eps.forEach((nota, idx) => {
            if (!nota) return;
            let label = (idx === 0) ? "2-3" : `${4 + (idx-1)*3}-${4 + (idx-1)*3 + 2}`;
            html += `<div class="bg-[#333] border border-[#444] text-gray-300 px-2 py-1 rounded text-xs whitespace-nowrap"><b>${label}:</b> ${nota}</div>`;
        });

        if (epf) html += `<div class="bg-[#FCD34D]/20 border border-[#FCD34D] text-[#FCD34D] px-2 py-1 rounded text-xs whitespace-nowrap"><b>Final:</b> ${epf}</div>`;

        box.innerHTML = html || `<span class="text-xs text-gray-500 italic">Sem notas registradas.</span>`;
    }

    // --- CORRE√á√ÉO: Fun√ß√£o unificada para selecionar op√ß√£o do menu ---
    window.selecionarOpcaoMenu = function(filtro, elemento) {
        // 1. Atualiza o texto do bot√£o principal
        const texto = elemento.innerText || elemento.textContent;
        document.getElementById("selected-filter-text").textContent = texto;

        // 2. Atualiza a cor visual da sele√ß√£o (classe .selected)
        document.querySelectorAll("#dropdownMenu .filter-option").forEach(opt => {
            opt.classList.remove("selected");
        });
        elemento.classList.add("selected");

        // 3. Fecha o menu
        document.getElementById("dropdownMenu").classList.add("hidden");

        // 4. Executa a a√ß√£o
        if (filtro === 'selecionar_anime') {
            abrirModalSelecao('anime');
        } else if (filtro === 'selecionar_temporada') {
            abrirModalSelecao('temporada');
        } else {
            loadAnimeList(filtro);
        }
    };

    // --- L√ìGICA DE FILTROS POR SELE√á√ÉO (ATUALIZADA) ---

    window.abrirModalSelecao = function(tipo) {
        const modal = document.getElementById('modal-selecao');
        const titulo = document.getElementById('titulo-modal-selecao');
        const listaHtml = document.getElementById('lista-selecao');
        const inputBusca = document.getElementById('input-busca-selecao');
        
        // Fecha o dropdown principal se estiver aberto
        document.getElementById("dropdownMenu").classList.add("hidden");

        listaHtml.innerHTML = "";
        inputBusca.value = "";
        modal.classList.remove('hidden');
        inputBusca.focus(); // Foca no input automaticamente
        
        let itensParaFiltrar = [];

        if (tipo === 'anime') {
            titulo.textContent = "Selecionar Anime";
            itensParaFiltrar = window.animeCache.map(a => ({
                // Tenta usar Num, sen√£o usa ID do firestore, sen√£o usa Nome
                idUnico: a.Num || a.id || a.NOME, 
                textoPrincipal: a.NOME,
                labelExibicao: `${a.Num ? a.Num + '. ' : ''}${a.NOME}`
            })).sort((a, b) => a.textoPrincipal.localeCompare(b.textoPrincipal));
        } else {
            titulo.textContent = "Selecionar Temporada";
            // Cria lista √∫nica de temporadas
            const tempsUnicas = [...new Set(window.animeCache.map(a => {
                const t = (a.TEMPORADA || "").trim();
                const ano = String(a.ANO || "").trim();
                return (t && ano) ? `${t} ${ano}` : null;
            }).filter(x => x))];

            itensParaFiltrar = tempsUnicas.map(t => ({
                idUnico: t,
                textoPrincipal: t,
                labelExibicao: t
            })).sort((a, b) => b.textoPrincipal.localeCompare(a.textoPrincipal)); // Ordena Z-A (anos recentes primeiro)
        }

        const renderItensNoModal = (busca = "") => {
            listaHtml.innerHTML = "";
            const termo = busca.toLowerCase();

            const filtrados = itensParaFiltrar.filter(item => 
                item.textoPrincipal.toLowerCase().includes(termo) || 
                String(item.idUnico).toLowerCase().includes(termo)
            );

            if (filtrados.length === 0) {
                listaHtml.innerHTML = `<div class="p-4 text-center text-gray-500 text-sm">Nenhum resultado encontrado.</div>`;
                return;
            }

            filtrados.forEach(item => {
                const div = document.createElement('div');
                div.className = "p-3 hover:bg-[#B9314F]/20 rounded-lg cursor-pointer transition-colors border-b border-[#222] text-white flex items-center";
                div.textContent = item.labelExibicao;

                div.onclick = () => {
                    // Passa o label tamb√©m para atualizar o t√≠tulo do menu
                    window.aplicarFiltroSelecao(tipo, item.idUnico, item.labelExibicao);
                };

                listaHtml.appendChild(div);
            });
        };

        inputBusca.oninput = (e) => renderItensNoModal(e.target.value);
        renderItensNoModal();
    };

    window.aplicarFiltroSelecao = function(tipo, idAlvo, textoExibicao) {
        console.log(`Filtrando por ${tipo}: ${idAlvo}`);

        const animesFiltrados = window.animeCache.filter(a => {
            if (tipo === 'anime') {
                // Compara Num ou ID ou Nome (flex√≠vel)
                return (a.Num == idAlvo) || (a.id == idAlvo) || (a.NOME == idAlvo);
            } else {
                const tempAnime = `${(a.TEMPORADA || "").trim()} ${String(a.ANO || "").trim()}`;
                return tempAnime === idAlvo;
            }
        });

        // 1. Renderiza os cards filtrados
        if (typeof renderAnimeCards === "function") {
            renderAnimeCards(animesFiltrados);
        } else {
            console.error("Fun√ß√£o renderAnimeCards n√£o encontrada");
        }

        // 2. ATUALIZA O TEXTO DO MENU PRINCIPAL (Corre√ß√£o do Bug)
        const btnTexto = document.getElementById("selected-filter-text");
        if (btnTexto) {
            // Se for anime, encurta o nome se for muito longo
            if (tipo === 'anime' && textoExibicao.length > 25) {
                btnTexto.textContent = textoExibicao.substring(0, 25) + "...";
            } else {
                btnTexto.textContent = textoExibicao;
            }
        }
        
        fecharModalSelecao();
    };

    window.fecharModalSelecao = function() {
        document.getElementById('modal-selecao').classList.add('hidden');
    };

    async function pegarDoMAL() {
        const nomeAnime = document.getElementById("modal-nome").textContent;
        const campoMAL = document.getElementById("modal-mal");
        const displayTotalEps = document.getElementById("modal-epst"); // O span que criamos no cabe√ßalho
        
        if (!nomeAnime || nomeAnime === "Nome do Anime") return;

        campoMAL.placeholder = "Buscando...";

        try {
            const response = await fetch(`https://api.jikan.moe/v4/anime?q=${encodeURIComponent(nomeAnime)}&limit=1`);
            const data = await response.json();

            if (data.data && data.data.length > 0) {
                const info = data.data[0];
                const totalEps = info.episodes || 0;
                
                // 1. Atualiza a nota visualmente no input
                campoMAL.value = info.score || 0;
                
                // 2. ATUALIZA√á√ÉO GR√ÅFICA: Muda o texto no cabe√ßalho do modal
                if (displayTotalEps) {
                    displayTotalEps.textContent = totalEps;
                    
                    // Feedback visual: Faz o n√∫mero brilhar em azul por 2 segundos
                    displayTotalEps.classList.add("text-blue-400", "scale-110", "transition-all");
                    setTimeout(() => {
                        displayTotalEps.classList.remove("text-blue-400", "scale-110");
                    }, 2000);
                }

                // 3. Guarda no dataset para o bot√£o "Salvar" capturar depois
                document.getElementById("modal-nome").dataset.tempTotalEps = totalEps;

                console.log(`Sucesso: Nota ${info.score} e ${totalEps} epis√≥dios encontrados.`);
            }
        } catch (error) {
            console.error("Erro MAL:", error);
        } finally {
            campoMAL.placeholder = "0.0";
        }
    }

    // Torna a fun√ß√£o global para o onclick funcionar
    window.pegarDoMAL = pegarDoMAL;

    // --- HELPERS GERAIS ---
    window.fecharModalAnime = () => document.getElementById("anime-modal").classList.add("hidden");
    
    // Auth Listener
    onAuthStateChanged(auth, (user) => {
        if (!user) return window.location.href = "login.html";
        document.getElementById("user-email").textContent = user.email;
        loadAnimeList("inacabados");
    });

    // Fun√ß√µes de UI (Dropdowns)
    window.toggleFilterDropdown = () => document.getElementById("dropdownMenu").classList.toggle("hidden");
    window.toggleMoreOptions = (e) => {
        e.stopPropagation();
        document.getElementById('more-options-dropdown').classList.toggle('hidden');
    }
    document.onclick = (e) => {
        if (!e.target.closest('#more-options-btn')) document.getElementById('more-options-dropdown').classList.add('hidden');
        if (!e.target.closest('#dropdown-toggle')) document.getElementById("dropdownMenu").classList.add('hidden');
    }

</script>
