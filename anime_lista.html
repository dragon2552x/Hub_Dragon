<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Class Animes</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    body {
      background: #0b0b0b;
      font-family: Inter, system-ui, sans-serif;
      color: #e6e6e6;
      padding-bottom: 100px; /* espa√ßo para menu inferior */
    }

    .menu {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #151515;
      border-top: 1px solid #2a2a2a;
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
    }

    .menu-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #b3b3b3;
      font-size: 0.75rem;
      transition: all 0.2s;
    }

    .menu-btn:hover,
    .menu-btn.active {
      color: #B9314F;
    }

    .menu-btn svg {
      width: 22px;
      height: 22px;
      margin-bottom: 4px;
    }

    /* --- Estilos do Menu Inferior (Navega√ß√£o) --- */
        .header-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #151515;
            border-bottom: 1px solid #2a2a2a;
            padding: 10px 20px;
            z-index: 10;
        }


        .menu-btn i {
            margin-bottom: 4px;
        }
        
        /* --- Estilos do Dropdown de Mais Op√ß√µes --- */
        .dropdown-item {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 8px 10px;
            color: #e6e6e6;
            font-size: 0.875rem; /* text-sm */
            border-radius: 6px; /* rounded-lg */
            transition: background-color 0.2s;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
        }

        .dropdown-item:hover {
            background-color: #2a2a2a;
        }

        /* --- Estilos do Dropdown de Filtro Customizado (VISUAL MELHORADO) --- */
        .filter-dropdownMenu {
            position: absolute;
            top: 100%;
            left: 0;
            z-index: 20;
            width: 100%;
            background: #1f1f1f;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 4px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        .filter-option {
            /* Estilos para parecer um item de lista clic√°vel */
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.15s;
            
            /* Adicionando estilos para √≠cones e alinhamento */
            display: flex;
            align-items: center;
            gap: 10px; /* Espa√ßamento entre √≠cone e texto */
            
            /* Para usar como <button> e parecer um item de lista */
            width: 100%; 
            text-align: left; 
            background: none;
            border: none;
            color: inherit; /* Garante que o texto herde a cor do body/pai */
            font-size: 1rem; /* Tamanho da fonte padr√£o */
        }

        .filter-option:hover {
            background-color: #2a2a2a;
        }

        .filter-option.selected {
            background-color: #B9314F;
            color: #ffffff;
        }

        /* --- Estilos do Card de Anime --- */
        .anime-card {
            background: #151515;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .anime-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(185, 49, 79, 0.2);
        }

        .card-image {
            width: 100%;
            padding-top: 150%; /* 3:2 Aspect Ratio */
            position: relative;
        }

        .card-image img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .modal-top {
            z-index: 99999 !important;
        }
  </style>
</head>
<body>

<div id="app" class="container mx-auto max-w-6xl px-4 pt-4">

  <!-- MENU SUPERIOR -->
  <header class="bg-[#1f1f1f] p-2 mb-3 shadow-xl rounded-xl border border-[#2a2a2a]">
    
    <!-- Linha 1 -->
    <div class="flex justify-between items-center">
      <button onclick="window.location.href='home.html'"
              class="text-2xl font-bold text-[#B9314F] hover:text-[#992743] transition-colors duration-200">
        My Hub
      </button>

      <h1 class="text-2xl font-bold text-white">My Animes</h1>
    </div>

    <!-- Linha 2 -->
    <div class="text-sm text-gray-300 mt-1">
      Usu√°rio: <span id="user-email" class="text-[#B9314F] font-mono">Carregando...</span>
    </div>

  </header>

  <!-- CONTE√öDO PRINCIPAL DA P√ÅGINA -->
    <main class="container mx-auto p-4 pt-6">

        <!-- Removido: <h2 class="text-3xl font-extrabold mb-6 text-white">Minha Lista de Animes</h2> -->

        <!-- NOVO DROPDOWN DE VISUALIZA√á√ÉO (Filtros) - Ajustado para w-full (responsivo) -->
        <div class="relative w-full mb-6">
            <button id="dropdown-toggle"
                    class="w-full flex justify-between items-center px-4 py-2 bg-[#1f1f1f] text-white
                           border border-[#333] rounded-lg shadow-md hover:bg-[#2a2a2a] transition-colors"
                    onclick="toggleFilterDropdown()">
                <span id="selected-filter-text">Todos</span>
                <i data-lucide="chevron-down" class="w-5 h-5 transition-transform duration-200"></i>
            </button>

            <div id="dropdownMenu" class="filter-dropdownMenu hidden">
                <div class="filter-option selected" data-filter="inacabados" data-text="Todos inacabados" onclick="loadAnimeList('inacabados')">
                    Todos inacabados
                </div>
                <div class="filter-option" data-filter="temporada" data-text="Temporada Atual" onclick="loadAnimeList('temporada')">
                    Temporada Atual
                </div>
                <div class="filter-option" data-filter="ult_temporada" data-text="√öltima Temporada" onclick="loadAnimeList('ult_temporada')">
                    √öltima Temporada
                </div>
                <div class="filter-option" data-filter="andamento" data-text="andamento" onclick="loadAnimeList('andamento')">
                    Andamento
                </div>
                <div class="filter-option" data-filter="andamento" data-text="Selecionar Anime" onclick="abrirModalSelecao('anime')">
                    Selecionar Anime
                </div>
                <div class="filter-option" data-filter="andamento" data-text="Selecionar Temporada" onclick="abrirModalSelecao('temporada')">
                    Selecionar Temporada
                </div>
            </div>
        </div>
        
        <!-- CARREGAMENTO/ERRO -->
        <div id="loading-indicator" class="text-center p-10 hidden">
            <i data-lucide="loader-2" class="w-8 h-8 mx-auto animate-spin text-[#B9314F]"></i>
            <p class="mt-2 text-sm text-gray-400">Carregando animes...</p>
        </div>
        <div id="error-message" class="text-center p-10 hidden bg-red-900/20 border border-red-700/50 rounded-lg">
            <p class="text-red-400 text-sm">Ocorreu um erro ao carregar os dados. Verifique sua conex√£o.</p>
        </div>
        
        <!-- GRID DE CARDS -->
        <div id="anime-list-grid" class="grid grid-cols-2 gap-4 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5">
            <!-- Cards de animes ser√£o injetados aqui -->
        </div>
    </main>
</div>


<!-- MODAL DE ANIME -->
<div id="anime-modal"
     class="fixed inset-0 hidden overflow-y-auto bg-black bg-opacity-75"
     style="z-index: 9999;">

    <div class="relative w-11/12 max-w-lg mx-auto my-10 p-6 bg-[#2a2a2a] rounded-lg shadow-lg border border-gray-600">

        <!-- HEADER -->
        <div class="flex justify-between items-center pb-4 border-b border-gray-600">
            <button id="anime-close-btn"
                    class="p-2 rounded-full hover:bg-gray-700 transition"
                    type="button">
                <svg xmlns="http://www.w3.org/2000/svg"
                     class="h-6 w-6 text-gray-400"
                     viewBox="0 0 24 24"
                     fill="none"
                     stroke="currentColor">
                    <path stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <!-- CONTE√öDO -->
        <div class="mt-4 space-y-4">

            <!-- CABE√áALHO COM IMAGEM E NOME -->
            <div class="flex items-start space-x-4 mb-4">
                <!-- Imagem quadrada -->
                <img id="modal-imagem"
                     class="w-16 h-16 rounded-lg border border-gray-600 shadow-lg flex-shrink-0"
                     alt="Anime">
                
                <!-- Nome do anime -->
                <div class="flex-1 min-w-0">
                    <h2 id="modal-nome" class="text-xl font-bold text-white break-words leading-tight">Anime</h2>
                </div>
            </div>

            <!-- INFORMA√á√ïES DETALHADAS -->
            <div id="modal-info" class="bg-[#1f1f1f] p-4 rounded-lg border border-gray-600">
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Epis√≥dios Assistidos:</span>
                        <span id="modal-eps-assistidos" class="text-white font-medium">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Epis√≥dios Totais:</span>
                        <span id="modal-eps-totais" class="text-white font-medium">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Estilo:</span>
                        <span id="modal-estilo" class="text-white font-medium">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Estado:</span>
                        <span id="modal-estado" class="text-white font-medium">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Ano:</span>
                        <span id="modal-ano" class="text-white font-medium">-</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Temporada:</span>
                        <span id="modal-temporada" class="text-white font-medium">-</span>
                    </div>
                </div>
            </div>

            <!-- BOT√ïES DE A√á√ÉO -->
            <div class="flex space-x-3">
                <button id="btn-openings" 
                        class="flex-1 bg-[#B9314F] hover:bg-[#992743] text-white font-medium py-3 px-4 rounded-lg transition-colors">
                    Openings
                </button>
                <button id="btn-estado" 
                        class="flex-1 bg-[#4F46E5] hover:bg-[#4338CA] text-white font-medium py-3 px-4 rounded-lg transition-colors">
                    Estado
                </button>
                <button id="btn-episodio" 
                        class="flex-1 bg-[#059669] hover:bg-[#047857] text-white font-medium py-3 px-4 rounded-lg transition-colors">
                    Epis√≥dios
                </button>
            </div>

            <!-- √ÅREA PARA ADICIONAR INFORMA√á√ïES -->
            <div id="modal-info-adicional" class="bg-[#1f1f1f] p-4 rounded-lg border border-gray-600">
                <div id="info-adicional-container" class="space-y-2">
                    <!-- Conte√∫do adicional ser√° adicionado aqui -->
                    <p class="text-gray-500 text-sm italic">Nenhuma informa√ß√£o adicional adicionada ainda.</p>
                </div>
            </div>

        </div>

    </div>
</div>

<!-- MODAL DE PESQUISA -->
<div id="modal-selecao" class="fixed inset-0 bg-black/90 z-[100] hidden flex items-center justify-center p-4">
    <div class="bg-[#151515] w-full max-w-md rounded-2xl border border-[#333] flex flex-col max-h-[80vh]">
        <div class="p-4 border-b border-[#333] flex justify-between items-center">
            <h3 id="titulo-modal-selecao" class="text-lg font-bold">Selecionar</h3>
            <button onclick="fecharModalSelecao()" class="text-gray-400"><i data-lucide="x"></i></button>
        </div>
        
        <div class="p-4">
            <input type="text" id="input-busca-selecao" placeholder="Buscar..." 
                   class="w-full bg-[#0b0b0b] border border-[#333] rounded-lg px-4 py-2 text-white focus:outline-none focus:border-[#B9314F]">
        </div>

        <div id="lista-selecao" class="overflow-y-auto p-2 space-y-1">
            </div>
    </div>
</div>


<!-- MENU INFERIOR -->
<nav class="menu fixed bottom-0 left-0 w-full bg-[#151515] border-t border-[#2a2a2a] flex justify-around py-2 z-40">
    
    <button class="menu-btn" onclick="window.location.href='animes_manager.html'">
        <i data-lucide="home" class="w-6 h-6 mb-1"></i>
        <span class="text-[10px]">In√≠cio</span>
    </button>

    <button class="menu-btn" onclick="window.location.href='animes_cadastro.html'">
        <i data-lucide="file-edit" class="w-6 h-6 mb-1"></i>
        <span class="text-[10px]">Gest√£o</span>
    </button>

    <button class="menu-btn active" onclick="window.location.href='anime_lista.html'">
        <i data-lucide="list" class="w-6 h-6 mb-1"></i>
        <span class="text-[10px]">Lista</span>
    </button>

    <div class="relative flex">
        <button id="more-options-btn" class="menu-btn" onclick="toggleMoreOptions(event)">
            <i data-lucide="more-horizontal" class="w-6 h-6 mb-1"></i>
            <span class="text-[10px]">Mais</span>
        </button>

        <div id="more-options-dropdown"
             class="absolute bottom-full mb-3 right-0 w-48 bg-[#1f1f1f] border border-[#333] rounded-xl shadow-2xl p-1 hidden z-50 flex flex-col">

            <button class="w-full text-left px-4 py-3 text-sm text-gray-300 hover:bg-[#2a2a2a] hover:text-white rounded-lg transition-colors flex items-center gap-3" 
                    onclick="window.location.href='animes_classificacoes.html'">
                <i data-lucide="bar-chart-2" class="w-4 h-4 text-[#B9314F]"></i> 
                <span>Classifica√ß√£o</span>
            </button>
            
            <button class="w-full text-left px-4 py-3 text-sm text-gray-300 hover:bg-[#2a2a2a] hover:text-white rounded-lg transition-colors flex items-center gap-3" 
                    onclick="window.location.href='animes_estrelas.html'">
                <i data-lucide="trophy" class="w-4 h-4 text-[#B9314F]"></i> 
                <span>Estrelas</span>
            </button>
            
            <button class="w-full text-left px-4 py-3 text-sm text-gray-300 hover:bg-[#2a2a2a] hover:text-white rounded-lg transition-colors flex items-center gap-3" 
                    onclick="window.location.href='animes_torneio.html'">
                <i data-lucide="trophy" class="w-4 h-4 text-[#B9314F]"></i> 
                <span>Torneio</span>
            </button>

            <button class="w-full text-left px-4 py-3 text-sm text-gray-300 hover:bg-[#2a2a2a] hover:text-white rounded-lg transition-colors flex items-center gap-3" 
                    onclick="window.location.href='animes_serie.html'">
                <i data-lucide="layers" class="w-4 h-4 text-[#B9314F]"></i> 
                <span>Serie</span>
            </button>
        </div>
    </div>
</nav>

<script>
  lucide.createIcons();
  function abrirPagina(pagina) {
    window.location.href = pagina;
  }
</script>

<!-- FIREBASE -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDsbiLPBOda119Qr6Ji69j8TZLpiFixBWI",
        authDomain: "list-games-9bddd.firebaseapp.com",
        projectId: "list-games-9bddd",
        storageBucket: "list-games-9bddd.firebasestorage.app",
        messagingSenderId: "756898313156",
        appId: "1:756898313156:web:9bc660d0a2f4cd07882a91",
        measurementId: "G-GLM50YVLXP"
    };

    const firebaseApp = initializeApp(firebaseConfig);
    const auth = getAuth(firebaseApp);

    const userEmailEl = document.getElementById("user-email");

    let animeCache = [];
    if (!window.animeCache) window.animeCache = [];

    import { getFirestore, collection, getDocs, query, where, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const db = getFirestore(firebaseApp);

    async function carregarAnimesParaCache() {
        const user = auth.currentUser;
        if (!user) return [];

        const ref = collection(db, "users", user.uid, "animes");
        const snapshot = await getDocs(ref);
        const dados = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        // Salva no cache global da janela e no localStorage
        window.animeCache = dados;
        localStorage.setItem(`animes_${user.uid}`, JSON.stringify(dados));
        
        return dados;
    }
    window.carregarAnimesParaCache = carregarAnimesParaCache;

    function toggleMoreOptions(event) {
        event.stopPropagation(); // Previne que o clique feche imediatamente
        const dropdown = document.getElementById('more-options-dropdown');
        dropdown.classList.toggle('hidden');
    }

    // Fun√ß√£o para fechar o dropdown se o usu√°rio clicar fora dele
    document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('more-options-dropdown');
        const button = document.getElementById('more-options-btn');
        if (dropdown && button && !button.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.add('hidden');
        }
    });

    window.toggleMoreOptions = toggleMoreOptions;

    function toggleFilterDropdown() {
        const dropdownMenu = document.getElementById("dropdownMenu");
        if (!dropdownMenu) {
            console.warn("toggleFilterDropdown: dropdown n√£o encontrado.");
            return;
        }
        dropdownMenu.classList.toggle("hidden");
    }
    window.toggleFilterDropdown = toggleFilterDropdown;

    window.selectFilter = (filterType) => {
        const dropdownMenu = document.getElementById("dropdownMenu");
        const selectedTextEl = document.getElementById("selected-filter-text");

        if (!dropdownMenu || !selectedTextEl) return;

        // Atualiza sele√ß√£o visual
        document.querySelectorAll("#dropdownMenu .filter-option").forEach(option => {
            option.classList.remove("selected");

            if (option.getAttribute("data-filter") === filterType) {
                option.classList.add("selected");

                // Atualiza o texto do bot√£o principal
                const label = option.getAttribute("data-text") || option.textContent.trim();
                selectedTextEl.textContent = label;
            }
        });

        // Fecha o menu
        toggleFilterDropdown();

        // Aplica o filtro
        loadAnimeList(filterType);
    };

    // garante que o dropdown exista antes de anexar listeners
    (function setupDropdownLabelSync() {
    const menu = document.getElementById('dropdownMenu');
    const selectedTextEl = document.getElementById('selected-filter-text');

    if (!menu || !selectedTextEl) {
        // se ainda n√£o existir, tenta novamente depois de 200ms (caso o script rode antes do HTML)
        setTimeout(setupDropdownLabelSync, 200);
        return;
    }

    // Delegation: quando clicar em uma .filter-option, atualiza o texto, a classe selected e fecha o menu.
    menu.addEventListener('click', (ev) => {
        const opt = ev.target.closest('.filter-option');
        if (!opt || !menu.contains(opt)) return;

        // pega o texto do data-text ou o texto interno
        const label = (opt.getAttribute('data-text') || opt.textContent || '').trim();
        if (label) selectedTextEl.textContent = label;

        // atualiza sele√ß√£o visual
        document.querySelectorAll('#dropdownMenu .filter-option').forEach(o => o.classList.remove('selected'));
        opt.classList.add('selected');

        // fecha o dropdown (n√£o chamamos loadAnimeList aqui pois seu onclick inline j√° faz)
        menu.classList.add('hidden');
    });

    // Tamb√©m fecha o dropdown se clicar fora (melhora UX)
    document.addEventListener('click', (ev) => {
        const toggle = document.getElementById('dropdown-toggle');
        if (!menu.contains(ev.target) && ev.target !== toggle && !toggle.contains(ev.target)) {
        menu.classList.add('hidden');
        }
    });

    // opcional: atualiza o texto inicial baseado na op√ß√£o com .selected (se houver)
    const initial = document.querySelector('#dropdownMenu .filter-option.selected');
    if (initial) {
        const label = (initial.getAttribute('data-text') || initial.textContent || '').trim();
        if (label) selectedTextEl.textContent = label;
    }
    })();

    function criarCardAnime(anime) {
        const imagem = anime.IMAGEM || "https://via.placeholder.com/300x450?text=Sem+Imagem";

        return `
            <div class="anime-card" data-nome="${anime.NOME}">

                <div class="card-image">
                    <img src="${imagem}" alt="${anime.NOME}">
                </div>

                <div class="p-2">
                    <h3 class="font-bold text-sm truncate text-white">${anime.NOME}</h3>
                    <p class="text-xs text-gray-400">${anime.ESTILO || "Anime"}</p>
                </div>

            </div>
        `;
    }

    function getTemporadaAtual() {
        const mes = new Date().getMonth() + 1; // 1..12
        if (mes >= 1 && mes <= 3) return 1;    // Inverno
        if (mes >= 4 && mes <= 6) return 4;    // Primavera
        if (mes >= 7 && mes <= 9) return 7;    // Ver√£o
        return 10;                             // Outono
    }

    async function loadAnimeList(filtro = "inacabados") {        
        const user = auth.currentUser;
        if (!user) return;

        // 1. GARANTIA DE DADOS (LocalStorage > Firebase)
        if (!window.animeCache || window.animeCache.length === 0) {
            const cacheKey = `animes_${user.uid}`;
            const cachedData = localStorage.getItem(cacheKey);

            if (cachedData) {
                console.log("üì¶ loadAnimeList: Dados recuperados do localStorage");
                window.animeCache = JSON.parse(cachedData);
            } else {
                console.log("üî• loadAnimeList: Cache vazio, realizando leitura √∫nica no Firebase...");
                await carregarAnimesParaCache(); // Esta fun√ß√£o deve salvar no localStorage
            }
        }

        // Fallback para evitar erro de .filter
        let lista = Array.isArray(window.animeCache) ? [...window.animeCache] : [];

        // 2. APLICA√á√ÉO DOS FILTROS
        if (filtro === "andamento") {
            lista = lista.filter(a => (a.ESTADO || "") === "Andamento");
        } else if (filtro === "inacabados") {
            lista = lista.filter(a => {
                const st = (a.ESTADO || "");
                return st !== "Completo" && st !== "Assistido" && st !== "Desist√™ncia";
            });
        } else if (filtro === "temporada" || filtro === "ult_temporada") {
            // L√≥gica de Temporada (Otimizada para evitar repeti√ß√£o de c√≥digo)
            let anoAlvo = new Date().getFullYear();
            let tempAlvo = getTemporadaAtual();

            if (filtro === "ult_temporada") {
                if (tempAlvo === 1) { tempAlvo = 10; anoAlvo -= 1; }
                else if (tempAlvo === 4) { tempAlvo = 1; }
                else if (tempAlvo === 7) { tempAlvo = 4; }
                else if (tempAlvo === 10) { tempAlvo = 7; }
            }

            lista = lista.filter(anime => {
                const tempStr = (anime.TEMPORADA || "").trim();
                const ano = Number(anime.ANO);
                if (!tempStr || isNaN(ano) || ano !== anoAlvo) return false;
                
                const lower = tempStr.toLowerCase();
                if (lower.includes("outro") || lower.includes("outra")) return false;

                const m = tempStr.match(/\((\d+)\)/);
                if (!m) return false;
                return Number(m[1]) === tempAlvo;
            });
        } else {
            // Filtros gen√©ricos (ex: "Completo", "Pausado")
            lista = lista.filter(a => (a.ESTADO || "").toLowerCase() === String(filtro).toLowerCase());
        }

        // 3. ORDENA√á√ÉO (Opcional: Geralmente por n√∫mero de s√©rie ou nome)
        lista.sort((a, b) => (a.N || 0) - (b.N || 0));

        // 4. RENDERIZA√á√ÉO
        if (typeof renderAnimeCards === "function") {
            renderAnimeCards(lista);
        } else {
            console.error("Fun√ß√£o renderAnimeCards n√£o encontrada!");
        }
    }

    window.loadAnimeList = loadAnimeList;

    // --- L√ìGICA DE FILTROS POR SELE√á√ÉO ---

    window.abrirModalSelecao = function(tipo) {
        const modal = document.getElementById('modal-selecao');
        const titulo = document.getElementById('titulo-modal-selecao');
        const listaHtml = document.getElementById('lista-selecao');
        const inputBusca = document.getElementById('input-busca-selecao');
        
        listaHtml.innerHTML = "";
        inputBusca.value = "";
        modal.classList.remove('hidden');
        
        let itensParaFiltrar = [];

        if (tipo === 'anime') {
            titulo.textContent = "Selecionar Anime";
            // Mapeamos os animes para um formato de objeto simples
            itensParaFiltrar = window.animeCache.map(a => ({
                idUnico: a.Num, // Usamos o NUM para identificar
                textoPrincipal: a.NOME,
                labelExibicao: `${a.Num}. ${a.NOME}` // O que aparece na lista
            })).sort((a, b) => a.textoPrincipal.localeCompare(b.textoPrincipal));
        } else {
            titulo.textContent = "Selecionar Temporada";
            const tempsUnicas = [...new Set(window.animeCache.map(a => {
                const t = (a.TEMPORADA || "").trim();
                const ano = String(a.ANO || "").trim();
                return t && ano ? `${t} ${ano}` : null;
            }).filter(x => x))];

            itensParaFiltrar = tempsUnicas.map(t => ({
                idUnico: t,
                textoPrincipal: t,
                labelExibicao: t
            })).sort((a, b) => b.textoPrincipal.localeCompare(a.textoPrincipal));
        }

        const renderItensNoModal = (busca = "") => {
            listaHtml.innerHTML = "";
            const termo = busca.toLowerCase();

            const filtrados = itensParaFiltrar.filter(item => 
                item.textoPrincipal.toLowerCase().includes(termo) || 
                item.idUnico.toString().includes(termo)
            );

            filtrados.forEach(item => {
                const div = document.createElement('div');
                div.className = "p-3 hover:bg-[#B9314F]/20 rounded-lg cursor-pointer transition-colors border-b border-[#222] text-white flex items-center";
                
                // Usamos textContent para o nome (protege contra [Oshi no Ko], aspas, etc)
                div.textContent = item.labelExibicao;

                div.onclick = () => {
                    window.aplicarFiltroSelecao(tipo, item.idUnico);
                };

                listaHtml.appendChild(div);
            });
        };

        inputBusca.oninput = (e) => renderItensNoModal(e.target.value);
        renderItensNoModal();
    };

    window.aplicarFiltroSelecao = function(tipo, idAlvo) {
        const animesFiltrados = window.animeCache.filter(a => {
            if (tipo === 'anime') {
                // Filtra pelo NUM (ID √önico num√©rico)
                return Number(a.Num) === Number(idAlvo);
            } else {
                // Filtra pela Temporada concatenada
                const tempAnime = `${(a.TEMPORADA || "").trim()} ${String(a.ANO || "").trim()}`;
                return tempAnime === idAlvo;
            }
        });

        if (typeof renderAnimeCards === "function") {
            renderAnimeCards(animesFiltrados);
        }
        
        fecharModalSelecao();
    };

    window.fecharModalSelecao = function() {
        document.getElementById('modal-selecao').classList.add('hidden');
    };

    // ABRIR MODAL
    function abrirModalAnime(nome) {
        const anime = window.animeCache.find(a =>
            String(a.NOME).replace(/^"+|"+$/g, "") === nome
        );

        if (!anime) {
            console.error("‚ùå Anime n√£o encontrado:", nome);
            return;
        }

        const modal = document.getElementById("anime-modal");
        if (!modal) return;

        document.getElementById("modal-nome").textContent = anime.NOME.replace(/^"+|"+$/g, "");
        document.getElementById("modal-imagem").src =
            anime.IMAGEM || "https://via.placeholder.com/300x450";

        document.getElementById("modal-info").innerHTML = `
            <b>Estado:</b> <span id="modal-estado">${anime.ESTADO || "-"}</span><br>
            <b>Estilo:</b> ${anime.ESTILO || "-"}<br>
            <b>Ano:</b> ${anime.ANO || "-"}<br>
            <b>Temporada:</b> ${anime.TEMPORADA || "-"}<br>
            <b>Epis√≥dios:</b> ${anime.ASSIS || 0} / ${anime.TOTAIS || 0}
        `;

        modal.classList.remove("hidden");
    }

    // FECHAR MODAL
    function fecharModalAnime() {
        document.getElementById("anime-modal").classList.add("hidden");
    }

    // Fun√ß√£o para adicionar informa√ß√£o adicional
    function adicionarInfoAdicional(titulo, conteudo) {
        const container = document.getElementById("info-adicional-container");
        
        // Remover a mensagem padr√£o se ainda existir
        const msgDefault = container.querySelector('.text-gray-500.text-sm.italic');
        if (msgDefault) {
            msgDefault.remove();
        }

        // Criar nova informa√ß√£o
        const infoDiv = document.createElement('div');
        infoDiv.className = 'bg-[#2a2a2a] p-3 rounded border border-gray-600';
        infoDiv.innerHTML = `
            <h4 class="font-medium text-white mb-1">${titulo}</h4>
            <p class="text-sm text-gray-300">${conteudo}</p>
        `;

        container.appendChild(infoDiv);
    }

    // Fun√ß√£o para adicionar epis√≥dio assistido
    async function adicionarEpisodioAssistido() {
        const nomeAnime = document.getElementById("modal-nome").textContent.trim();
        const anime = window.animeCache.find(item => item.NOME === nomeAnime);

        if (!anime) return;

        const container = document.getElementById("info-adicional-container");
        const estilo = anime.ESTILO || "Anime";

        // Inicializa objetos de notas para manipula√ß√£o em tempo real
        if (estilo === "Anime") {
            window._notasAnime = {
                ep1: anime.EP1 || "",
                eps: anime.EPS ? anime.EPS.split(",") : new Array(16).fill(""),
                epf: anime.EPF || ""
            };
        }

        // --- L√ìGICA DE CONTE√öDO (ID√äNTICA √Ä SUA FUN√á√ÉO ATUALIZARGRUPONOTAS) ---
        let contentHTML = "";

        if (estilo === "Filme") {
            contentHTML = `
                <div class="grid grid-cols-1 gap-2 w-full">
                    <div>
                        <label class="font-bold text-sm">Nota</label>
                        <input id="edit_nota_filme" type="number" step="0.01" value="${anime["N. FILME ESP."] || ""}"
                            class="w-full px-3 py-1.5 bg-[#151515] border border-[#333] text-white rounded-md">
                    </div>
                </div>`;
        } 
        else if (estilo === "Especial") {
            contentHTML = `
                <div class="grid grid-cols-1 gap-2 w-full">
                    <div>
                        <label class="font-bold text-sm">Nota</label>
                        <input id="edit_nota_especial" type="number" step="0.01" value="${anime["N. FILME ESP."] || ""}"
                            class="w-full px-3 py-1.5 bg-[#151515] border border-[#333] text-white rounded-md">
                    </div>
                </div>`;
        } 
        else if (estilo === "Anime") {
            contentHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="font-bold text-sm">Faixa de Eps.</label>
                            <select id="nota_faixa" class="w-full px-2 py-1.5 bg-[#151515] border border-[#333] text-white rounded-md">
                                ${typeof gerarFaixasNota === 'function' ? gerarFaixasNota() : ""}
                            </select>
                        </div>
                        <div>
                            <label class="font-bold text-sm">Nota</label>
                            <input id="nota_valor" type="number" step="0.01" class="w-full px-2 py-1.5 bg-[#151515] border border-[#333] text-white rounded-md">
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button class="bg-[#1d8f3c] px-2 py-1 rounded-md font-bold hover:opacity-75" onclick="addNotaAnime()">Adicionar</button>
                        <button class="bg-[#B97E0F] px-2 py-1 rounded-md font-bold hover:opacity-75" onclick="editNotaAnime()">Editar</button>
                        <button class="bg-[#7a0e20] px-2 py-1 rounded-md font-bold hover:opacity-75" onclick="deleteNotaAnime()">Excluir</button>
                    </div>
                    <div id="anime_notas_visualizacao" class="bg-[#111] border border-[#333] rounded-md p-2 overflow-x-auto whitespace-nowrap text-sm">
                        <span class="text-gray-500">Carregando notas...</span>
                    </div>
                    <h3 class="font-bold text-[#B9314F] mt-4">Opening</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="font-bold text-sm">M√∫sica</label>
                            <div class="grid grid-cols-3 gap-2 mt-1">
                                <input id="op_musica_1" type="number" placeholder="N1" class="px-2 py-1 bg-[#151515] border border-[#333] text-white rounded-md text-center">
                                <input id="op_musica_2" type="number" placeholder="N2" class="px-2 py-1 bg-[#151515] border border-[#333] text-white rounded-md text-center">
                                <input id="op_musica_3" type="number" placeholder="N3" class="px-2 py-1 bg-[#151515] border border-[#333] text-white rounded-md text-center">
                            </div>
                        </div>
                        <div>
                            <label class="font-bold text-sm">Anima√ß√£o</label>
                            <div class="grid grid-cols-3 gap-2 mt-1">
                                <input id="op_anim_1" type="number" placeholder="N1" class="px-2 py-1 bg-[#151515] border border-[#333] text-white rounded-md text-center">
                                <input id="op_anim_2" type="number" placeholder="N2" class="px-2 py-1 bg-[#151515] border border-[#333] text-white rounded-md text-center">
                                <input id="op_anim_3" type="number" placeholder="N3" class="px-2 py-1 bg-[#151515] border border-[#333] text-white rounded-md text-center">
                            </div>
                        </div>
                    </div>
                </div>`;
        } 
        else if (estilo === "Anime Inf.") {
            // --- SEU C√ìDIGO EXATO DE ANIME INF. ABAIXO ---
            contentHTML = `
                <div class="space-y-4">
                    <div class="border-b border-[#333] pb-4">
                        <h3 class="font-bold text-[#31B94F] mb-2">Notas por Arco</h3>
                        <div>
                            <label class="font-bold text-sm">Arco</label>
                            <select id="ai_arco_select" class="w-full px-2 py-1.5 bg-[#151515] border border-[#333] text-white rounded-md">
                            </select>
                        </div>
                        <div class="grid grid-cols-3 gap-2 mt-2">
                            <div>
                                <label class="font-bold text-sm">In√≠cio (I)</label>
                                <input id="ai_nota_i" type="number" min="0" max="10" step="0.5" class="w-full px-2 py-1.5 bg-[#151515] border border-[#333] text-white rounded-md text-center">
                            </div>
                            <div>
                                <label class="font-bold text-sm">Meio (M)</label>
                                <input id="ai_nota_m" type="number" min="0" max="10" step="0.5" class="w-full px-2 py-1.5 bg-[#151515] border border-[#333] text-white rounded-md text-center">
                            </div>
                            <div>
                                <label class="font-bold text-sm">Fim (F)</label>
                                <input id="ai_nota_f" type="number" min="0" max="10" step="0.5" class="w-full px-2 py-1.5 bg-[#151515] border border-[#333] text-white rounded-md text-center">
                            </div>
                        </div>
                        <div class="flex gap-3 mt-3">
                            <button class="bg-[#1d8f3c] px-2 py-1 rounded-md font-bold hover:opacity-75 text-sm" onclick="aiAdicionarArco()">Adicionar/Editar</button>
                            <button class="bg-[#7a0e20] px-2 py-1 rounded-md font-bold hover:opacity-75 text-sm" onclick="aiExcluirArco()">Excluir</button>
                        </div>
                        <div id="ai_arco_lista" class="bg-[#111] border border-[#333] rounded-md p-2 h-28 overflow-y-auto text-sm mt-3">
                            <span class="text-gray-500">Nenhum arco cadastrado ainda.</span>
                        </div>
                    </div>
                    <div class="border-b border-[#333] pb-4">
                        <h3 class="font-bold text-[#B9314F] mb-2">Openings</h3>
                        <div>
                            <label class="font-bold text-sm">Opening (Op.)</label>
                            <select id="ai_op_select" class="w-full px-2 py-1.5 bg-[#151515] border border-[#333] text-white rounded-md">
                                <option value="">-- Nova Opening --</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mt-2">
                            <div>
                                <label class="font-bold text-sm">M√∫sica</label>
                                <input id="ai_op_musica" type="number" min="0" max="10" step="0.5" class="w-full px-2 py-1.5 bg-[#151515] border border-[#333] text-white rounded-md text-center">
                            </div>
                            <div>
                                <label class="font-bold text-sm">Anima√ß√£o</label>
                                <input id="ai_op_animacao" type="number" min="0" max="10" step="0.5" class="w-full px-2 py-1.5 bg-[#151515] border border-[#333] text-white rounded-md text-center">
                            </div>
                        </div>
                        <div class="flex gap-3 mt-3">
                            <button class="bg-[#1d8f3c] px-2 py-1 rounded-md font-bold hover:opacity-75 text-sm" onclick="aiAdicionarOpening()">Adicionar/Editar</button>
                            <button class="bg-[#7a0e20] px-2 py-1 rounded-md font-bold hover:opacity-75 text-sm" onclick="aiExcluirOpening()">Excluir</button>
                        </div>
                        <div id="ai_op_lista" class="bg-[#111] border border-[#333] rounded-md p-2 h-28 overflow-y-auto text-sm mt-3">
                            <span class="text-gray-500">Nenhuma Opening cadastrada ainda.</span>
                        </div>
                    </div>
                </div>`;
        }

        // --- MONTAGEM FINAL NO MODAL ---
        container.innerHTML = `
            <div class="p-2">
                <div id="notas_content">
                    ${contentHTML}
                </div>
                <div class="flex gap-3 mt-6">
                    <button id="btn-mais-um-ep" 
                        class="flex-1 px-2 py-2 bg-[#B9314F] hover:bg-[#992743] rounded-md font-bold text-white text-sm">
                        +1 Ep.
                    </button>

                    <button id="btn-salvar-tudo" 
                        class="flex-[2] px-2 py-2 bg-[#B9314F] hover:bg-[#992743] rounded-md font-bold text-white text-sm">
                        Confirmar Altera√ß√µes
                    </button>
                </div>
        `;

        // Ativa √≠cones e inicializa fun√ß√µes de suporte se necess√°rio
        lucide.createIcons();
        if (estilo === "Anime") {
            if (typeof atualizarVisualizacaoNotasAnime === "function") atualizarVisualizacaoNotasAnime();
            if (typeof instalarEventosOP === "function") instalarEventosOP();
        }
        
        // Inicializadores espec√≠ficos de Anime Inf. (se voc√™ tiver essas fun√ß√µes globais)
        if (estilo === "Anime Inf.") {
            if (typeof aiCarregarDadosIniciais === "function") aiCarregarDadosIniciais();
        }

        // --- L√ìGICA DO BOT√ÉO +1 EP ---
        let epTemp = parseInt(anime.EPISODIO || 0);
        document.getElementById("btn-mais-um-ep").onclick = () => {
            epTemp++;
            document.getElementById("contagem-ep-atual").innerHTML = `${epTemp} <span class="text-sm font-normal">Eps</span>`;
        };

        // --- L√ìGICA DE SALVAMENTO NO FIREBASE ---
        document.getElementById("btn-salvar-tudo").onclick = async function() {
            const btn = this;
            btn.disabled = true;
            btn.textContent = "SALVANDO...";

            try {
                let updateObj = { EPISODIO: epTemp };

                // Captura dados conforme o estilo
                if (estilo === "Filme" || estilo === "Especial") {
                    const idInput = estilo === "Filme" ? "edit_nota_filme" : "edit_nota_especial";
                    updateObj["N. FILME ESP."] = document.getElementById(idInput).value;
                }
                if (estilo === "Anime") {
                    updateObj["EP1"] = window._notasAnime.ep1;
                    updateObj["EPF"] = window._notasAnime.epf;
                    updateObj["EPS"] = window._notasAnime.eps.join(",");
                }
                // Para Anime Inf, os dados geralmente s√£o salvos pelas fun√ß√µes aiAdicionar... 
                // Mas aqui garantimos a atualiza√ß√£o do epis√≥dio.

                const snap = await getDocs(query(collection(db, "users", auth.currentUser.uid, "animes"), where("NOME", "==", nomeAnime)));
                if (!snap.empty) {
                    await updateDoc(snap.docs[0].ref, updateObj);
                    
                    // Atualiza Cache Local
                    Object.assign(anime, updateObj);
                    localStorage.setItem(`animes_${auth.currentUser.uid}`, JSON.stringify(window.animeCache));
                    
                    btn.classList.replace("bg-white", "bg-green-600");
                    btn.classList.add("text-white");
                    btn.textContent = "SALVO COM SUCESSO!";
                    setTimeout(() => adicionarEpisodioAssistido(), 1200);
                }
            } catch (e) {
                console.error(e);
                btn.textContent = "ERRO AO SALVAR";
            } finally {
                btn.disabled = false;
            }
        };
    }

    function gerarFaixasNota() {
        let faixas = `
            <option value="1">1</option>
            <option value="2-3">2-3</option>
            <option value="4-6">4-6</option>
            <option value="7-9">7-9</option>
        `;

        for (let i = 10; i <= 50; i += 3) {
            const fim = i + 2;
            faixas += `<option value="${i}-${fim}">${i}-${fim}</option>`;
        }

        faixas += `<option value="Final">Final</option>`;
        return faixas;
    }

    function obterIndiceFaixa(faixa) {
        if (faixa === "2-3") return 0;

        const [ini] = faixa.split("-").map(n => parseInt(n));
        return Math.floor((ini - 4) / 3) + 1;
    }

    function addNotaAnime() {
        const faixa = document.getElementById("nota_faixa").value;
        const valor = document.getElementById("nota_valor").value;

        if (!faixa || valor === "") {
            alert("Selecione faixa e informe a nota!");
            return;
        }

        // EP 1
        if (faixa === "1") {
            if (window._notasAnime.ep1) {
                alert("J√° existe nota para o Epis√≥dio 1!");
                return;
            }
            window._notasAnime.ep1 = valor;
        }

        // Final
        else if (faixa === "Final") {
            if (window._notasAnime.epf) {
                alert("J√° existe nota para o Epis√≥dio Final!");
                return;
            }
            window._notasAnime.epf = valor;
        }

        // Faixas intermedi√°rias 2-3, 4-6, etc
        else {
            const pos = faixaParaIndice(faixa);

            if (window._notasAnime.eps[pos]) {
                alert("Esta faixa j√° tem uma nota cadastrada!");
                return;
            }

            window._notasAnime.eps[pos] = valor;
        }

        atualizarVisualizacaoNotasAnime();
    }

    window.addNotaAnime = addNotaAnime;

    function editNotaAnime() {
        const faixa = document.getElementById("nota_faixa").value;
        const valor = document.getElementById("nota_valor").value;

        if (!faixa || valor === "") {
            alert("Selecione uma faixa e uma nota!");
            return;
        }

        if (faixa === "1") window._notasAnime.ep1 = valor;
        else if (faixa === "Final") window._notasAnime.epf = valor;
        else {
            const pos = faixaParaIndice(faixa);
            window._notasAnime.eps[pos] = valor;
        }

        atualizarVisualizacaoNotasAnime();
    }

    window.editNotaAnime = editNotaAnime;

    function deleteNotaAnime() {
        const faixa = document.getElementById("nota_faixa").value;

        if (!faixa) {
            alert("Selecione uma faixa para excluir.");
            return;
        }

        if (faixa === "1") window._notasAnime.ep1 = "";
        else if (faixa === "Final") window._notasAnime.epf = "";
        else {
            const pos = faixaParaIndice(faixa);
            window._notasAnime.eps[pos] = "";
        }

        atualizarVisualizacaoNotasAnime();
    }

    window.deleteNotaAnime = deleteNotaAnime;

    function atualizarVisualizacaoNotasAnime() {
        const box = document.getElementById("anime_notas_visualizacao");
        if (!box) return;

        const { ep1, eps, epf } = window._notasAnime;
        let html = `<div class="flex gap-3 items-center whitespace-nowrap">`;

        // EP 1 (s√≥ aparece se tiver nota)
        if (ep1 && ep1 !== "") {
            html += `
                <div class="px-2 py-1 bg-[#222] rounded-md border border-[#444]">
                    <span class="text-[#B9314F] font-bold">1:</span> ${ep1}
                </div>
            `;
        }

        // EP 2-3, 4-6, 7-9...
        for (let i = 0; i < eps.length; i++) {
            if (!eps[i] || eps[i].trim() === "") continue; // ‚õî n√£o mostrar faixa vazia

            let faixaIni, faixaFim;

            if (i === 0) {
                faixaIni = 2;
                faixaFim = 3;
            } else {
                faixaIni = 4 + (i - 1) * 3;
                faixaFim = faixaIni + 2;
            }

            html += `
                <div class="px-2 py-1 bg-[#222] rounded-md border border-[#444]">
                    <span class="text-[#B9314F] font-bold">${faixaIni}-${faixaFim}:</span> ${eps[i]}
                </div>
            `;
        }

        // EP Final (s√≥ aparece se tiver nota)
        if (epf && epf !== "") {
            html += `
                <div class="px-2 py-1 bg-[#222] rounded-md border border-[#444]">
                    <span class="text-[#B9314F] font-bold">Final:</span> ${epf}
                </div>
            `;
        }

        html += `</div>`;
        box.innerHTML = html;
    }

    function faixaParaIndice(faixa) {
        const [ini, fim] = faixa.split("-").map(n => parseInt(n));

        if (ini === 2 && fim === 3) return 0;

        return 1 + Math.floor((ini - 4) / 3);
    }

    // Fun√ß√£o para alterar estado do anime
    async function alterarEstadoAnime() {
        // 1. Pegar o nome do anime que est√° aberto no modal
        const nomeAnime = document.getElementById("modal-nome").textContent.trim();
        
        // 2. Encontrar o objeto do anime no seu cache
        const anime = window.animeCache.find(item => item.NOME === nomeAnime);

        if (!anime) {
            console.error("Anime n√£o encontrado no cache.");
            return;
        }

        const estadoAtual = anime.ESTADO || "Indefinido";
        const estados = ["Completo", "Andamento", "Incompleto", "Assistido", "Desist√™ncia", "N. Come√ßado", "N. Assistido", "N. Lan√ßado", "N. Sei"];
        
        // Limpar container de informa√ß√µes adicionais
        const container = document.getElementById("info-adicional-container");
        container.innerHTML = '';
        
        // Criar interface de sele√ß√£o de estado
        const estadoInterface = document.createElement('div');
        estadoInterface.className = 'space-y-3';
        estadoInterface.innerHTML = `
            <h4 class="font-medium text-white flex items-center">
                <i data-lucide="settings" class="w-4 h-4 mr-2"></i>
                Alterar Estado
            </h4>
            <div class="space-y-3">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Novo Estado:</label>
                    <select id="novo-estado-select" 
                            class="w-full bg-[#2a2a2a] border border-gray-600 text-white rounded-lg px-3 py-2 focus:outline-none focus:border-[#B9314F]">
                        ${estados.map(estado => 
                            `<option value="${estado}" ${estado === estadoAtual ? 'selected' : ''}>${estado}</option>`
                        ).join('')}
                    </select>
                </div>
                <button id="confirmar-novo-estado" 
                        class="w-full bg-[#B9314F] hover:bg-[#992743] text-white font-medium py-2 px-4 rounded-lg transition-colors">
                    Atualizar Estado
                </button>
            </div>
        `;

        container.appendChild(estadoInterface);
        lucide.createIcons();
        
        // L√≥gica do bot√£o Salvar
        const btnConfirmar = document.getElementById("confirmar-novo-estado");
        const selectEstado = document.getElementById("novo-estado-select");
        
        btnConfirmar.addEventListener("click", async () => {
            const novoEstado = selectEstado.value;
            
            // Feedback visual de carregamento
            btnConfirmar.textContent = "Salvando...";
            btnConfirmar.disabled = true;

            try {
                if (!auth.currentUser) throw new Error("Usu√°rio n√£o logado");

                // 1. Buscar a refer√™ncia do documento no Firebase pelo NOME
                const animesRef = collection(db, "users", auth.currentUser.uid, "animes");
                const q = query(animesRef, where("NOME", "==", nomeAnime));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    throw new Error("Anime n√£o encontrado no banco de dados.");
                }

                // 2. Atualizar no Firebase (pega o primeiro doc encontrado)
                const docRef = querySnapshot.docs[0].ref;
                await updateDoc(docRef, { ESTADO: novoEstado });

                // 3. Atualizar no Cache local (para n√£o precisar recarregar a p√°gina)
                anime.ESTADO = novoEstado;

                // 4. Atualizar o texto no Visual
                const modalEstadoEl = document.getElementById("modal-estado");
                modalEstadoEl.textContent = novoEstado;

                // 5. Mensagem de sucesso
                adicionarInfoAdicional("Sucesso", `Estado alterado para "${novoEstado}"`);
                
                btnConfirmar.textContent = "Atualizar Estado";

            } catch (error) {
                console.error("Erro ao atualizar:", error);
                adicionarInfoAdicional("Erro", "Falha ao atualizar. Tente novamente.");
                btnConfirmar.textContent = "Tentar Novamente";
                btnConfirmar.disabled = false;
            }
        });
        
        console.log("üîÑ Interface de altera√ß√£o de estado criada");
    }

    async function mostrarOpenings() {
        const nomeAnime = document.getElementById("modal-nome").textContent.trim();
        const anime = window.animeCache.find(item => item.NOME === nomeAnime);

        if (!anime) return;

        const container = document.getElementById("info-adicional-container");
        container.innerHTML = '';
        const estilo = anime.ESTILO || "Anime";
        
        // Tratamento dos dados do cache (Campo OPENING: "m1,a1,m2,a2,m3,a3")
        let notasArray = ["", "", "", "", "", ""];
        if (anime.OPENING && typeof anime.OPENING === 'string') {
            const salvas = anime.OPENING.split(",");
            salvas.forEach((n, i) => { if(i < 6) notasArray[i] = n.trim(); });
        }

        // Unificando Anime Inf., Especial e Filme para n√£o exibirem campos
        if (estilo === "Especial" || estilo === "Filme" || estilo === "Anime Inf.") {
            container.innerHTML = `
                <div class="bg-[#2a2a2a] p-4 rounded-lg border border-gray-600 text-center animate-in fade-in duration-300">
                    <p class="text-sm text-gray-400 font-medium">Estilo "${estilo}" n√£o √© possivel dar nota para Openings.</p>
                </div>`;
            return;
        }

        // L√ìGICA PARA ANIME COMUM (Compacto)
        let inputsHTML = '';
        for (let i = 0; i < 3; i++) {
            inputsHTML += `
                <div class="flex items-center justify-between p-2 bg-neutral-900/50 rounded-lg border border-gray-800">
                    <span class="text-xs font-bold text-gray-500 w-8">OP${i+1}</span>
                    <div class="flex gap-2">
                        <div class="flex items-center gap-1">
                            <span class="text-[10px] text-gray-500 font-medium">M√∫s.</span>
                            <input type="number" id="op-m-${i}" value="${notasArray[i*2]}" min="1" max="5" 
                                class="w-10 bg-[#111] border border-gray-700 text-center text-white rounded py-1 text-xs focus:border-[#B9314F] outline-none">
                        </div>
                        <div class="flex items-center gap-1">
                            <span class="text-[10px] text-gray-500 font-medium">Anim.</span>
                            <input type="number" id="op-a-${i}" value="${notasArray[i*2+1]}" min="1" max="5" 
                                class="w-10 bg-[#111] border border-gray-700 text-center text-white rounded py-1 text-xs focus:border-[#B9314F] outline-none">
                        </div>
                    </div>
                </div>`;
        }

        container.innerHTML = `
            <div class="space-y-3 animate-in fade-in duration-300">
                <div class="flex justify-between items-end mb-1">
                    <h4 class="text-xs font-black uppercase tracking-tighter text-gray-400 flex items-center">
                        <i data-lucide="music" class="w-3 h-3 mr-1 text-[#B9314F]"></i> Notas de Openings
                    </h4>
                    <div class="text-right">
                        <p class="text-[9px] text-gray-500 font-bold leading-none uppercase">M√©dia Geral (OP)</p>
                        <span id="openings-nota-total" class="text-xl font-black text-[#B9314F]">${anime.OP || '0.00'}</span>
                    </div>
                </div>
                
                <div class="space-y-2">
                    ${inputsHTML}
                    <button id="confirmar-notas-op" class="w-full bg-[#B9314F] text-white text-xs font-bold py-3 rounded-lg mt-2 shadow-lg active:scale-95 transition-all">
                        SALVAR TODAS AS NOTAS
                    </button>
                </div>
            </div>`;

        lucide.createIcons();

        const btn = document.getElementById("confirmar-notas-op");
        btn.onclick = async function() {
            btn.disabled = true;
            btn.textContent = "PROCESSANDO...";

            try {
                let novasNotas = [];
                let soma = 0, contagem = 0;

                for (let i = 0; i < 3; i++) {
                    const m = document.getElementById(`op-m-${i}`).value;
                    const a = document.getElementById(`op-a-${i}`).value;
                    
                    novasNotas.push(m, a);
                    
                    if (m !== "" && !isNaN(m)) { soma += parseFloat(m); contagem++; }
                    if (a !== "" && !isNaN(a)) { soma += parseFloat(a); contagem++; }
                }

                const mediaFinal = contagem > 0 ? (soma / (contagem/2)) : 0;
                const stringOpening = novasNotas.join(",");

                // 1. Firebase
                const animesRef = collection(db, "users", auth.currentUser.uid, "animes");
                const q = query(animesRef, where("NOME", "==", nomeAnime));
                const snap = await getDocs(q);

                if (!snap.empty) {
                    await updateDoc(snap.docs[0].ref, {
                        OPENING: stringOpening,
                        OP: mediaFinal
                    });

                    // 2. Cache Local (window.animeCache + LocalStorage)
                    anime.OPENING = stringOpening;
                    anime.OP = mediaFinal;
                    const userId = auth.currentUser.uid;
                    localStorage.setItem(`animes_${userId}`, JSON.stringify(window.animeCache));

                    document.getElementById("openings-nota-total").textContent = mediaFinal;
                    btn.classList.replace("bg-[#B9314F]", "bg-green-600");
                    btn.textContent = "SALVO COM SUCESSO!";
                }
            } catch (e) {
                console.error(e);
                btn.textContent = "ERRO AO SALVAR";
            } finally {
                setTimeout(() => {
                    btn.classList.replace("bg-green-600", "bg-[#B9314F]");
                    btn.disabled = false;
                    btn.textContent = "SALVAR TODAS AS NOTAS";
                }, 2000);
            }
        };
    }

    // Tornar fun√ß√µes globais
    window.abrirModalAnime = abrirModalAnime;
    window.fecharModalAnime = fecharModalAnime;
    window.adicionarInfoAdicional = adicionarInfoAdicional;
    window.adicionarEpisodioAssistido = adicionarEpisodioAssistido;
    window.alterarEstadoAnime = alterarEstadoAnime;
    window.mostrarOpenings = mostrarOpenings;

    // Configurar eventos do modal quando DOM estiver pronto
    function setupModalEvents() {
        const modal = document.getElementById("anime-modal");

        const closeBtn = document.getElementById("anime-close-btn");

        if (closeBtn) {
            closeBtn.addEventListener("click", fecharModalAnime);
        } else {
            console.error("‚ùå Bot√£o de fechar n√£o encontrado");
        }

        if (modal) {
            modal.addEventListener("click", (e) => {
                if (e.target === modal) {
                    fecharModalAnime();
                }
            });
        } else {
            console.error("‚ùå Modal n√£o encontrado");
        }

        // Configurar eventos dos bot√µes de a√ß√£o
        const btnOpenings = document.getElementById("btn-openings");
        const btnEstado = document.getElementById("btn-estado");
        const btnEpisodio = document.getElementById("btn-episodio");

        if (btnOpenings) {
            btnOpenings.addEventListener("click", () => {
                console.log("üéµ Bot√£o Openings clicado");
                mostrarOpenings();
            });
        }

        if (btnEstado) {
            btnEstado.addEventListener("click", () => {
                console.log("üìä Bot√£o Estado clicado");
                alterarEstadoAnime();
            });
        }

        if (btnEpisodio) {
            btnEpisodio.addEventListener("click", () => {
                console.log("‚ûï Bot√£o +1 Ep clicado");
                adicionarEpisodioAssistido();
            });
        }
    }

    // Chamar quando DOM estiver pronto
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", setupModalEvents);
    } else {
        setupModalEvents();
    }

    function renderAnimeCards(lista) {        
        const grid = document.getElementById("anime-list-grid");
        if (!grid) {
            console.error("renderAnimeCards: #anime-list-grid n√£o encontrado.");
            return;
        }

        grid.innerHTML = "";

        if (!Array.isArray(lista) || lista.length === 0) {
            grid.innerHTML = `
                <div class="col-span-full text-center text-gray-400">
                    Nenhum anime encontrado.
                </div>`;
            return;
        }
        
        lista.forEach(anime => {            
            const nome = anime.NOME || "Sem nome";
            const imagem = anime.IMAGEM || "";
            const estilo = anime.ESTILO || "";
            const estado = anime.ESTADO || "";

            // ‚û§ NOVOS CAMPOS
            const ano = anime.ANO || "";
            const temporada = anime.TEMPORADA || "";
            const epAssistidos = anime.ASSIS || 0;
            const epTotais = anime.TOTAIS || 0;

            // Exibi√ß√£o de temporada
            let temporadaLabel = temporada;
            if (temporada === "1") temporadaLabel = "Inverno";
            else if (temporada === "4") temporadaLabel = "Primavera";
            else if (temporada === "7") temporadaLabel = "Ver√£o";
            else if (temporada === "10") temporadaLabel = "Outono";
            else if (temporada === "Outra") temporadaLabel = "Outra";

            const div = document.createElement("div");
            div.className =
                "anime-card cursor-pointer bg-[#151515] rounded-lg overflow-hidden shadow-md border border-[#2a2a2a]";
            div.setAttribute("data-nome", nome);

            div.innerHTML = `
                <div class="w-full h-40 overflow-hidden bg-[#111] flex items-center justify-center">
                    <img 
                        src="${imagem}"
                        class="w-full h-full object-cover rounded-lg"
                        onerror="
                            this.onerror=null;
                            this.src='';
                            this.removeAttribute('src');
                            this.closest('.img-box')?.classList.add('no-img');
                        "
                    />
                </div>

                <div class="p-3">

                    <!-- Nome -->
                    <h3 class="font-bold text-sm text-white truncate">${nome}</h3>

                    <!-- Ano + Temporada -->
                    <p class="text-xs text-gray-400">
                        ${estilo} ‚Ä¢ ${ano} ${temporadaLabel ? "‚Ä¢ " + temporadaLabel : ""}
                    </p>

                    <!-- Epis√≥dios -->
                    <p class="text-xs text-gray-400 mt-1">
                        Epis√≥dios: <span class="text-white">${epAssistidos}</span> / ${epTotais}
                    </p>

                    <!-- Estado -->
                    <p class="text-xs text-gray-500 mt-1">Estado: ${estado}</p>
                </div>
            `;

            div.addEventListener("click", (e) => {
                e.preventDefault();
                e.stopPropagation();
                const nomeAnime = div.getAttribute("data-nome");

                if (typeof window.abrirModalAnime === "function") {
                    window.abrirModalAnime(nomeAnime);
                } else {
                    console.error("‚ùå abrirModalAnime N√ÉO encontrada no window");
                    console.log("‚ùå window.abrirModalAnime:", window.abrirModalAnime);
                }
            });

            grid.appendChild(div);
        });
    }
    window.renderAnimeCards = renderAnimeCards;

    window.fecharModal = () => {
        document.getElementById("anime-modal").classList.add("hidden");
    };
    
    onAuthStateChanged(auth, async (user) => {        
        if (!user) {
            console.log("üîÑ Redirecionando para login...");
            window.location.href = "login.html";
            return;
        }

        document.getElementById("loading-indicator").classList.remove("hidden");
        document.getElementById("error-message").classList.add("hidden");

        try {
            // üì¶ Tenta pegar do Cache primeiro
            const cacheKey = `animes_${user.uid}`;
            const cachedData = localStorage.getItem(cacheKey);
            
            if (cachedData) {
                console.log("üì¶ Lista: Carregando dados do Cache Local");
                window.animeCache = JSON.parse(cachedData);
            } else {
                // üî• Se n√£o tiver cache, busca uma √∫nica vez no Firebase
                console.log("üî• Lista: Cache vazio, buscando no Firebase...");
                await carregarAnimesParaCache(); 
            }
                        
            if (!window.animeCache || window.animeCache.length === 0) {
                console.log("‚ö†Ô∏è Nenhum anime encontrado");
                document.getElementById("error-message").classList.remove("hidden");
            } else {
                // Renderiza a lista usando os dados que agora est√£o em window.animeCache
                await loadAnimeList("inacabados");
            }
            
        } catch (error) {
            console.error("‚ùå Erro ao carregar dados:", error);
            document.getElementById("error-message").classList.remove("hidden");
        } finally {
            document.getElementById("loading-indicator").classList.add("hidden");
        }

        if (user?.email) userEmailEl.textContent = user.email;
    });

    // Verifica√ß√£o final das fun√ß√µes
    document.addEventListener("DOMContentLoaded", () => {
        window.debugCache = () => {
            console.log("üîç Estado atual do animeCache:", window.animeCache);
            console.log("üîç Quantidade de animes:", window.animeCache?.length || 0);
            if (window.animeCache && window.animeCache.length > 0) {
                console.log("üîç Primeiros 3 animes:", window.animeCache.slice(0, 3));
            }
        };

        // Fun√ß√£o de teste manual
        window.testarModal = async () => {
            console.log("üß™ Verificando cache para teste...");
            window.debugCache();
            
            if (window.animeCache && window.animeCache.length > 0) {
                const primeiroAnime = window.animeCache[0];
                console.log("üß™ Testando modal com:", primeiroAnime.NOME);
                window.abrirModalAnime(primeiroAnime.NOME);
            } else {
                console.log("üß™ Nenhum anime no cache para testar");
                console.log("üß™ Tentando recarregar...");
                try {
                    await carregarAnimesParaCache();
                    console.log("üß™ Recarregamento conclu√≠do");
                    window.debugCache();
                    
                    if (window.animeCache && window.animeCache.length > 0) {
                        window.testarModal(); // Recursivo para tentar novamente
                    } else {
                        console.log("üß™ Ainda sem dados ap√≥s recarregamento");
                    }
                } catch (error) {
                    console.error("üß™ Erro ao recarregar:", error);
                }
            }
        };
    });
</script>

</body>
</html>
