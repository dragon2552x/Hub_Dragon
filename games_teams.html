<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Meus Times & Guildas — My Hub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
      /* Configurações Base Xbox / Gamer Minimalista */
      :root {
          --accent-color: #B9314F;
          --bg-dark: #0b0b0b;
          --bg-panel: #151515;
      }
      body {
          background-color: var(--bg-dark);
          color: #e6e6e6;
          font-family: 'Inter', system-ui, sans-serif;
          background-image: radial-gradient(circle at top right, rgba(185, 49, 79, 0.1), transparent 40%),
                            radial-gradient(circle at bottom left, rgba(20, 20, 20, 1), transparent 40%);
          min-height: 100vh;
      }

      .text-accent { color: var(--accent-color); }
      .bg-accent { background-color: var(--accent-color); }
      
      /* Painéis translúcidos */
      .glass-panel {
          background: rgba(21, 21, 21, 0.8);
          backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.05);
      }

      /* Cards com efeito Xbox */
      .task-card {
          background: rgba(30, 30, 30, 0.4);
          backdrop-filter: blur(12px);
          -webkit-backdrop-filter: blur(12px);
          border: 1px solid rgba(255, 255, 255, 0.05);
          transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
          box-shadow: 0 8px 16px -4px rgba(0, 0, 0, 0.4);
      }
      .task-card:hover {
          transform: translateY(-4px);
          background: rgba(40, 40, 40, 0.6);
          border-color: rgba(185, 49, 79, 0.3);
          box-shadow: 0 12px 24px -5px rgba(0, 0, 0, 0.6), 0 0 15px rgba(185, 49, 79, 0.1);
      }

      /* Inputs estilo Xbox */
      input, select, textarea {
          background: rgba(0, 0, 0, 0.4);
          border: 2px solid rgba(255, 255, 255, 0.1);
          transition: all 0.3s;
          color: white;
          color-scheme: dark;
      }
      input:focus, select:focus, textarea:focus {
          border-color: var(--accent-color);
          box-shadow: 0 0 0 3px rgba(185, 49, 79, 0.1);
          outline: none;
      }
      option { background-color: var(--bg-panel); color: #e6e6e6; padding: 10px; }

      /* Botões com efeito Xbox */
      .xbox-button { position: relative; overflow: hidden; transition: all 0.3s; }
      .xbox-button::before {
          content: ''; position: absolute; inset: 0;
          background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
          transform: translateX(-100%); transition: transform 0.6s;
      }
      .xbox-button:hover::before { transform: translateX(100%); }
      .xbox-button:hover { transform: scale(1.02); box-shadow: 0 0 20px rgba(185, 49, 79, 0.4); }

      /* Sidebar retrátil */
      .sidebar {
          position: fixed; left: 0; top: 0; bottom: 0; width: 80px;
          transform: translateX(0); transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); z-index: 50;
      }
      .sidebar.hidden { transform: translateX(-100%); }
      .main-content { margin-left: 80px; transition: margin-left 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
      .main-content.sidebar-hidden { margin-left: 0; }
      .toggle-sidebar-btn { transition: all 0.3s; }
      .toggle-sidebar-btn:hover { transform: scale(1.1); box-shadow: 0 0 15px rgba(185, 49, 79, 0.4); }

      /* Scrollbar customizada */
      .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
      .custom-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
      .custom-scroll::-webkit-scrollbar-thumb:hover { background: var(--accent-color); }
      .custom-scroll::-webkit-scrollbar-track { background: var(--bg-dark); }

      .avatar-fallback-container { display: flex; align-items: center; justify-content: center; background-color: #262626; color: #a3a3a3; font-weight: bold; text-transform: uppercase; user-select: none; }

      /* --- VISUALIZADOR DE FUTEBOL (PRANCHETA TÁTICA) --- */
      .soccer-field-container { background: radial-gradient(circle, #1a1a1a 0%, #0b0b0b 100%); position: relative; width: 100%; height: 100%; border-radius: 12px; overflow: hidden; box-shadow: inset 0 0 40px rgba(0,0,0,0.9), 0 10px 30px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.05); }
      .pitch-lines { position: absolute; inset: 4%; border: 2px solid rgba(185, 49, 79, 0.3); pointer-events: none; border-radius: 6px; }
      .pitch-lines::before { content: ''; position: absolute; top: 50%; left: 0; right: 0; height: 2px; background: rgba(185, 49, 79, 0.3); transform: translateY(-50%); }
      .pitch-lines::after { content: ''; position: absolute; top: 50%; left: 50%; width: 25%; aspect-ratio: 1/1; border: 2px solid rgba(185, 49, 79, 0.3); border-radius: 50%; transform: translate(-50%, -50%); }
      .goal-area-top { position: absolute; top: 4%; left: 50%; transform: translateX(-50%); width: 45%; height: 14%; border: 2px solid rgba(185, 49, 79, 0.3); border-top: none; }
      .goal-area-bottom { position: absolute; bottom: 4%; left: 50%; transform: translateX(-50%); width: 45%; height: 14%; border: 2px solid rgba(185, 49, 79, 0.3); border-bottom: none; }

      .player-token { position: absolute; transform: translate(-50%, -50%); display: flex; flex-direction: column; align-items: center; z-index: 10; cursor: default; width: 15%; max-width: 80px; min-width: 45px; }
      .player-token:hover { z-index: 20; transform: translate(-50%, -55%) scale(1.1); transition: all 0.2s; }
      .token-img-wrapper { width: 100%; aspect-ratio: 1 / 1; border-radius: 50%; border: 2px solid var(--accent-color); box-shadow: 0 4px 15px rgba(185, 49, 79, 0.3); overflow: hidden; background: #222; margin-bottom: 4px; position: relative; display: flex; align-items: center; justify-content: center; }
      .token-img-wrapper img { width: 100%; height: 100%; object-fit: cover; }
      .token-img-wrapper .avatar-fallback-container { width: 100%; height: 100%; font-size: clamp(12px, 3vw, 24px); }
      .token-info { text-align: center; background: rgba(21, 21, 21, 0.9); padding: 3px 6px; border-radius: 6px; border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(4px); width: max-content; max-width: 150%; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
      .token-name { font-size: clamp(9px, 2vw, 12px); color: white; font-weight: 700; line-height: 1.1; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .token-pos { font-size: clamp(7px, 1.5vw, 9px); color: var(--accent-color); font-weight: 800; text-transform: uppercase; line-height: 1; letter-spacing: 0.5px; }

      /* --- VISUALIZADOR GERAL (CARDS RETRATO) --- */
      .portrait-card {
          background: rgba(21, 21, 21, 0.8);
          border: 1px solid rgba(255, 255, 255, 0.05);
          border-radius: 12px;
          overflow: hidden;
          position: relative;
          aspect-ratio: 2 / 3; /* Formato retrato perfeito */
          box-shadow: 0 8px 20px -5px rgba(0, 0, 0, 0.5);
          transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
          cursor: pointer;
      }
      .portrait-card:hover {
          transform: translateY(-8px);
          border-color: rgba(185, 49, 79, 0.4);
          box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.7), 0 0 20px rgba(185, 49, 79, 0.2);
      }
      .portrait-img {
          width: 100%;
          height: 100%;
          object-fit: cover;
          transition: transform 0.5s ease;
      }
      .portrait-card:hover .portrait-img {
          transform: scale(1.05); /* Zoom sutil na imagem ao passar o mouse */
      }
      .portrait-overlay {
          position: absolute;
          inset: 0;
          background: linear-gradient(to top, rgba(11, 11, 11, 1) 0%, rgba(11, 11, 11, 0.5) 40%, transparent 100%);
          display: flex;
          flex-direction: column;
          justify-content: flex-end;
          padding: 16px;
          transition: opacity 0.3s ease;
      }
      .portrait-obs-panel {
          position: absolute;
          inset: 0;
          background: rgba(11, 11, 11, 0.95);
          backdrop-filter: blur(8px);
          -webkit-backdrop-filter: blur(8px);
          padding: 20px;
          display: flex;
          flex-direction: column;
          opacity: 0;
          pointer-events: none;
          transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
          transform: translateY(20px);
      }
      /* Efeito quando o card é clicado */
      .portrait-card.show-obs .portrait-obs-panel {
          opacity: 1;
          pointer-events: auto;
          transform: translateY(0);
      }
      .portrait-card.show-obs .portrait-overlay {
          opacity: 0;
      }
  </style>
</head>
<body class="flex h-screen overflow-hidden custom-scroll">

  <!-- OVERLAY DE CARREGAMENTO -->
  <div id="loading" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm">
    <div class="flex flex-col items-center">
      <div class="animate-spin h-12 w-12 border-4 border-t-transparent border-[#B9314F] rounded-full mb-4"></div>
      <p class="text-gray-400 font-bold tracking-widest text-sm uppercase">Carregando...</p>
    </div>
  </div>

  <!-- SIDEBAR RETRÁTIL -->
  <aside id="sidebar" class="sidebar flex flex-col w-20 bg-[#121212] border-r border-white/10 items-center py-6 flex-shrink-0 glass-panel">
      <div class="text-accent mb-8">
          <i data-lucide="sparkle" class="w-10 h-10"></i>
      </div>
      
      <nav class="flex flex-col gap-3 md:gap-6 items-center flex-1">
          <a href="home.html" class="text-gray-500 hover:text-gray-200 p-1.5 md:p-2 hover:bg-white/5 rounded-xl transition" title="Home">
              <i data-lucide="home" class="w-5 h-5 md:w-7 md:h-7"></i>
          </a>

          <!-- Games está ativo e é a raiz para Times, mas deixaremos como link sutil se quiser voltar -->
          <a href="games_manager.html" class="text-accent p-1.5 md:p-2 bg-white/5 rounded-xl transition shadow-[0_0_15px_rgba(185,49,79,0.2)]" title="Games / Times">
              <i data-lucide="gamepad-2" class="w-5 h-5 md:w-7 md:h-7"></i>
          </a>

          <a href="animes_manager.html" class="text-gray-500 hover:text-gray-200 p-1.5 md:p-2 hover:bg-white/5 rounded-xl transition" title="Animes">
              <i data-lucide="tv" class="w-5 h-5 md:w-7 md:h-7"></i>
          </a>

          <a href="cards_manager.html" class="text-gray-500 hover:text-gray-200 p-1.5 md:p-2 hover:bg-white/5 rounded-xl transition" title="Cards">
              <i data-lucide="layers" class="w-5 h-5 md:w-7 md:h-7"></i>
          </a>

          <a href="hqs_manager.html" class="text-gray-500 hover:text-gray-200 p-1.5 md:p-2 hover:bg-white/5 rounded-xl transition" title="HQs">
              <i data-lucide="book-open-text" class="w-5 h-5 md:w-7 md:h-7"></i>
          </a>

          <a href="manga_manager.html" class="text-gray-500 hover:text-gray-200 p-1.5 md:p-2 hover:bg-white/5 rounded-xl transition" title="Mangás">
              <i data-lucide="notebook-text" class="w-5 h-5 md:w-7 md:h-7"></i>
          </a>

          <a href="manhwa_manager.html" class="text-gray-500 hover:text-gray-200 p-1.5 md:p-2 hover:bg-white/5 rounded-xl transition" title="Manhwas">
              <i data-lucide="smartphone" class="w-5 h-5 md:w-7 md:h-7"></i>
          </a>

          <a href="academia_exercicios.html" class="text-gray-500 hover:text-gray-200 p-1.5 md:p-2 hover:bg-white/5 rounded-xl transition" title="Academia">
              <i data-lucide="dumbbell" class="w-5 h-5 md:w-7 md:h-7"></i>
          </a>

          <a href="to_do.html" class="text-gray-500 hover:text-gray-200 p-1.5 md:p-2 hover:bg-white/5 rounded-xl transition" title="To Do">
              <i data-lucide="check-square" class="w-5 h-5 md:w-7 md:h-7"></i>
          </a>
      </nav>

      <button id="logout-btn" class="mt-auto text-red-500 hover:text-red-400 p-1.5 md:p-2 hover:bg-red-500/10 rounded-xl transition" title="Sair">
          <i data-lucide="log-out" class="w-5 h-5 md:w-7 md:h-7"></i>
      </button>
  </aside>

  <!-- CONTEÚDO PRINCIPAL -->
  <main id="main-content" class="main-content flex-1 flex flex-col overflow-hidden relative">
      
      <!-- HEADER -->
      <header class="flex justify-between items-center p-6 md:px-8 bg-transparent z-10 border-b border-white/5">
          <div class="flex items-center gap-3">
              <button id="toggle-sidebar" class="toggle-sidebar-btn p-2 bg-white/5 hover:bg-white/10 rounded-xl text-gray-400 hover:text-accent transition" title="Mostrar/Ocultar Menu">
                  <i data-lucide="menu" class="w-5 h-5"></i>
              </button>
              <div>
                  <h2 class="text-2xl md:text-3xl font-bold text-white flex items-center gap-3">
                      <i data-lucide="users" class="text-accent"></i> Gestão de Times
                  </h2>
              </div>
          </div>
          <div class="hidden sm:block text-sm text-gray-400 bg-white/5 px-4 py-2 rounded-xl border border-white/5">
              Usuário: <span id="user-display" class="text-accent font-mono font-bold">...</span>
          </div>
      </header>

      <!-- ÁREA DE CONTEÚDO -->
      <div id="app" class="flex-1 overflow-y-auto p-6 md:px-8 pb-8 custom-scroll hidden">
          <div class="max-w-6xl mx-auto">
              
              <!-- AÇÕES TOPO E FILTROS -->
              <div class="glass-panel p-6 rounded-2xl mb-6">
                  <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
                      <button id="add-btn" class="xbox-button w-full sm:w-auto bg-accent text-white px-6 py-2.5 rounded-xl font-bold flex items-center justify-center gap-2">
                          <i data-lucide="plus-circle" class="w-5 h-5"></i> Novo Time
                      </button>
                  </div>
                  
                  <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
                      <div class="md:col-span-8 relative">
                          <i data-lucide="search" class="absolute left-4 top-3.5 w-5 h-5 text-gray-500"></i>
                          <input id="search-input" type="text" placeholder="Buscar time..." class="w-full pl-12 pr-4 py-3 rounded-xl bg-black/40 border-white/10 text-white focus:border-accent outline-none">
                      </div>
                      <div class="md:col-span-4">
                          <select id="filter-type" class="w-full py-3 px-4 rounded-xl bg-black/40 border border-white/10 text-white focus:border-accent outline-none">
                              <option value="">Todos os Tipos</option>
                              <option value="Pokemon Principal">Pokemon Principal</option>
                              <option value="Pokemon Fazenda">Pokemon Fazenda</option>
                              <option value="Digimon">Digimon</option>
                              <option value="Futebol">Futebol</option>
                              <option value="Geral">Geral</option>
                          </select>
                      </div>
                  </div>
              </div>

              <!-- LISTA DE CARDS -->
              <div id="cards-container" class="flex flex-col gap-4 pb-20"></div>
              
              <div id="empty-state" class="hidden text-center py-20">
                  <i data-lucide="ghost" class="w-16 h-16 mx-auto mb-4 opacity-20 text-gray-500"></i>
                  <p class="text-lg text-gray-500 font-semibold">Nenhum time encontrado.</p>
              </div>

          </div>
      </div>

      <!-- BOTÃO FLUTUANTE (GAMES) -->
      <a href="games_manager.html" class="fixed bottom-24 sm:bottom-8 right-4 sm:right-8 xbox-button bg-accent hover:bg-[#99233b] text-white p-3.5 sm:p-4 rounded-full shadow-[0_0_20px_rgba(185,49,79,0.5)] border border-white/10 z-50 flex items-center justify-center gap-2 group" title="Voltar para Games">
          <i data-lucide="gamepad-2" class="w-6 h-6"></i>
          <span class="max-w-0 overflow-hidden whitespace-nowrap group-hover:max-w-xs transition-all duration-300 font-bold text-sm">Games</span>
      </a>

  </main>

  <!-- MODAL DE TIME (NOVO/EDITAR) -->
  <div id="modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50 p-4 overflow-hidden">
    <div class="glass-panel rounded-2xl w-full max-w-lg shadow-2xl relative flex flex-col border border-white/10 max-h-[90vh]">
      <div class="flex justify-between items-center p-6 border-b border-white/5">
        <h2 class="text-xl font-bold text-white flex items-center gap-2">
            <i data-lucide="shield" class="text-accent"></i> <span id="modal-title-text">Time</span>
        </h2>
        <button id="close-modal" class="text-gray-500 hover:text-white transition bg-white/5 p-2 rounded-xl hover:bg-white/10">
            <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      
      <form id="team-form" class="p-6 space-y-4 overflow-y-auto custom-scroll">
        <input type="hidden" id="team-id">
        <div>
            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nome</label>
            <input id="team-name" type="text" class="w-full px-4 py-3 rounded-xl bg-black/40 border-2 border-white/10 text-white focus:border-accent transition" required>
        </div>
        <div>
            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Jogo</label>
            <input id="team-game" list="games-list" type="text" class="w-full px-4 py-3 rounded-xl bg-black/40 border-2 border-white/10 text-white focus:border-accent transition" required>
            <datalist id="games-list"></datalist>
        </div>
        <div>
            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tipo</label>
            <select id="team-type" class="w-full px-4 py-3 rounded-xl bg-black/40 border-2 border-white/10 text-white focus:border-accent transition">
                <option value="Geral">Geral</option>
                <option value="Pokemon Principal">Pokemon Principal</option>
                <option value="Pokemon Fazenda">Pokemon Fazenda</option>
                <option value="Digimon">Digimon</option>
                <option value="Futebol">Futebol</option>
            </select>
        </div>
        <div>
            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Banner (URL)</label>
            <input id="team-img" type="url" class="w-full px-4 py-3 rounded-xl bg-black/40 border-2 border-white/10 text-white focus:border-accent transition">
        </div>
        
        <div class="flex items-center justify-between pt-4 mt-4 border-t border-white/5">
            <button id="delete-btn" type="button" class="hidden px-4 py-3 rounded-xl bg-red-500/10 text-red-500 hover:bg-red-500/20 font-bold transition flex items-center justify-center" title="Excluir">
                <i data-lucide="trash-2" class="w-5 h-5"></i> Excluir
            </button>
            <button type="submit" class="xbox-button px-6 py-3 rounded-xl bg-accent text-white font-bold ml-auto flex items-center gap-2">
                <i data-lucide="save" class="w-5 h-5"></i> Salvar
            </button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL DE INTEGRANTES -->
  <div id="members-modal" class="fixed inset-0 bg-black/90 backdrop-blur-md hidden items-center justify-center z-[60] p-2 sm:p-4">
    <div class="glass-panel border border-white/10 rounded-2xl w-full max-w-5xl h-[90vh] shadow-2xl relative flex flex-col md:flex-row overflow-hidden">
        
        <!-- Lista de Integrantes (Esquerda) -->
        <div class="w-full md:w-80 border-b md:border-b-0 md:border-r border-white/5 flex flex-col bg-black/40 shrink-0">
            <div class="p-4 border-b border-white/5 bg-white/5">
                <h3 class="font-bold text-white text-sm flex items-center gap-2"><i data-lucide="users" class="w-4 h-4 text-accent"></i> Integrantes</h3>
                <p id="member-team-name" class="text-[10px] font-mono text-gray-500 uppercase tracking-widest truncate mt-1">-</p>
            </div>
            
            <!-- NOVO: Container da Formação Tática -->
            <div id="team-formation-container" class="px-4 py-3 border-b border-white/5 bg-black/60 hidden">
                <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1 flex items-center gap-1"><i data-lucide="layout-template" class="w-3 h-3 text-accent"></i> Formação Tática do Time</label>
                <select id="team-formation-select" class="w-full px-3 py-2 rounded-xl bg-black/40 border border-white/10 text-white text-xs focus:border-accent outline-none transition"></select>
            </div>
            
            <div id="members-list" class="flex-1 overflow-y-auto p-2 space-y-2 custom-scroll"></div>
            <div class="p-3 border-t border-white/5 bg-white/5">
                <button onclick="prepareNewMember()" class="xbox-button w-full py-2.5 bg-accent/20 border border-white/10 hover:bg-accent text-white rounded-xl transition text-xs font-bold flex items-center justify-center gap-2">
                    <i data-lucide="plus" class="w-4 h-4"></i> Novo Integrante
                </button>
            </div>
        </div>
        
        <!-- Formulário do Integrante (Direita) -->
        <div class="flex-1 flex flex-col bg-transparent relative min-h-0">
            <div class="p-4 border-b border-white/5 flex justify-between items-center shrink-0">
                <h3 id="member-form-title" class="font-bold text-white text-sm uppercase tracking-widest">Adicionar / Editar</h3>
                <button onclick="closeMembersModal()" class="text-gray-400 hover:text-white bg-white/5 p-2 rounded-xl hover:bg-white/10 transition">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            <div id="member-form-container" class="flex-1 overflow-y-auto p-4 md:p-6 hidden custom-scroll">
                <form id="member-form" class="space-y-4 max-w-lg mx-auto pb-4">
                    <input type="hidden" id="member-id">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nome</label>
                        <input id="member-name" type="text" class="w-full px-4 py-3 rounded-xl bg-black/40 border-2 border-white/10 text-white focus:border-accent transition" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Avatar (URL)</label>
                        <input id="member-avatar" type="url" class="w-full px-4 py-3 rounded-xl bg-black/40 border-2 border-white/10 text-white focus:border-accent transition">
                        <p class="text-[10px] text-gray-500 mt-1">Se falhar, usaremos a inicial.</p>
                    </div>
                    
                    <div id="dynamic-fields" class="p-4 bg-white/5 rounded-xl border border-white/10 space-y-4"></div>
                    
                    <div class="flex justify-between items-center pt-4 mt-2 border-t border-white/5">
                        <button type="button" id="btn-delete-member" class="px-4 py-3 rounded-xl bg-red-500/10 text-red-500 hover:bg-red-500/20 font-bold transition text-xs uppercase hidden">Excluir</button>
                        <button type="submit" class="xbox-button px-6 py-3 rounded-xl bg-accent text-white font-bold ml-auto shadow-lg text-sm">Salvar</button>
                    </div>
                </form>
            </div>
            
            <div id="member-empty-state" class="flex-1 flex flex-col items-center justify-center text-gray-600 p-10">
                <i data-lucide="user-plus" class="w-16 h-16 mb-4 opacity-20 text-accent"></i>
                <p class="text-sm text-center font-bold">Selecione ou crie um novo integrante.</p>
            </div>
        </div>
    </div>
  </div>

  <!-- VISUALIZADORES (MANTIDOS E APENAS COM CLASSES ATUALIZADAS NO HEADER) -->
  <div id="soccer-visualizer-modal" class="fixed inset-0 bg-black/95 hidden z-[70] flex flex-col backdrop-blur-md">
      <div class="glass-panel border-b border-white/5 p-4 flex justify-between items-center shrink-0 z-10 shadow-xl">
          <div class="flex items-center gap-4">
              <h3 class="text-white font-bold flex items-center gap-2 uppercase tracking-widest text-sm"><i data-lucide="layout-template" class="text-accent"></i> Prancheta Tática</h3>
              <span id="current-formation-display" class="bg-accent/10 text-accent text-xs px-3 py-1 rounded-full border border-accent/20 font-mono font-bold shadow-sm"></span>
          </div>
          <button onclick="closeSoccerVisualizer()" class="bg-white/5 p-2 rounded-xl text-gray-400 hover:text-white transition hover:bg-white/10 border border-transparent hover:border-white/10"><i data-lucide="x" class="w-5 h-5"></i></button>
      </div>
      <div class="flex-1 flex overflow-hidden relative">
          <div class="flex-1 bg-transparent flex items-center justify-center p-2 sm:p-6 overflow-hidden relative">
              <button id="toggle-sidebar-btn" onclick="toggleSoccerSidebar()" class="absolute right-0 top-1/2 -translate-y-1/2 z-40 bg-white/10 border-l border-y border-white/20 text-gray-300 hover:text-accent hover:bg-white/20 p-2 rounded-l-xl shadow-lg transition-colors h-16 flex items-center justify-center backdrop-blur">
                  <i data-lucide="chevron-left" class="w-5 h-5"></i>
              </button>
              <!-- Container dimensionável e responsivo para o campo -->
              <div class="relative h-full w-full max-w-2xl aspect-[3/5] transition-all duration-300 flex items-center justify-center">
                  <div id="soccer-field" class="soccer-field-container">
                      <div class="pitch-lines"></div>
                      <div class="goal-area-top"></div>
                      <div class="goal-area-bottom"></div>
                      <div id="field-players-container" class="absolute inset-0"></div>
                  </div>
              </div>
          </div>
          <!-- Sidebar vem recolhida (w-0 e opacity-0) -->
          <div id="soccer-sidebar" class="w-0 opacity-0 border-l-0 border-white/5 flex flex-col shrink-0 transition-all duration-300 ease-in-out overflow-hidden z-10 glass-panel shadow-[-10px_0_30px_rgba(0,0,0,0.5)]">
              <div class="flex-1 flex flex-col p-4 border-b border-white/5 overflow-hidden bg-black/20">
                  <h4 class="text-xs font-bold text-gray-500 uppercase mb-3 flex items-center gap-1"><i data-lucide="users" class="w-3 h-3 text-accent"></i> Reservas</h4>
                  <div id="subs-list" class="space-y-2 overflow-y-auto custom-scroll pr-1 flex-1"></div>
                  <div id="subs-overflow" class="hidden mt-2 text-center text-xs font-bold text-accent p-2 bg-accent/10 rounded-xl border border-accent/20">+X Jogadores</div>
              </div>
              <div class="h-1/3 p-4 bg-black/40 flex flex-col overflow-hidden">
                  <h4 class="text-xs font-bold text-gray-500 uppercase mb-3 flex items-center gap-1"><i data-lucide="clipboard" class="w-3 h-3 text-blue-400"></i> Comissão</h4>
                  <div id="coaches-list" class="space-y-2 overflow-y-auto custom-scroll pr-1"></div>
              </div>
          </div>
      </div>
  </div>

  <div id="general-visualizer-modal" class="fixed inset-0 bg-black/95 hidden z-[70] flex flex-col overflow-hidden backdrop-blur-md">
      <div class="relative z-10 p-4 flex justify-between items-center glass-panel border-b border-white/5 shadow-xl">
          <div class="flex items-center gap-3">
              <div class="bg-accent/10 text-accent p-2.5 rounded-xl shadow-[0_0_15px_rgba(185,49,79,0.3)] border border-accent/30">
                  <i data-lucide="library" class="w-6 h-6"></i>
              </div>
              <div>
                  <h2 id="gen-viz-title" class="text-xl font-bold text-white tracking-widest uppercase truncate max-w-[200px] sm:max-w-md">Nome do Time</h2>
                  <p class="text-[10px] text-gray-400 uppercase font-mono tracking-widest">Coleção de Membros</p>
              </div>
          </div>
          <button onclick="closeGeneralVisualizer()" class="text-gray-400 hover:text-white bg-white/5 hover:bg-white/10 p-3 rounded-xl transition border border-white/5">
              <i data-lucide="x" class="w-6 h-6"></i>
          </button>
      </div>
      <!-- Fundo com grid sutil vermelho -->
      <div class="absolute inset-0 z-0 opacity-[0.03] pointer-events-none" style="background-image: radial-gradient(#B9314F 2px, transparent 2px); background-size: 30px 30px;"></div>
      
      <div class="flex-1 overflow-y-auto custom-scroll z-0 py-8 px-4 sm:px-10">
          <div id="general-cards-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6 max-w-[90rem] mx-auto pb-20"></div>
      </div>
  </div>

  <div id="pokemon-visualizer-modal" class="fixed inset-0 bg-black/95 hidden z-[70] flex flex-col overflow-hidden backdrop-blur-md">
      <div class="relative z-10 p-4 flex justify-between items-center glass-panel border-b border-white/5 shadow-xl">
          <div class="flex items-center gap-3">
              <div class="bg-accent/10 text-accent p-2.5 rounded-xl shadow-[0_0_15px_rgba(185,49,79,0.3)] border border-accent/30">
                  <i data-lucide="trophy" class="w-6 h-6"></i>
              </div>
              <div>
                  <h2 id="poke-viz-title" class="text-xl font-bold text-white tracking-widest uppercase truncate max-w-[200px] sm:max-w-md">Hall of Fame</h2>
                  <p class="text-[10px] text-gray-400 uppercase font-mono tracking-widest">Registro de Campeão</p>
              </div>
          </div>
          <button onclick="closePokemonVisualizer()" class="text-gray-400 hover:text-white bg-white/5 hover:bg-white/10 p-3 rounded-xl transition border border-white/5">
              <i data-lucide="x" class="w-6 h-6"></i>
          </button>
      </div>
      
      <div class="flex-1 overflow-y-auto custom-scroll relative bg-transparent">
          <!-- Fundo de grid sutil padronizado -->
          <div class="absolute inset-0 opacity-[0.03] pointer-events-none" style="background-image: radial-gradient(#B9314F 2px, transparent 2px); background-size: 30px 30px;"></div>
          
          <div class="container mx-auto px-4 py-8 relative z-0 flex flex-col items-center gap-12 max-w-7xl">
              <div class="w-full max-w-4xl">
                  <div class="flex items-center gap-4 mb-8">
                      <div class="h-[1px] flex-1 bg-gradient-to-l from-accent/50 to-transparent"></div>
                      <h3 class="text-center text-accent font-bold text-sm sm:text-base uppercase tracking-[0.3em]">Time Principal</h3>
                      <div class="h-[1px] flex-1 bg-gradient-to-r from-accent/50 to-transparent"></div>
                  </div>
                  <div id="poke-main-grid" class="grid grid-cols-2 md:grid-cols-3 gap-y-12 gap-x-6 sm:gap-x-8 justify-items-center"></div>
              </div>
              
              <div id="poke-extra-container" class="w-full max-w-5xl hidden mt-8">
                  <div class="flex items-center gap-4 mb-8">
                      <div class="h-[1px] flex-1 bg-gradient-to-l from-white/20 to-transparent"></div>
                      <h3 class="text-center text-gray-500 font-bold text-xs sm:text-sm uppercase tracking-[0.3em]">Caixa / Histórico</h3>
                      <div class="h-[1px] flex-1 bg-gradient-to-r from-white/20 to-transparent"></div>
                  </div>
                  <div id="poke-extra-grid" class="flex flex-wrap justify-center gap-6"></div>
              </div>
          </div>
      </div>
  </div>

  <div id="pokemon-farm-modal" class="fixed inset-0 bg-black/95 hidden z-[70] flex flex-col overflow-hidden backdrop-blur-md">
      <div class="relative z-10 p-4 flex justify-between items-center glass-panel border-b border-white/5 shadow-xl">
          <div class="flex items-center gap-3">
              <div class="bg-accent/10 text-accent p-2.5 rounded-xl shadow-[0_0_15px_rgba(185,49,79,0.3)] border border-accent/30">
                  <i data-lucide="sprout" class="w-6 h-6"></i>
              </div>
              <div>
                  <h2 id="farm-viz-title" class="text-xl font-bold text-white tracking-widest uppercase truncate max-w-[200px] sm:max-w-md">Minha Fazenda</h2>
                  <p class="text-[10px] text-gray-400 uppercase font-mono tracking-widest">Coleção Agrupada</p>
              </div>
          </div>
          <button onclick="closeFarmVisualizer()" class="text-gray-400 hover:text-white bg-white/5 hover:bg-white/10 p-3 rounded-xl transition border border-white/5">
              <i data-lucide="x" class="w-6 h-6"></i>
          </button>
      </div>
      <div class="flex-1 overflow-y-auto custom-scroll relative bg-transparent">
          <!-- Fundo de grid sutil padronizado com as outras telas -->
          <div class="absolute inset-0 opacity-[0.03] pointer-events-none" style="background-image: radial-gradient(#B9314F 2px, transparent 2px); background-size: 30px 30px;"></div>
          
          <div class="container mx-auto px-4 py-8 relative z-0">
              <div id="farm-groups-container" class="flex flex-col gap-12 pb-20 max-w-7xl mx-auto"></div>
          </div>
      </div>
  </div>

  <div id="digimon-visualizer-modal" class="fixed inset-0 bg-black/95 hidden z-[70] flex flex-col overflow-hidden backdrop-blur-md">
      <div class="relative z-10 p-4 flex justify-between items-center glass-panel border-b border-white/5 shadow-xl">
          <div class="flex items-center gap-3">
              <div class="bg-accent/10 text-accent p-2.5 rounded-xl shadow-[0_0_15px_rgba(185,49,79,0.3)] border border-accent/30">
                  <i data-lucide="cpu" class="w-6 h-6"></i>
              </div>
              <div>
                  <h2 id="digi-viz-title" class="text-xl font-bold text-white tracking-[0.3em] uppercase font-mono">Digivice</h2>
                  <p class="text-[10px] text-gray-400 uppercase font-mono tracking-widest">Digital Monster DB</p>
              </div>
          </div>
          <button onclick="closeDigimonVisualizer()" class="text-gray-400 hover:text-white bg-white/5 hover:bg-white/10 p-3 rounded-xl transition border border-white/5">
              <i data-lucide="x" class="w-6 h-6"></i>
          </button>
      </div>
      <div class="flex-1 overflow-y-auto custom-scroll relative bg-transparent">
          <div class="absolute inset-0 opacity-10 pointer-events-none" style="background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 40px 40px;"></div>
          <div class="container mx-auto px-4 py-8 relative z-0 flex flex-col gap-10">
              <div id="digimon-groups-container" class="space-y-12 pb-20"></div>
          </div>
      </div>
  </div>

  <!-- SCRIPT UI / SIDEBAR -->
  <script>
      lucide.createIcons();
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('main-content');
      const toggleBtn = document.getElementById('toggle-sidebar');
      toggleBtn.addEventListener('click', () => {
          sidebar.classList.toggle('hidden');
          mainContent.classList.toggle('sidebar-hidden');
      });
  </script>

  <!-- FIREBASE E LÓGICA CORE -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, query, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    /* Configuração Táticas, Tipos Pokemon e Digimon (Inalterado) */
    const TACTICS_CONFIG = {
        '4-3-3': { 'Goleiro':[{t:92,l:50}], 'Zagueiro':[{t:80,l:30},{t:80,l:70}], 'Lateral':[{t:75,l:10},{t:75,l:90}], 'Volante':[{t:60,l:50}], 'Meia':[{t:50,l:30},{t:50,l:70}], 'Atacante':[{t:25,l:15},{t:20,l:50},{t:25,l:85}] },
        '3-5-2': { 'Goleiro':[{t:92,l:50}], 'Zagueiro':[{t:75,l:50}], 'Lateral':[{t:75,l:25},{t:75,l:75}], 'Volante':[{t:60,l:50}], 'Meia':[{t:50,l:30},{t:50,l:70}, {t:35,l:20},{t:35,l:80}], 'Atacante':[{t:15,l:30},{t:15,l:70}] },
        '4-4-2': { 'Goleiro':[{t:92,l:50}], 'Zagueiro':[{t:80,l:35},{t:80,l:65}], 'Lateral':[{t:75,l:10},{t:75,l:90}], 'Volante':[{t:60,l:40},{t:60,l:60}], 'Meia':[{t:45,l:15},{t:45,l:85}], 'Atacante':[{t:20,l:35},{t:20,l:65}] }
    };

    const POKE_TYPES = ['Normal', 'Fire', 'Water', 'Grass', 'Electric', 'Ice', 'Fighting', 'Poison', 'Ground', 'Flying', 'Psychic', 'Bug', 'Rock', 'Ghost', 'Dragon', 'Steel', 'Dark', 'Fairy'];
    const TYPE_COLORS = { Normal: '#A8A77A', Fire: '#EE8130', Water: '#6390F0', Electric: '#F7D02C', Grass: '#7AC74C', Ice: '#96D9D6', Fighting: '#C22E28', Poison: '#A33EA1', Ground: '#E2BF65', Flying: '#A98FF3', Psychic: '#F95587', Bug: '#A6B91A', Rock: '#B6A136', Ghost: '#735797', Dragon: '#6F35FC', Steel: '#B7B7CE', Dark: '#705746', Fairy: '#D685AD', None: '#333333' };

    const DIGI_TYPES = { 'Vaccine': { color: '#00B5E2', icon: 'shield-check', label: 'Vacina' }, 'Virus': { color: '#9d4dbb', icon: 'skull', label: 'Vírus' }, 'Data': { color: '#EAB308', icon: 'database', label: 'Dados' }, 'Free': { color: '#22C55E', icon: 'circle-dashed', label: 'Livre' } };
    const DIGI_ATTRS = { 'Fire': { color: '#EF4444', icon: 'flame', label: 'Fogo' }, 'Water': { color: '#3B82F6', icon: 'droplet', label: 'Água' }, 'Plant': { color: '#4ADE80', icon: 'leaf', label: 'Planta' }, 'Electric': { color: '#FACC15', icon: 'zap', label: 'Elétrico' }, 'Earth': { color: '#A16207', icon: 'mountain', label: 'Terra' }, 'Wind': { color: '#2DD4BF', icon: 'wind', label: 'Vento' }, 'Light': { color: '#FEF08A', icon: 'sun', label: 'Luz' }, 'Dark': { color: '#581C87', icon: 'moon', label: 'Trevas' }, 'Steel': { color: '#94A3B8', icon: 'wrench', label: 'Metal' }, 'Neutral': { color: '#737373', icon: 'circle', label: 'Neutro' } };

    const firebaseConfig = { apiKey: "AIzaSyDsbiLPBOda119Qr6Ji69j8TZLpiFixBWI", authDomain: "list-games-9bddd.firebaseapp.com", projectId: "list-games-9bddd", storageBucket: "list-games-9bddd.firebasestorage.app", messagingSenderId: "756898313156", appId: "1:756898313156:web:9bc660d0a2f4cd07882a91" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null, allTeams = [], allGames = [], editingId = null, currentTeamMembers = [], currentTeamData = null;

    const els = {
        app: document.getElementById('app'), loading: document.getElementById('loading'), cards: document.getElementById('cards-container'), empty: document.getElementById('empty-state'),
        modal: document.getElementById('modal'), form: document.getElementById('team-form'), modalTitle: document.getElementById('modal-title-text'),
        search: document.getElementById('search-input'), filterType: document.getElementById('filter-type'), datalist: document.getElementById('games-list'),
        inputs: { name: document.getElementById('team-name'), game: document.getElementById('team-game'), img: document.getElementById('team-img'), type: document.getElementById('team-type') },
        btns: { add: document.getElementById('add-btn'), close: document.getElementById('close-modal'), delete: document.getElementById('delete-btn'), logout: document.getElementById('logout-btn') },
        membersModal: document.getElementById('members-modal'), membersList: document.getElementById('members-list'), memberFormContainer: document.getElementById('member-form-container'),
        memberEmptyState: document.getElementById('member-empty-state'), memberForm: document.getElementById('member-form'),
        memberInputs: { id: document.getElementById('member-id'), name: document.getElementById('member-name'), avatar: document.getElementById('member-avatar'), dynamic: document.getElementById('dynamic-fields') },
        btnDeleteMember: document.getElementById('btn-delete-member'), memberTeamName: document.getElementById('member-team-name'),
        soccerModal: document.getElementById('soccer-visualizer-modal'), formationSelect: document.getElementById('formation-select'), fieldPlayersContainer: document.getElementById('field-players-container'),
        subsList: document.getElementById('subs-list'), subsOverflow: document.getElementById('subs-overflow'), coachesList: document.getElementById('coaches-list'),
        generalModal: document.getElementById('general-visualizer-modal'), generalGrid: document.getElementById('general-cards-grid'), generalTitle: document.getElementById('gen-viz-title'),
    };

    const toggleLoading = (show) => { if(show) { els.loading.classList.remove('hidden'); els.app.classList.add('hidden'); } else { els.loading.classList.add('hidden'); els.app.classList.remove('hidden'); lucide.createIcons(); } };
    const getTypeColor = (type) => { switch(type) { case 'Pokemon': case 'Pokemon Principal': case 'Pokemon Fazenda': return 'bg-yellow-500/10 text-yellow-400 border-yellow-500/20'; case 'Digimon': return 'bg-blue-500/10 text-blue-400 border-blue-500/20'; case 'Futebol': return 'bg-green-500/10 text-green-400 border-green-500/20'; default: return 'bg-gray-500/10 text-gray-300 border-gray-500/20'; } };
    
    const generateAvatarHTML = (avatarUrl, name, sizeClass = "w-10 h-10") => {
        const initial = name ? name.charAt(0).toUpperCase() : '?';
        const fallbackHtml = `<div class='${sizeClass} avatar-fallback-container rounded-full border border-white/10 shadow-sm bg-black/40 text-xs'>${initial}</div>`;
        if (!avatarUrl || avatarUrl.trim() === '') return fallbackHtml;
        if (avatarUrl.includes('static.wikia')) avatarUrl = avatarUrl.split('/revision/')[0];
        return `<img src="${avatarUrl}" class="${sizeClass} rounded-full object-cover border border-white/10 bg-black/40" style="image-rendering: -webkit-optimize-contrast;" alt="${name}" onerror="this.parentElement.innerHTML=\`${fallbackHtml}\`">`;
    };

    // --- VISUALIZADOR TÁTICO ---
    // Preenche a opção de seleção de tática no modal de edição de membros
    Object.keys(TACTICS_CONFIG).forEach(f => { 
        const opt = document.createElement('option'); 
        opt.value = f; opt.textContent = f; 
        document.getElementById('team-formation-select').appendChild(opt); 
    });

    window.openSoccerVisualizer = (team) => { 
        if(team.type !== 'Futebol') { alert('Disponível apenas para Futebol.'); return; } 
        currentTeamData = team; 
        
        // Garante que a barra lateral de comissão/reservas venha fechada por padrão
        const sidebar = document.getElementById('soccer-sidebar'); 
        const btn = document.getElementById('toggle-sidebar-btn');
        sidebar.className = 'w-0 opacity-0 border-l-0 border-white/5 flex flex-col shrink-0 transition-all duration-300 ease-in-out overflow-hidden z-10 glass-panel shadow-[-10px_0_30px_rgba(0,0,0,0.5)]';
        btn.innerHTML = '<i data-lucide="chevron-left" class="w-5 h-5"></i>';

        els.soccerModal.classList.remove('hidden'); 
        renderSoccerLayout(); 
    };
    
    window.closeSoccerVisualizer = () => els.soccerModal.classList.add('hidden');
    const renderSoccerLayout = () => {
        const members = currentTeamData.members || [];
        const titulares = members.filter(m => m.status === 'Titular' && m.posicao !== 'Técnico');
        const reservas = members.filter(m => m.status === 'Reserva' && m.posicao !== 'Técnico');
        const tecnicos = members.filter(m => m.posicao === 'Técnico');
        renderSoccerField(titulares);
        renderSoccerSidebar(reservas, tecnicos);
    }

    const renderSoccerField = (titularesList) => {
        els.fieldPlayersContainer.innerHTML = '';
        const formationId = currentTeamData.formation || '4-3-3'; // Puxa do banco de dados
        document.getElementById('current-formation-display').textContent = formationId;

        const slotsConfig = TACTICS_CONFIG[formationId];
        if(!slotsConfig) return;
        let playersToPlace = titularesList || currentTeamData.members.filter(m => m.status === 'Titular' && m.posicao !== 'Técnico');

        for (const [posicaoName, slots] of Object.entries(slotsConfig)) {
            slots.forEach((coords) => {
                const playerIndex = playersToPlace.findIndex(p => p.posicao === posicaoName);
                if(playerIndex > -1) {
                    const player = playersToPlace[playerIndex]; playersToPlace.splice(playerIndex, 1);
                    const token = document.createElement('div'); token.className = 'player-token group/token'; token.style.top = `${coords.t}%`; token.style.left = `${coords.l}%`;
                    token.innerHTML = `<div class="token-img-wrapper border-[#B9314F] shadow-[0_0_15px_rgba(185,49,79,0.3)]">${generateAvatarHTML(player.avatar, player.name, "w-full h-full")}</div><div class="token-info"><div class="token-name" title="${player.name}">${player.name.split(' ')[0]}</div><div class="token-pos">${player.posicao} ${player.numero ? '#'+player.numero : ''}</div></div>`;
                    els.fieldPlayersContainer.appendChild(token);
                }
            });
        }
    };

    const renderSoccerSidebar = (reservas, tecnicos) => {
        els.subsList.innerHTML = ''; const maxSubs = 7;
        reservas.slice(0, maxSubs).forEach(sub => {
             const item = document.createElement('div'); item.className = "flex items-center gap-3 p-2.5 bg-white/5 rounded-xl border border-white/5";
             item.innerHTML = `<div class="shrink-0">${generateAvatarHTML(sub.avatar, sub.name, "w-8 h-8")}</div><div class="min-w-0"><p class="text-sm text-white font-bold truncate leading-none">${sub.name}</p><p class="text-[10px] text-gray-500 uppercase tracking-widest mt-1">${sub.posicao} #${sub.numero||'?'}</p></div>`;
             els.subsList.appendChild(item);
        });
        if(reservas.length > maxSubs) { els.subsOverflow.textContent = `+${reservas.length - maxSubs} Jogadores`; els.subsOverflow.classList.remove('hidden'); } else els.subsOverflow.classList.add('hidden');

        els.coachesList.innerHTML = '';
        tecnicos.slice(0, 3).forEach(coach => {
             const item = document.createElement('div'); item.className = "flex items-center gap-3 p-2.5 bg-accent/10 rounded-xl border border-accent/20";
             item.innerHTML = `<div class="shrink-0">${generateAvatarHTML(coach.avatar, coach.name, "w-8 h-8")}</div><div class="min-w-0"><p class="text-sm text-white font-bold truncate leading-none">${coach.name}</p><p class="text-[10px] text-accent uppercase tracking-widest mt-1">Técnico</p></div>`;
             els.coachesList.appendChild(item);
        });
    };

    window.toggleSoccerSidebar = () => {
        const sidebar = document.getElementById('soccer-sidebar'); 
        const btn = document.getElementById('toggle-sidebar-btn');
        if (sidebar.classList.contains('w-0')) { 
            sidebar.classList.remove('w-0', 'border-l-0', 'opacity-0'); 
            sidebar.classList.add('w-64', 'border-l'); 
            btn.innerHTML = '<i data-lucide="chevron-right" class="w-5 h-5"></i>'; 
        } else { 
            sidebar.classList.remove('w-64', 'border-l'); 
            sidebar.classList.add('w-0', 'border-l-0', 'opacity-0'); 
            btn.innerHTML = '<i data-lucide="chevron-left" class="w-5 h-5"></i>'; 
        }
        if(typeof lucide !== 'undefined') lucide.createIcons();
    };

    // --- CORE (Render Cards na Tela Principal) ---
    const render = () => {
        const term = els.search.value.toLowerCase(); const typeFilter = els.filterType.value;
        const filtered = allTeams.filter(t => (t.name.toLowerCase().includes(term) || t.game.toLowerCase().includes(term)) && (!typeFilter || t.type === typeFilter));
        els.cards.innerHTML = '';
        if (filtered.length === 0) els.empty.classList.remove('hidden');
        else {
            els.empty.classList.add('hidden');
            filtered.forEach(t => {
                const imgSource = t.img || 'https://placehold.co/300x200/151515/B9314F?text=No+Image'; const members = t.members || [];
                let membersStackHTML = '';
                if (members.length > 0) {
                    const maxDisplay = 10; const displayMembers = members.slice(0, maxDisplay); const remaining = members.length - maxDisplay;
                    const avatars = displayMembers.map(m => `<div class="relative -ml-2 transition-transform hover:-translate-y-1 hover:z-10"><div class="avatar-wrapper shadow-lg">${generateAvatarHTML(m.avatar, m.name, "w-11 h-11")}</div></div>`).join('');
                    const plusBubble = remaining > 0 ? `<div class="relative -ml-2 z-0 w-11 h-11 rounded-full bg-white/10 backdrop-blur-md border border-white/20 text-white text-xs font-bold flex items-center justify-center shadow-lg">+${remaining}</div>` : '';
                    membersStackHTML = `<div class="flex items-center pl-2 mt-4 h-11">${avatars}${plusBubble}</div>`;
                } else membersStackHTML = `<p class="text-xs text-gray-500 mt-4 italic pl-1 h-11 flex items-center font-medium">Nenhum integrante adicionado</p>`;

                const card = document.createElement('div');
                card.className = 'task-card flex flex-col md:flex-row rounded-2xl overflow-hidden relative group';
                card.innerHTML = `
                    <div class="w-full md:w-56 h-36 md:h-auto relative shrink-0 bg-gray-900">
                        <img src="${imgSource}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity duration-500" onerror="this.src='https://placehold.co/300x200/151515/B9314F?text=No+Image'">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent md:bg-gradient-to-r md:from-transparent md:to-[#151515]/80 pointer-events-none"></div>
                    </div>
                    <div class="flex-1 p-5 md:p-6 flex flex-col justify-between relative min-w-0 z-10">
                        <div>
                            <div class="flex items-center gap-2 mb-3">
                                <span class="text-[10px] font-bold uppercase tracking-wider text-accent bg-accent/10 px-2.5 py-1 rounded-lg border border-accent/20">${t.game}</span>
                                <span class="text-[10px] uppercase font-bold tracking-wider px-2.5 py-1 rounded-lg border ${getTypeColor(t.type)}">${t.type}</span>
                            </div>
                            <h3 class="text-2xl font-bold text-white mb-1 leading-tight truncate">${t.name}</h3>
                            ${membersStackHTML}
                        </div>
                    </div>
                    <div class="flex flex-row md:flex-col items-center justify-center gap-3 p-4 border-t md:border-t-0 md:border-l border-white/5 bg-black/20 shrink-0 w-full md:w-24">
                        <button class="btn-icon edit p-2.5 rounded-xl bg-blue-500/10 text-blue-400 hover:bg-blue-500 hover:text-white transition-colors" title="Editar"><i data-lucide="edit-2" class="w-5 h-5"></i></button>
                        <button class="btn-icon members p-2.5 rounded-xl bg-yellow-500/10 text-yellow-400 hover:bg-yellow-500 hover:text-white transition-colors" title="Membros"><i data-lucide="users" class="w-5 h-5"></i></button>
                        <button class="btn-icon view p-2.5 rounded-xl bg-green-500/10 text-green-400 hover:bg-green-500 hover:text-white transition-colors" title="Visualizar Prancheta"><i data-lucide="eye" class="w-5 h-5"></i></button>
                    </div>`;
                
                card.querySelector('.edit').onclick = () => openEditTeamModal(t); 
                card.querySelector('.members').onclick = () => openMembersModal(t);
                
                const viewBtn = card.querySelector('.view');
                if (t.type === 'Futebol') viewBtn.onclick = () => openSoccerVisualizer(t);
                else if (t.type === 'Geral') viewBtn.onclick = () => openGeneralVisualizer(t);
                else if (t.type === 'Pokemon Principal') viewBtn.onclick = () => openPokemonVisualizer(t);
                else if (t.type === 'Pokemon Fazenda') viewBtn.onclick = () => openFarmVisualizer(t);
                else if (t.type === 'Digimon') viewBtn.onclick = () => openDigimonVisualizer(t);
                else {
                    viewBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    viewBtn.onclick = () => alert('Visualização disponível apenas para Futebol e Geral.');
                }

                els.cards.appendChild(card);
            });
        }
        lucide.createIcons();
    };

    // --- VISUALIZADORES (GERAL, POKEMON, FAZENDA, DIGIMON) INALTERADOS DA LÓGICA ORIGINAL ---
    window.openGeneralVisualizer = (team) => { 
        currentTeamData = team; 
        // Substituimos o .querySelector('span') chamando diretamente o elemento
        els.generalTitle.textContent = team.name; 
        renderGeneralCards(team.members || []); 
        els.generalModal.classList.remove('hidden'); 
    };

    window.closeGeneralVisualizer = () => { els.generalModal.classList.add('hidden'); };
    
    const renderGeneralCards = (members) => {
        els.generalGrid.innerHTML = '';
        if (members.length === 0) { 
            els.generalGrid.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center text-gray-500 py-20"><i data-lucide="ghost" class="w-16 h-16 mb-4 opacity-20 text-accent"></i><p class="font-bold tracking-widest uppercase">Este Time está vazio...</p></div>`; 
            lucide.createIcons();
            return; 
        }

        members.forEach(member => {
            const card = document.createElement('div'); 
            card.className = 'portrait-card group';
            
            // Alterna a classe para mostrar/esconder o painel de observações
            card.onclick = () => card.classList.toggle('show-obs');

            let imgHtml = '';
            if (member.avatar && member.avatar.trim() !== '') { 
                imgHtml = `
                    <img src="${member.avatar}" class="portrait-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                    <div class="hidden w-full h-full bg-[#111] items-center justify-center text-gray-700 font-bold text-6xl uppercase">${member.name.charAt(0)}</div>
                `; 
            } else { 
                imgHtml = `<div class="w-full h-full bg-[#111] flex items-center justify-center text-gray-700 font-bold text-6xl uppercase shadow-inner">${member.name.charAt(0)}</div>`; 
            }
            
            const obsText = member.obs ? member.obs : "Nenhuma observação ou cargo registrado.";
            
            card.innerHTML = `
                ${imgHtml}
                <!-- Overlay Base (Nome do membro e Dica) -->
                <div class="portrait-overlay">
                    <h4 class="font-bold text-white text-base sm:text-lg leading-tight truncate drop-shadow-lg">${member.name}</h4>
                    <div class="flex items-center gap-1.5 mt-1.5 opacity-70 group-hover:opacity-100 transition-opacity">
                        <i data-lucide="mouse-pointer-click" class="w-3 h-3 text-accent"></i>
                        <span class="text-[9px] text-gray-300 uppercase tracking-widest font-bold">Ver Observação</span>
                    </div>
                </div>
                
                <!-- Painel Oculto (Abre ao clicar) -->
                <div class="portrait-obs-panel custom-scroll overflow-y-auto">
                    <div class="flex justify-between items-start mb-4 border-b border-white/10 pb-3 shrink-0">
                        <h4 class="font-bold text-accent text-lg leading-tight pr-4">${member.name}</h4>
                        <div class="bg-white/5 p-1 rounded-md text-gray-400"><i data-lucide="x" class="w-4 h-4"></i></div>
                    </div>
                    
                    <div class="flex items-center gap-2 mb-3 shrink-0">
                        <div class="bg-white/10 p-1.5 rounded-lg border border-white/5">
                            <i data-lucide="clipboard-list" class="w-3.5 h-3.5 text-gray-300"></i>
                        </div>
                        <span class="text-[10px] uppercase font-bold text-gray-400 tracking-wider">Cargo / Anotação</span>
                    </div>
                    
                    <p class="text-xs sm:text-sm text-gray-200 leading-relaxed font-mono whitespace-pre-wrap">${obsText}</p>
                </div>
            `;
            els.generalGrid.appendChild(card);
        });
        
        lucide.createIcons();
    };
    
    const elsPoke = { modal: document.getElementById('pokemon-visualizer-modal'), title: document.getElementById('poke-viz-title'), mainGrid: document.getElementById('poke-main-grid'), extraContainer: document.getElementById('poke-extra-container'), extraGrid: document.getElementById('poke-extra-grid') };
    window.openPokemonVisualizer = (team) => { elsPoke.title.textContent = team.name; renderPokemonLayout(team.members || []); elsPoke.modal.classList.remove('hidden'); };
    window.closePokemonVisualizer = () => elsPoke.modal.classList.add('hidden');
    
    const renderPokemonLayout = (members) => {
        elsPoke.mainGrid.innerHTML = ''; 
        elsPoke.extraGrid.innerHTML = '';
        
        if (members.length === 0) { 
            elsPoke.mainGrid.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center text-gray-500 py-10"><i data-lucide="ghost" class="w-16 h-16 mb-4 opacity-20 text-accent"></i><p class="font-bold tracking-widest uppercase">Nenhum Pokémon registrado.</p></div>`; 
            elsPoke.extraContainer.classList.add('hidden');
            lucide.createIcons();
            return; 
        }

        const mainTeam = members.slice(0, 6); 
        const extraTeam = members.slice(6);
        
        mainTeam.forEach(p => elsPoke.mainGrid.appendChild(createPokemonCard(p, true)));
        
        if (extraTeam.length > 0) { 
            elsPoke.extraContainer.classList.remove('hidden'); 
            extraTeam.forEach(p => elsPoke.extraGrid.appendChild(createPokemonCard(p, false))); 
        } else { 
            elsPoke.extraContainer.classList.add('hidden'); 
        }
        
        lucide.createIcons();
    };

    const createPokemonCard = (pokemon, isMain) => {
        const c1 = TYPE_COLORS[pokemon.type1] || '#333'; 
        const c2 = pokemon.type2 ? TYPE_COLORS[pokemon.type2] : c1;
        const gradientStyle = `linear-gradient(135deg, ${c1}, ${c2})`;
        
        const card = document.createElement('div'); 
        
        if (isMain) {
            // Estilo grandioso para os 6 do time principal
            card.className = 'task-card flex flex-col items-center group relative p-5 sm:p-6 rounded-[2rem] w-full max-w-[240px] hover:-translate-y-3 transition-all duration-300';
            
            card.innerHTML = `
                <div class="w-28 h-28 sm:w-32 sm:h-32 rounded-full p-[4px] shadow-[0_0_30px_rgba(0,0,0,0.6)] relative z-10 bg-[#151515] transition-transform duration-500 group-hover:scale-110" style="background: ${gradientStyle}">
                    <div class="w-full h-full rounded-full border-[4px] border-[#151515] overflow-hidden bg-[#0b0b0b] relative flex items-center justify-center group-hover:brightness-110 transition">
                        ${generateAvatarHTML(pokemon.avatar, pokemon.name, "w-full h-full")}
                    </div>
                </div>
                
                <div class="mt-6 flex flex-col items-center w-full min-w-0">
                    <span class="text-lg sm:text-xl font-bold text-white tracking-wide truncate w-full text-center" title="${pokemon.name}">${pokemon.name}</span>
                    <div class="mt-3 flex gap-2 flex-wrap justify-center">
                        <span class="text-[9px] sm:text-[10px] uppercase font-bold tracking-widest px-2 sm:px-3 py-1 rounded-lg bg-black/60 border border-white/5 text-gray-300 shadow-sm" style="border-bottom: 2px solid ${c1}">${pokemon.type1}</span>
                        ${pokemon.type2 ? `<span class="text-[9px] sm:text-[10px] uppercase font-bold tracking-widest px-2 sm:px-3 py-1 rounded-lg bg-black/60 border border-white/5 text-gray-300 shadow-sm" style="border-bottom: 2px solid ${c2}">${pokemon.type2}</span>` : ''}
                    </div>
                </div>
            `;
        } else {
            // Estilo compacto para a caixa/histórico
            card.className = 'task-card flex flex-col items-center group relative p-4 rounded-2xl w-28 sm:w-32 hover:-translate-y-2 transition-all duration-300 cursor-default';
            
            card.innerHTML = `
                <div class="w-16 h-16 sm:w-20 sm:h-20 rounded-full p-[3px] shadow-lg relative z-10 bg-[#151515] transition-transform duration-300 group-hover:scale-105" style="background: ${gradientStyle}">
                    <div class="w-full h-full rounded-full border-[3px] border-[#151515] overflow-hidden bg-[#0b0b0b] relative flex items-center justify-center group-hover:brightness-110 transition">
                        ${generateAvatarHTML(pokemon.avatar, pokemon.name, "w-full h-full")}
                    </div>
                </div>
                <span class="mt-4 text-xs font-bold text-gray-300 truncate w-full text-center group-hover:text-white transition-colors" title="${pokemon.name}">${pokemon.name}</span>
                <div class="mt-2 flex gap-1.5">
                    <div class="w-3.5 h-3.5 rounded-full border border-black shadow-inner" style="background:${c1}" title="${pokemon.type1}"></div>
                    ${pokemon.type2 ? `<div class="w-3.5 h-3.5 rounded-full border border-black shadow-inner" style="background:${c2}" title="${pokemon.type2}"></div>` : ''}
                </div>
            `;
        }
        
        return card;
    };

    const getTypesBadges = (pokemon) => {
        const t1Color = TYPE_COLORS[pokemon.type1]; const t2Color = pokemon.type2 ? TYPE_COLORS[pokemon.type2] : null;
        return `<div class="absolute -bottom-1 left-1/2 -translate-x-1/2 flex gap-1"><div class="w-4 h-4 rounded-full border border-[#1a1a1a] shadow-sm" style="background:${t1Color}" title="${pokemon.type1}"></div>${t2Color ? `<div class="w-4 h-4 rounded-full border border-[#1a1a1a] shadow-sm" style="background:${t2Color}" title="${pokemon.type2}"></div>` : ''}</div>`;
    };

    const elsFarm = { modal: document.getElementById('pokemon-farm-modal'), title: document.getElementById('farm-viz-title'), container: document.getElementById('farm-groups-container') };
    window.openFarmVisualizer = (team) => { elsFarm.title.textContent = team.name; renderFarmLayout(team.members || []); elsFarm.modal.classList.remove('hidden'); };
    window.closeFarmVisualizer = () => elsFarm.modal.classList.add('hidden');
    const renderFarmLayout = (members) => {
        elsFarm.container.innerHTML = '';
        if (members.length === 0) { 
            elsFarm.container.innerHTML = `<div class="text-center flex flex-col items-center justify-center text-gray-500 mt-20"><i data-lucide="ghost" class="w-16 h-16 mb-4 opacity-20 text-accent"></i><p class="font-bold tracking-widest uppercase">A fazenda está vazia.</p></div>`; 
            lucide.createIcons();
            return; 
        }

        // Lógica de agrupamento preservando a ORDEM DE CADASTRO (inserção)
        const orderedGroups = [];
        const grouped = {};
        
        members.forEach(curr => {
            const g = curr.group && curr.group.trim() !== '' ? curr.group : 'Geral';
            if (!grouped[g]) {
                grouped[g] = [];
                orderedGroups.push(g); // Registra a ordem do primeiro elemento deste grupo
            }
            grouped[g].push(curr);
        });

        // Itera na ordem correta em que os grupos apareceram
        orderedGroups.forEach(groupName => {
            const groupMembers = grouped[groupName];
            const section = document.createElement('div'); 
            section.className = 'w-full animate-in fade-in slide-in-from-bottom-4 duration-500';
            
            section.innerHTML = `
                <div class="flex items-center gap-4 mb-6">
                    <h3 class="text-xl md:text-2xl font-bold text-white uppercase tracking-wider">${groupName}</h3>
                    <div class="h-[1px] flex-1 bg-gradient-to-r from-white/10 to-transparent"></div>
                    <span class="text-xs font-bold text-accent bg-accent/10 px-3 py-1.5 rounded-lg border border-accent/20">
                        QTD: ${String(groupMembers.length).padStart(2, '0')}
                    </span>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6 justify-items-center group-grid"></div>
            `;
            
            const grid = section.querySelector('.group-grid'); 
            groupMembers.forEach(p => { grid.appendChild(createFarmCard(p)); });
            elsFarm.container.appendChild(section);
        });
        lucide.createIcons();
    };

    const createFarmCard = (pokemon) => {
        const c1 = TYPE_COLORS[pokemon.type1] || '#333'; 
        const c2 = pokemon.type2 ? TYPE_COLORS[pokemon.type2] : c1;
        const gradientStyle = `linear-gradient(135deg, ${c1}, ${c2})`;
        
        const card = document.createElement('div'); 
        card.className = 'task-card p-4 flex flex-col items-center group w-full relative hover:-translate-y-2 transition-all duration-300 rounded-2xl cursor-default';
        
        card.innerHTML = `
            <div class="w-24 h-24 rounded-full p-[3px] shadow-[0_0_20px_rgba(0,0,0,0.4)] relative z-10 bg-[#151515] transition-transform duration-300 group-hover:scale-105" style="background: ${gradientStyle}">
                <div class="w-full h-full rounded-full border-[3px] border-[#151515] overflow-hidden bg-[#0b0b0b] relative group-hover:brightness-110 transition flex items-center justify-center">
                    ${generateAvatarHTML(pokemon.avatar, pokemon.name, "w-full h-full")}
                </div>
                <!-- Mini ícones coloridos dos Tipos -->
                <div class="absolute -right-1 bottom-1 flex flex-col gap-1 shadow-lg bg-black/80 p-1.5 rounded-full backdrop-blur-sm border border-white/10">
                    <div class="w-3.5 h-3.5 rounded-full border border-black shadow-inner" style="background:${c1}" title="${pokemon.type1}"></div>
                    ${pokemon.type2 ? `<div class="w-3.5 h-3.5 rounded-full border border-black shadow-inner" style="background:${c2}" title="${pokemon.type2}"></div>` : ''}
                </div>
            </div>
            
            <div class="mt-4 text-center w-full min-w-0">
                <p class="font-bold text-gray-100 text-sm leading-tight truncate px-1" title="${pokemon.name}">${pokemon.name}</p>
                <div class="mt-2 flex justify-center gap-1.5 flex-wrap">
                    <span class="text-[9px] uppercase tracking-widest px-2 py-0.5 rounded-md bg-black/40 border border-white/5 text-gray-400 font-bold" style="border-bottom: 2px solid ${c1}">${pokemon.type1}</span>
                    ${pokemon.type2 ? `<span class="text-[9px] uppercase tracking-widest px-2 py-0.5 rounded-md bg-black/40 border border-white/5 text-gray-400 font-bold" style="border-bottom: 2px solid ${c2}">${pokemon.type2}</span>` : ''}
                </div>
            </div>
        `;
        return card;
    };

    const elsDigi = { modal: document.getElementById('digimon-visualizer-modal'), title: document.getElementById('digi-viz-title'), container: document.getElementById('digimon-groups-container') };
    window.openDigimonVisualizer = (team) => { elsDigi.title.textContent = team.name; renderDigimonLayout(team.members || []); elsDigi.modal.classList.remove('hidden'); };
    window.closeDigimonVisualizer = () => elsDigi.modal.classList.add('hidden');
    
    const renderDigimonLayout = (members) => {
        elsDigi.container.innerHTML = '';
        const order = ['Principal', 'Reserva', 'Box'];
        const grouped = { 'Principal': [], 'Reserva': [], 'Box': [] };
        members.forEach(m => { const g = m.group || 'Box'; if (grouped[g]) grouped[g].push(m); else grouped['Box'].push(m); });
        
        order.forEach(groupName => {
            const groupMembers = grouped[groupName]; if (groupMembers.length === 0) return;
            const section = document.createElement('div'); section.className = 'w-full animate-in fade-in slide-in-from-bottom-4 duration-500';
            
            // Cores padronizadas com o tema Xbox Minimalista
            let headerColor = 'text-accent border-white/10';
            if(groupName === 'Reserva') headerColor = 'text-gray-300 border-white/20';
            if(groupName === 'Box') headerColor = 'text-gray-500 border-white/10';
            
            section.innerHTML = `
                <div class="flex items-end gap-3 mb-4 border-b ${headerColor.split(' ')[1]} pb-2">
                    <h3 class="text-2xl font-bold uppercase font-mono tracking-widest ${headerColor.split(' ')[0]}">${groupName}</h3>
                    <div class="text-xs bg-black/40 px-3 py-1 rounded-lg border border-white/10 text-gray-400 mb-1 font-mono">
                        MEM: ${String(groupMembers.length).padStart(2, '0')}
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    ${groupMembers.map(m => createDigimonCardHTML(m)).join('')}
                </div>`;
            elsDigi.container.appendChild(section);
        });
        lucide.createIcons();
    };

    const createDigimonCardHTML = (digimon) => {
        const dType = DIGI_TYPES[digimon.digiType] || DIGI_TYPES['Free']; 
        const dAttr = DIGI_ATTRS[digimon.digiAttr] || DIGI_ATTRS['Neutral'];
        const imgUrl = (digimon.avatar && digimon.avatar.length > 5) ? digimon.avatar : 'https://placehold.co/150x150/151515/B9314F?text=D';
        
        return `
        <div class="task-card group relative rounded-xl overflow-hidden flex h-28 cursor-default">
            <!-- Barra lateral com a cor do Tipo (Vacina, Vírus, Dados) -->
            <div class="w-1.5 h-full opacity-80 group-hover:opacity-100 transition-opacity" style="background-color: ${dType.color}; box-shadow: 0 0 10px ${dType.color};"></div>
            
            <div class="w-28 h-full shrink-0 relative overflow-hidden bg-[#0b0b0b]">
                <img src="${imgUrl}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity duration-300">
                <!-- Fade sutil conectando a imagem com os detalhes -->
                <div class="absolute inset-0 bg-gradient-to-r from-transparent to-[#151515]/90 pointer-events-none"></div>
            </div>
            
            <div class="flex-1 flex flex-col justify-between p-3 relative z-10 bg-transparent min-w-0">
                <div class="w-full border-b border-white/5 pb-1 mb-1">
                    <h4 class="font-bold text-white truncate text-sm sm:text-base leading-tight">${digimon.name}</h4>
                </div>
                
                <div class="flex items-center gap-2 mt-auto">
                    <!-- Badge Tipo -->
                    <div class="flex items-center gap-1.5 px-2 py-1.5 rounded-lg bg-black/60 border border-white/5 shadow-sm" title="Tipo: ${dType.label}">
                        <i data-lucide="${dType.icon}" class="w-3.5 h-3.5" style="color: ${dType.color}"></i>
                        <span class="text-[10px] font-bold uppercase tracking-wider text-gray-300 hidden sm:inline">${dType.label.substring(0,3)}</span>
                    </div>
                    <!-- Badge Atributo -->
                    <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-black/60 border border-white/5 shadow-sm" title="Atributo: ${dAttr.label}">
                        <i data-lucide="${dAttr.icon}" class="w-4 h-4" style="color: ${dAttr.color}"></i>
                    </div>
                </div>
                
                <!-- Ícone de fundo suave -->
                <i data-lucide="${dType.icon}" class="absolute right-[-10px] bottom-[-15px] w-20 h-20 opacity-[0.02] text-white rotate-12 pointer-events-none group-hover:opacity-[0.08] transition-opacity duration-300"></i>
            </div>
        </div>`;
    };

    // --- MANIPULAÇÃO DE DADOS & MODAIS ---
    const openNewTeamModal = () => { editingId = null; els.form.reset(); els.btns.delete.classList.add('hidden'); els.modalTitle.textContent = "Novo Time"; els.modal.classList.remove('hidden'); els.modal.classList.add('flex'); };
    const openEditTeamModal = (data) => { editingId = data.id; els.inputs.name.value = data.name; els.inputs.game.value = data.game; els.inputs.img.value = data.img || ''; els.inputs.type.value = data.type || 'Geral'; els.btns.delete.classList.remove('hidden'); els.modalTitle.innerHTML = "Editar Time"; els.modal.classList.remove('hidden'); els.modal.classList.add('flex'); };
    const saveTeam = async (e) => { e.preventDefault(); const data = { name: els.inputs.name.value, game: els.inputs.game.value, img: els.inputs.img.value, type: els.inputs.type.value, updatedAt: new Date() }; try { if (editingId) await updateDoc(doc(db, 'users', currentUser.uid, 'teams_games', editingId), data); else { data.members = []; await addDoc(collection(db, 'users', currentUser.uid, 'teams_games'), data); } els.modal.classList.add('hidden'); } catch (err) { console.error(err); } };
    const deleteTeam = async () => { if(!editingId || !confirm("Tem certeza?")) return; await deleteDoc(doc(db, 'users', currentUser.uid, 'teams_games', editingId)); els.modal.classList.add('hidden'); };

    window.openMembersModal = (team) => { 
        currentTeamData = team; 
        currentTeamMembers = team.members || []; 
        els.memberTeamName.textContent = team.name; 

        // Adiciona funcionalidade para gerenciar a Formação Tática (Se for time de futebol)
        const formationContainer = document.getElementById('team-formation-container');
        const formationSelect = document.getElementById('team-formation-select');
        if (team.type === 'Futebol') {
            formationContainer.classList.remove('hidden');
            formationSelect.value = team.formation || '4-3-3';
            formationSelect.onchange = async (e) => {
                const newFormation = e.target.value;
                try {
                    await updateDoc(doc(db, 'users', currentUser.uid, 'teams_games', currentTeamData.id), { formation: newFormation });
                    currentTeamData.formation = newFormation;
                } catch (err) {
                    console.error("Erro ao salvar formação:", err);
                }
            };
        } else {
            formationContainer.classList.add('hidden');
        }

        renderMembersList(); 
        els.memberEmptyState.classList.remove('hidden'); 
        els.memberFormContainer.classList.add('hidden'); 
        els.membersModal.classList.remove('hidden'); 
        els.membersModal.classList.add('flex'); 
    };
    
    window.closeMembersModal = () => els.membersModal.classList.add('hidden');
    
    const renderMembersList = () => {
        els.membersList.innerHTML = '';
        currentTeamMembers.forEach((member, index) => {
            const item = document.createElement('div');
            item.className = 'p-3 rounded-xl bg-black/40 hover:bg-white/5 cursor-pointer flex items-center gap-3 transition group border border-white/5 hover:border-white/20 mb-2';
            let extraInfo = '';
            if(currentTeamData.type === 'Futebol') extraInfo = `<span class="text-[10px] uppercase tracking-widest text-gray-500 block">${member.posicao || '-'} #${member.numero || '?'} ${member.status === 'Reserva' ? '(R)' : ''}</span>`;
            else { const obsText = member.obs ? member.obs.substring(0, 30) + (member.obs.length > 30 ? '...' : '') : 'Membro'; extraInfo = `<span class="text-[10px] uppercase tracking-widest text-gray-500 block">${obsText}</span>`; }
            item.innerHTML = `<div class="avatar-wrapper shrink-0 shadow-md">${generateAvatarHTML(member.avatar, member.name, "w-10 h-10")}</div><div class="flex-1 min-w-0"><p class="text-sm font-bold text-gray-200 truncate">${member.name}</p>${extraInfo}</div><i data-lucide="chevron-right" class="w-4 h-4 text-gray-600 group-hover:text-white"></i>`;
            item.onclick = () => loadMemberToForm(member, index);
            els.membersList.appendChild(item);
        });
        lucide.createIcons();
    };

    const renderTypeSpecificFields = (type, data = {}) => {
        const container = els.memberInputs.dynamic; container.innerHTML = '';
        if (type === 'Futebol') {
            container.innerHTML = `<div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Posição</label><select id="mem-futebol-pos" class="w-full px-4 py-3 rounded-xl bg-black/40 border border-white/10 text-white focus:border-accent outline-none"><option value="Goleiro">Goleiro</option><option value="Zagueiro">Zagueiro</option><option value="Lateral">Lateral</option><option value="Volante">Volante</option><option value="Meia">Meia</option><option value="Atacante">Atacante</option><option value="Técnico">Técnico</option></select></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Número</label><input id="mem-futebol-num" type="number" class="w-full px-4 py-3 rounded-xl bg-black/40 border border-white/10 text-white focus:border-accent outline-none" placeholder="10"></div></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-2 mt-2">Status</label><div class="flex gap-6 bg-black/40 p-3 rounded-xl border border-white/10"><label class="flex items-center gap-2 cursor-pointer text-sm font-bold text-white"><input type="radio" name="status" value="Titular" class="accent-accent w-4 h-4" checked> Titular</label><label class="flex items-center gap-2 cursor-pointer text-sm font-bold text-white"><input type="radio" name="status" value="Reserva" class="accent-accent w-4 h-4"> Reserva</label></div></div>`;
            if(data.posicao) document.getElementById('mem-futebol-pos').value = data.posicao; if(data.numero) document.getElementById('mem-futebol-num').value = data.numero;
            if(data.status) { const radios = document.getElementsByName('status'); radios.forEach(r => { if(r.value === data.status) r.checked = true; }); }
        } else if (type === 'Pokemon Principal' || type === 'Pokemon Fazenda') {
            const typeOptions = POKE_TYPES.map(t => `<option value="${t}">${t}</option>`).join('');
            let groupHtml = type === 'Pokemon Fazenda' ? `<div class="col-span-2 mt-2"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Grupo / Box</label><input id="mem-poke-group" type="text" list="existing-groups" class="w-full px-4 py-3 rounded-xl bg-black/40 border border-white/10 text-white focus:border-accent outline-none" placeholder="Ex: Fofos, Lendários, Shiny..."><datalist id="existing-groups"></datalist></div>` : '';
            container.innerHTML = `<div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tipo 1</label><select id="mem-poke-t1" class="w-full px-4 py-3 rounded-xl bg-black/40 border border-white/10 text-white focus:border-accent outline-none">${typeOptions}</select></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tipo 2 (Opcional)</label><select id="mem-poke-t2" class="w-full px-4 py-3 rounded-xl bg-black/40 border border-white/10 text-white focus:border-accent outline-none"><option value="">Nenhum</option>${typeOptions}</select></div>${groupHtml}</div>`;
            if(data.type1) document.getElementById('mem-poke-t1').value = data.type1; if(data.type2) document.getElementById('mem-poke-t2').value = data.type2;
            if(type === 'Pokemon Fazenda' && data.group) document.getElementById('mem-poke-group').value = data.group;
        } else if (type === 'Digimon') {
            const typeOpts = Object.keys(DIGI_TYPES).map(k => `<option value="${k}">${DIGI_TYPES[k].label}</option>`).join('');
            const attrOpts = Object.keys(DIGI_ATTRS).map(k => `<option value="${k}">${DIGI_ATTRS[k].label}</option>`).join('');
            container.innerHTML = `<div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tipo</label><select id="mem-digi-type" class="w-full px-4 py-3 rounded-xl bg-black/40 border border-white/10 text-white focus:border-accent outline-none">${typeOpts}</select></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Atributo</label><select id="mem-digi-attr" class="w-full px-4 py-3 rounded-xl bg-black/40 border border-white/10 text-white focus:border-accent outline-none">${attrOpts}</select></div><div class="col-span-2 mt-2"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Grupo / Box</label><select id="mem-digi-group" class="w-full px-4 py-3 rounded-xl bg-black/40 border border-white/10 text-white focus:border-accent outline-none"><option value="Principal">Principal (Party)</option><option value="Reserva">Reserva (Backup)</option><option value="Box">Box (Storage)</option></select></div></div>`;
            if(data.digiType) document.getElementById('mem-digi-type').value = data.digiType; if(data.digiAttr) document.getElementById('mem-digi-attr').value = data.digiAttr; if(data.group) document.getElementById('mem-digi-group').value = data.group;
        } else {
            container.innerHTML = `<div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Observação / Cargo</label><textarea id="mem-geral-obs" rows="3" class="w-full px-4 py-3 rounded-xl bg-black/40 border border-white/10 text-white focus:border-accent outline-none resize-none" placeholder="Ex: Líder do grupo, Suporte, etc...">${data.obs || ''}</textarea></div>`;
        }
    };
    
    const getDynamicData = (type) => {
        if(type === 'Futebol') return { posicao: document.getElementById('mem-futebol-pos').value, numero: document.getElementById('mem-futebol-num').value, status: document.querySelector('input[name="status"]:checked')?.value || 'Titular' };
        if(type === 'Pokemon Principal') return { type1: document.getElementById('mem-poke-t1').value, type2: document.getElementById('mem-poke-t2').value };
        if (type === 'Pokemon Fazenda') return { type1: document.getElementById('mem-poke-t1').value, type2: document.getElementById('mem-poke-t2').value, group: document.getElementById('mem-poke-group').value || 'Sem Grupo' };
        if (type === 'Digimon') return { digiType: document.getElementById('mem-digi-type').value, digiAttr: document.getElementById('mem-digi-attr').value, group: document.getElementById('mem-digi-group').value };
        return { obs: document.getElementById('mem-geral-obs') ? document.getElementById('mem-geral-obs').value : '' };
    };

    window.prepareNewMember = () => { els.memberInputs.id.value = -1; els.memberInputs.name.value = ''; els.memberInputs.avatar.value = ''; renderTypeSpecificFields(currentTeamData.type); els.memberEmptyState.classList.add('hidden'); els.memberFormContainer.classList.remove('hidden'); els.btnDeleteMember.classList.add('hidden'); document.getElementById('member-form-title').textContent = "Novo Integrante"; };
    const loadMemberToForm = (member, index) => { els.memberInputs.id.value = index; els.memberInputs.name.value = member.name; els.memberInputs.avatar.value = member.avatar || ''; renderTypeSpecificFields(currentTeamData.type, member); els.memberEmptyState.classList.add('hidden'); els.memberFormContainer.classList.remove('hidden'); els.btnDeleteMember.classList.remove('hidden'); document.getElementById('member-form-title').textContent = "Editar Integrante"; };
    const saveMember = async (e) => { e.preventDefault(); const index = parseInt(els.memberInputs.id.value); const memberData = { name: els.memberInputs.name.value, avatar: els.memberInputs.avatar.value, ...getDynamicData(currentTeamData.type) }; const updatedMembers = [...currentTeamMembers]; if(index === -1) updatedMembers.push(memberData); else updatedMembers[index] = memberData; try { await updateDoc(doc(db, 'users', currentUser.uid, 'teams_games', currentTeamData.id), { members: updatedMembers }); currentTeamMembers = updatedMembers; renderMembersList(); render(); els.memberFormContainer.classList.add('hidden'); els.memberEmptyState.classList.remove('hidden'); } catch (err) { console.error(err); alert("Erro ao salvar."); } };
    const deleteMember = async () => { const index = parseInt(els.memberInputs.id.value); if(index === -1 || !confirm("Remover este integrante?")) return; const updatedMembers = currentTeamMembers.filter((_, i) => i !== index); try { await updateDoc(doc(db, 'users', currentUser.uid, 'teams_games', currentTeamData.id), { members: updatedMembers }); currentTeamMembers = updatedMembers; renderMembersList(); render(); els.memberFormContainer.classList.add('hidden'); els.memberEmptyState.classList.remove('hidden'); } catch (err) { console.error(err); } };

    const init = () => { els.btns.add.onclick = openNewTeamModal; els.btns.close.onclick = () => els.modal.classList.add('hidden'); els.form.onsubmit = saveTeam; els.btns.delete.onclick = deleteTeam; els.memberForm.onsubmit = saveMember; els.btnDeleteMember.onclick = deleteMember; els.btns.logout.onclick = () => signOut(auth); els.search.oninput = render; els.filterType.onchange = render; els.inputs.game.addEventListener('input', (e) => { const gameObj = allGames.find(g => g.name === e.target.value); if (gameObj && gameObj.image) els.inputs.img.value = gameObj.image; }); };
    onAuthStateChanged(auth, async (user) => { if (!user) return window.location.href = 'index.html'; currentUser = user; document.getElementById('user-display').textContent = user.email; try { const gamesSnap = await getDocs(collection(db, 'users', user.uid, 'games')); allGames = []; els.datalist.innerHTML = ''; gamesSnap.forEach(doc => { const g = doc.data(); if(g.name) { allGames.push({ name: g.name, image: g.image }); const opt = document.createElement('option'); opt.value = g.name; els.datalist.appendChild(opt); } }); const q = query(collection(db, 'users', user.uid, 'teams_games')); onSnapshot(q, (snap) => { allTeams = []; snap.forEach(doc => allTeams.push({ id: doc.id, ...doc.data() })); allTeams.sort((a,b) => a.name.localeCompare(b.name)); render(); toggleLoading(false); }); } catch (err) { console.error(err); } });
    init();
  </script>
</body>
</html>
