<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Class Animes</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    body {
      background: #0b0b0b;
      font-family: Inter, system-ui, sans-serif;
      color: #e6e6e6;
      padding-bottom: 100px; /* espa√ßo para menu inferior */
    }

    .menu {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #151515;
      border-top: 1px solid #2a2a2a;
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
    }

    .menu-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #b3b3b3;
      font-size: 0.75rem;
      transition: all 0.2s;
    }

    .menu-btn:hover,
    .menu-btn.active {
      color: #B9314F;
    }

    .menu-btn svg {
      width: 22px;
      height: 22px;
      margin-bottom: 4px;
    }
  </style>
</head>
<body>

<div id="app" class="container mx-auto max-w-6xl px-4 pt-4">

  <!-- MENU SUPERIOR -->
  <header class="bg-[#1f1f1f] p-2 mb-3 shadow-xl rounded-xl border border-[#2a2a2a]">
    
    <!-- Linha 1 -->
    <div class="flex justify-between items-center">
      <button onclick="window.location.href='home.html'"
              class="text-2xl font-bold text-[#B9314F] hover:text-[#992743] transition-colors duration-200">
        My Hub
      </button>

      <h1 class="text-2xl font-bold text-white">My Animes</h1>
    </div>

    <!-- Linha 2 -->
    <div class="text-sm text-gray-300 mt-1">
      Usu√°rio: <span id="user-email" class="text-[#B9314F] font-mono">Carregando...</span>
    </div>

  </header>


  <!-- CONTE√öDO DA P√ÅGINA -->
  <main class="mt-4">
    <!-- Menu das Visualiza√ß√µes -->
    <div id="view-menu" class="flex overflow-x-auto gap-3 p-2 bg-[#141414] border border-[#222] rounded-xl text-sm mb-4">
      <button class="view-btn bg-[#333] px-3 py-1 rounded-lg" data-view="detalhada">
        Detalhada
      </button>
      <button class="view-btn bg-[#333] px-3 py-1 rounded-lg" data-view="lista">
        Lista
      </button>
      <button class="view-btn bg-[#333] px-3 py-1 rounded-lg" data-view="ano">
        Temporada
      </button>
    </div>

    <section id="main-content" class="text-center text-gray-400 p-4">
      <p>Carregando dados...</p>
    </section>
  </main>


</div>

<!-- MENU INFERIOR -->
<nav class="menu fixed bottom-0 left-0 w-full bg-[#151515] border-t border-[#2a2a2a] flex justify-around py-2 z-40">
    
    <button class="menu-btn" onclick="window.location.href='animes_manager.html'">
        <i data-lucide="home" class="w-6 h-6 mb-1"></i>
        <span class="text-[10px]">In√≠cio</span>
    </button>

    <button class="menu-btn" onclick="window.location.href='animes_cadastro.html'">
        <i data-lucide="file-edit" class="w-6 h-6 mb-1"></i>
        <span class="text-[10px]">Gest√£o</span>
    </button>

    <button class="menu-btn" onclick="window.location.href='anime_lista.html'">
        <i data-lucide="list" class="w-6 h-6 mb-1"></i>
        <span class="text-[10px]">Lista</span>
    </button>

    <div class="relative flex">
        <button id="more-options-btn" class="menu-btn active" onclick="toggleMoreOptions(event)">
            <i data-lucide="more-horizontal" class="w-6 h-6 mb-1"></i>
            <span class="text-[10px]">Mais</span>
        </button>

        <div id="more-options-dropdown"
             class="absolute bottom-full mb-3 right-0 w-48 bg-[#1f1f1f] border border-[#333] rounded-xl shadow-2xl p-1 hidden z-50 flex flex-col">

            <button class="w-full text-left px-4 py-3 text-sm bg-[#2a2a2a] text-white rounded-lg transition-colors flex items-center gap-3 border border-[#333]" 
                    onclick="window.location.href='animes_classificacoes.html'">
                <i data-lucide="bar-chart-2" class="w-4 h-4 text-[#B9314F] fill-current"></i> 
                <span class="font-bold">Classifica√ß√£o</span>
            </button>
            
            <button class="w-full text-left px-4 py-3 text-sm text-gray-300 hover:bg-[#2a2a2a] hover:text-white rounded-lg transition-colors flex items-center gap-3" 
                    onclick="window.location.href='animes_estrelas.html'">
                <i data-lucide="star" class="w-4 h-4 text-[#B9314F]"></i> 
                <span>Estrelas</span>
            </button>
            
           <button class="w-full text-left px-4 py-3 text-sm text-gray-300 hover:bg-[#2a2a2a] hover:text-white rounded-lg transition-colors flex items-center gap-3" 
                    onclick="window.location.href='animes_torneio.html'">
                <i data-lucide="trophy" class="w-4 h-4 text-[#B9314F]"></i> 
                <span>Torneio</span>
            </button>

            <button class="w-full text-left px-4 py-3 text-sm text-gray-300 hover:bg-[#2a2a2a] hover:text-white rounded-lg transition-colors flex items-center gap-3" 
                    onclick="window.location.href='animes_serie.html'">
                <i data-lucide="layers" class="w-4 h-4 text-[#B9314F]"></i> 
                <span>Serie</span>
            </button>

            <button class="w-full text-left px-4 py-3 text-sm text-gray-300 hover:bg-[#2a2a2a] hover:text-white rounded-lg transition-colors flex items-center gap-3" 
                    onclick="window.location.href='animes_database.html'">
                <i data-lucide="layers" class="w-4 h-4 text-[#B9314F]"></i> 
                <span>DataBase</span>
            </button>
        </div>
    </div>
</nav>

<script>
  lucide.createIcons();
  function abrirPagina(pagina) {
    window.location.href = pagina;
  }
</script>

<!-- FIRESTORE + CLASSIFICA√á√ÉO -->
<script type="module">
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDsbiLPBOda119Qr6Ji69j8TZLpiFixBWI",
    authDomain: "list-games-9bddd.firebaseapp.com",
    projectId: "list-games-9bddd",
    storageBucket: "list-games-9bddd.firebasestorage.app",
    messagingSenderId: "756898313156",
    appId: "1:756898313156:web:9bc660d0a2f4cd07882a91",
    measurementId: "G-GLM50YVLXP"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const mainContent = document.getElementById("main-content");
  const viewButtons = document.querySelectorAll(".view-btn");
  let allAnimes = [];
  let currentView = "detalhada";
  let lastOpenedSeason = null;

  const views = {
    detalhada() {
      const sorted = [...allAnimes].sort((a,b) => b.NOTA_F - a.NOTA_F);

      const html = sorted.map((anime, index) => `
        <div 
          class="flex items-center gap-3 mb-3 bg-[#181818] p-3 rounded-lg shadow cursor-pointer hover:bg-[#222] transition-all"
          onclick="showAnime(${index})"
        >
          <!-- Imagem quadrada -->
          <div class="w-20 h-20 flex-shrink-0">
            <img src="${anime.IMAGEM}" 
                class="w-full h-full object-cover rounded-lg"
                alt="${anime.NOME}">
          </div>

          <!-- Informa√ß√µes -->
          <div class="flex-1 text-left overflow-hidden">

            <!-- Numera√ß√£o + Nome -->
            <div class="flex items-center gap-2">
              <span class="bg-[#B9314F] text-white text-xs font-bold px-2 py-1 rounded-md">${index + 1}</span>

              <!-- Nome com limite maior antes de truncar -->
              <h3 class="font-bold text-lg truncate max-w-[350px]">
                ${anime.NOME}
              </h3>
            </div>

            <!-- Nota -->
            <p class="text-gray-300 text-sm mt-1">
              Nota: <span class="text-white font-semibold">${Number(anime.NOTA_F).toFixed(2)}</span>
            </p>

          </div>
        </div>
      `).join("");

      mainContent.innerHTML = html;
    },
    lista() {
      const sorted = [...allAnimes].sort((a,b) => b.NOTA_F - a.NOTA_F);

      const html = sorted.map((anime, index) => `
        <div class="border-b border-[#222] py-2 text-left cursor-pointer hover:bg-[#222] p-2 rounded-md"
            onclick="showAnime(${index})">
          <span class="text-[#B9314F] font-bold">${index + 1}.</span>
          <strong class="ml-2">${anime.NOME}</strong>
          <span class="opacity-70 ml-3">(${Number(anime.NOTA_F).toFixed(2)})</span>
        </div>
      `).join("");

      mainContent.innerHTML = html;
    },
    ano() {
      if (!allAnimes.length) return;

      let searchHTML = `
        <div class="w-full mb-4 mt-2">
          <input
            id="search-season-input"
            type="text"
            placeholder="Pesquisar temporada..."
            class="w-full px-3 py-2 bg-[#151515] border border-[#333] rounded-md text-white placeholder-gray-400 focus:outline-none focus:border-[#B9314F]"
          />
        </div>
      `;

      const grouped = {};

      allAnimes.forEach(anime => {
        const ano = anime.ANO;
        const tempStr = anime.TEMPORADA || "";
        let seasonName = "Outro";

        if (tempStr.includes("Inverno")) seasonName = "Inverno";
        else if (tempStr.includes("Primavera")) seasonName = "Primavera";
        else if (tempStr.includes("Ver√£o")) seasonName = "Ver√£o";
        else if (tempStr.includes("Outono")) seasonName = "Outono";

        const groupKey = (seasonName !== "Outro" && ano) ?
          `${seasonName} ${ano}` : "Outro";

        if (!grouped[groupKey]) {
          grouped[groupKey] = { total: 0, count: 0 };
        }

        grouped[groupKey].total += anime.NOTA_F;
        grouped[groupKey].count++;
      });

      const ranked = Object.entries(grouped)
        .map(([nome, info]) => ({
          nome,
          media: info.total / info.count,
          qtd: info.count
        }))
        .sort((a, b) => b.media - a.media);

      const html = ranked.map((t, index) => `
        <div 
          onclick="showSeason('${t.nome}')"
          class="border-b border-[#222] py-2 text-left cursor-pointer hover:bg-[#222] transition-all"
        >
          <span class="text-[#B9314F] font-bold">${index + 1}.</span>
          <strong class="ml-2">${t.nome}</strong>
          <span class="opacity-70 ml-3">(${t.media.toFixed(2)})</span>
          <span class="opacity-50 ml-2 text-xs">${t.qtd} animes</span>
        </div>
      `).join("");

      mainContent.innerHTML = `
        ${searchHTML}
        <div id="season-list">${html}</div>
      `;

      mainContent.innerHTML = `
        ${searchHTML}
        <div id="season-list">${html}</div>
      `;

      const searchInput = document.getElementById("search-season-input");
      const listContainer = document.getElementById("season-list");

      searchInput.addEventListener("input", () => {
        const text = searchInput.value.toLowerCase().trim();

        const filtered = ranked.filter(s =>
          s.nome.toLowerCase().includes(text)
        );

        const filteredHTML = filtered.map((t, index) => `
          <div 
            onclick="showSeason('${t.nome}')"
            class="border-b border-[#222] py-2 text-left cursor-pointer hover:bg-[#222] transition-all"
          >
            <span class="text-[#B9314F] font-bold">${index + 1}.</span>
            <strong class="ml-2">${t.nome}</strong>
            <span class="opacity-70 ml-3">(${t.media.toFixed(2)})</span>
            <span class="opacity-50 ml-2 text-xs">${t.qtd} animes</span>
          </div>
        `).join("");

        listContainer.innerHTML = filteredHTML || `<p class="text-gray-400 mt-4">Nenhuma temporada encontrada.</p>`;
      });
    },
  };

  function toggleMoreOptions(event) {
      event.stopPropagation(); // Previne que o clique feche imediatamente
      const dropdown = document.getElementById('more-options-dropdown');
      dropdown.classList.toggle('hidden');
  }

  // Fun√ß√£o para fechar o dropdown se o usu√°rio clicar fora dele
  document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('more-options-dropdown');
      const button = document.getElementById('more-options-btn');
      if (dropdown && button && !button.contains(e.target) && !dropdown.contains(e.target)) {
          dropdown.classList.add('hidden');
      }
  });
  
  window.toggleMoreOptions = toggleMoreOptions;
  function switchView(view) {
    currentView = view;
    window.currentView = view;
    
    // NOVO: Se mudar de aba principal, esquece a temporada anterior
    if (view !== 'ano') {
        lastOpenedSeason = null;
    }
    
    viewButtons.forEach(btn => btn.classList.remove("bg-[#B9314F]", "font-bold"));
    document.querySelector(`[data-view="${view}"]`)
      .classList.add("bg-[#B9314F]", "font-bold");
    views[view]();
  }

  function showAnime(index) {
    const sorted = [...allAnimes].sort((a,b) => b.NOTA_F - a.NOTA_F);
    const anime = sorted[index];

    // L√ìGICA INTELIGENTE DO BOT√ÉO VOLTAR
    // Se estivermos na aba 'ano' e tivermos uma temporada salva, volta para ela.
    // Caso contr√°rio, volta para a visualiza√ß√£o padr√£o.
    let backAction = `window.switchView('${currentView}')`;
    if (currentView === 'ano' && lastOpenedSeason) {
        backAction = `window.showSeason('${lastOpenedSeason}')`;
    }

    mainContent.innerHTML = `
      <div class="bg-[#181818] p-4 rounded-lg shadow-lg max-w-md mx-auto text-center">

        <img src="${anime.IMAGEM}"
          alt="${anime.NOME}"
          class="mx-auto object-cover rounded-md mb-3"
          style="width: 60%; aspect-ratio: 2/3;"
        >

        <h2 class="text-xl text-white font-bold mb-3">${anime.NOME}</h2>

        <div class="text-left text-sm text-gray-300 space-y-1">
          <p><span class="font-semibold text-white">Nota:</span> ${Number(anime.NOTA_F).toFixed(2)}</p>
          <p><span class="font-semibold text-white">Nota MAL:</span> ${anime.N_MAL || "-"}</p>
          <p><span class="font-semibold text-white">Stars:</span> ${anime.STARS || "-"}</p>
          <p><span class="font-semibold text-white">Temporada:</span> ${anime.TEMPORADA || "-"}</p>
          <p><span class="font-semibold text-white">Ano:</span> ${anime.ANO || "-"}</p>
        </div>

        <button onclick="${backAction}"
          class="mt-4 px-4 py-1 bg-[#B9314F] rounded-md font-bold text-sm text-white hover:bg-[#992743]">
          Voltar
        </button>

      </div>
    `;
  }

  // Torna acess√≠vel no HTML:
  window.showAnime = showAnime;
  window.currentView = currentView;
  window.switchView = switchView;

  window.showSeason = function(seasonName) {
      lastOpenedSeason = seasonName;

      // 1. Filtra os animes da temporada
      const animesDaTemporada = allAnimes.filter(a => {
          const year = a.ANO;
          const temp = a.TEMPORADA || "";
          if (seasonName === "Outro") {
              return (!year || !temp ||
                  (!temp.includes("Inverno") &&
                  !temp.includes("Primavera") &&
                  !temp.includes("Ver√£o") &&
                  !temp.includes("Outono")));
          }
          const tempGroup = `${temp.split(" (")[0]} ${year}`;
          return tempGroup === seasonName;
      });

      // 2. Ordena a lista da temporada para exibi√ß√£o
      animesDaTemporada.sort((a, b) => b.NOTA_F - a.NOTA_F);

      // 3. NOVA FUN√á√ÉO DE BUSCA: Garante que o showAnime receba o index da lista GLOBAL ORDENADA
      window.showAnimeByNum = function(num) {
          // Criamos a lista global exatamente como o showAnime(index) espera receber
          const globalSorted = [...allAnimes].sort((a, b) => b.NOTA_F - a.NOTA_F);
          
          // Procuramos o index baseado no NUM (que √© √∫nico)
          const targetIndex = globalSorted.findIndex(a => Number(a.Num) === Number(num));
          
          if (targetIndex !== -1) {
              showAnime(targetIndex);
          } else {
              console.error("Anime n√£o encontrado no cache global:", um);
          }
      };

      const html = `
        <div class="text-left mb-3">
          <h2 class="text-xl font-bold text-white">${seasonName}</h2>
        </div>

        ${animesDaTemporada.map((anime, index) => {
          return `
          <div 
            class="flex justify-between items-center border-b border-[#222] py-2 cursor-pointer hover:bg-[#222]"
            onclick="showAnimeByNum(${anime.Num})"
          >
            <span class="font-bold text-[#B9314F]">${index + 1}.</span>
            <span class="flex-1 ml-3 truncate text-left">${anime.NOME}</span>
            <span class="opacity-70 ml-3 font-semibold">${Number(anime.NOTA_F).toFixed(2)}</span>
          </div>
        `}).join("")}

        <button onclick="window.switchView('ano')"
          class="mt-4 px-4 py-1 bg-[#B9314F] rounded-md font-bold text-sm text-white hover:bg-[#992743]">
          Voltar
        </button>
      `;

      mainContent.innerHTML = html;
  };

  // --- FUN√á√ÉO CARREGAR TUDO (OTIMIZADA COM CACHE) ---
  async function loadAll() {
    const user = auth.currentUser;
    if (!user) return;

    const cacheKey = `animes_${user.uid}`;
    const cachedData = localStorage.getItem(cacheKey);

    if (cachedData) {
      // üì¶ Carrega do Cache Local (Economiza leituras no Firebase)
      console.log("üì¶ Classifica√ß√µes: Carregando dados do Cache.");
      allAnimes = JSON.parse(cachedData);
    } else {
      // üî• Fallback: Busca no Firebase se o cache estiver vazio
      console.log("üî• Classifica√ß√µes: Cache vazio, buscando no Firebase...");
      try {
        const ref = collection(db, "users", user.uid, "animes");
        const docs = await getDocs(ref);
        allAnimes = docs.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        // Salva para as pr√≥ximas p√°ginas n√£o precisarem ler do banco
        localStorage.setItem(cacheKey, JSON.stringify(allAnimes));
      } catch (error) {
        console.error("Erro ao buscar dados:", error);
      }
    }

    // Inicia a visualiza√ß√£o ap√≥s carregar os dados (seja do cache ou banco)
    switchView("detalhada");
  }

  window.switchView = switchView;

  // --- ESCUTADOR DE AUTENTICA√á√ÉO ---
  onAuthStateChanged(auth, (user) => {
    const userEmailEl = document.getElementById("user-email");

    if (user) {
      if (userEmailEl) userEmailEl.textContent = user.email;
      // S√≥ chama o loadAll se o usu√°rio estiver logado
      loadAll();
    } else {
      // Se n√£o estiver autenticado volta para Login
      window.location.href = "index.html";
    }
  });

  window.switchView = switchView;

  viewButtons.forEach(btn => {
    btn.addEventListener("click", () => switchView(btn.dataset.view));
  });
</script>


</body>
</html>
