<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Class Animes</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    body {
      background: #0b0b0b;
      font-family: Inter, system-ui, sans-serif;
      color: #e6e6e6;
      padding-bottom: 100px; /* espaço para menu inferior */
    }

    .menu {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #151515;
      border-top: 1px solid #2a2a2a;
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
    }

    .menu-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #b3b3b3;
      font-size: 0.75rem;
      transition: all 0.2s;
    }

    .menu-btn:hover,
    .menu-btn.active {
      color: #B9314F;
    }

    .menu-btn svg {
      width: 22px;
      height: 22px;
      margin-bottom: 4px;
    }
  </style>
</head>
<body>

<div id="app" class="container mx-auto max-w-6xl px-4 pt-4">

  <!-- MENU SUPERIOR -->
  <header class="bg-[#1f1f1f] p-2 mb-3 shadow-xl rounded-xl border border-[#2a2a2a]">
    
    <!-- Linha 1 -->
    <div class="flex justify-between items-center">
      <button onclick="window.location.href='home.html'"
              class="text-2xl font-bold text-[#B9314F] hover:text-[#992743] transition-colors duration-200">
        My Hub
      </button>

      <h1 class="text-2xl font-bold text-white">My Animes</h1>
    </div>

    <!-- Linha 2 -->
    <div class="text-sm text-gray-300 mt-1">
      Usuário: <span id="user-email" class="text-[#B9314F] font-mono">Carregando...</span>
    </div>

  </header>


  <!-- CONTEÚDO DA PÁGINA -->
  <main class="mt-4">
    <!-- Menu das Visualizações -->
    <div id="view-menu" class="flex overflow-x-auto gap-3 p-2 bg-[#141414] border border-[#222] rounded-xl text-sm mb-4">
      <button class="view-btn bg-[#333] px-3 py-1 rounded-lg" data-view="detalhada">
        Detalhada
      </button>
      <button class="view-btn bg-[#333] px-3 py-1 rounded-lg" data-view="lista">
        Lista
      </button>
      <button class="view-btn bg-[#333] px-3 py-1 rounded-lg" data-view="ano">
        Temporada
      </button>
    </div>

    <section id="main-content" class="text-center text-gray-400 p-4">
      <p>Carregando dados...</p>
    </section>
  </main>


</div>

<!-- MENU INFERIOR -->
<nav class="menu">
    <button class="menu-btn" onclick="abrirPagina('animes_manager.html')">
        <i data-lucide="home"></i>
        <span>Início</span>
    </button>
    <button class="menu-btn" onclick="abrirPagina('animes_cadastro.html')">
        <i data-lucide="file-edit"></i>
        <span>Gestão</span>
    </button>
    <!-- Lista: Agora visível em todos os tamanhos de tela. -->
    <button class="menu-btn" onclick="abrirPagina('anime_lista.html')">
        <i data-lucide="list"></i>
        <span>Lista</span>
    </button>

    <!-- Classificação, Estrelas e Torneio estão permanentemente ocultos no menu principal,
         e serão acessíveis apenas pelo botão 'Mais'. -->
    <button class="menu-btn hidden" onclick="abrirPagina('animes_classificacoes.html')">
        <i data-lucide="bar-chart-2"></i>
        <span>Classificação</span>
    </button>
    <button class="menu-btn hidden" onclick="abrirPagina('animes_estrelas.html')">
        <i data-lucide="star"></i>
        <span>Estrelas</span>
    </button>
    <button class="menu-btn hidden" onclick="abrirPagina('animes_torneio.html')">
        <i data-lucide="trophy"></i>
        <span>Torneio</span>
    </button>

    <!-- Botão de Mais Opções (Dropdown) -->
    <!-- Removido 'sm:hidden' para que o botão 'Mais' seja sempre visível. -->
    <div class="relative flex">
        <button id="more-options-btn" class="menu-btn active" onclick="toggleMoreOptions(event)">
            <i data-lucide="more-horizontal"></i>
            <span>Mais</span>
        </button>

        <!-- Dropdown de Mais Opções -->
        <!-- ADICIONADO: 'flex flex-col' para empilhar os itens verticalmente -->
        <div id="more-options-dropdown"
             class="absolute bottom-full mb-2 right-0 w-40 bg-[#1f1f1f] border border-[#2a2a2a]
                    rounded-lg shadow-xl p-2 hidden z-50 flex flex-col">

            <!-- Lista foi removida daqui, pois agora está no menu principal. -->
            <!-- Adicionado 'text-left' para garantir o alinhamento do texto à esquerda dentro do botão. -->
            <button class="dropdown-item text-left" onclick="abrirPagina('animes_classificacoes.html')">
                <i data-lucide="bar-chart-2" class="w-4 h-4"></i> Classificação
            </button>
            <button class="dropdown-item text-left" onclick="abrirPagina('animes_estrelas.html')">
                <i data-lucide="star" class="w-4 h-4"></i> Estrelas
            </button>
            <button class="dropdown-item text-left" onclick="abrirPagina('animes_torneio.html')">
                <i data-lucide="trophy" class="w-4 h-4"></i> Torneio
            </button>
        </div>
    </div>
</nav>

<script>
  lucide.createIcons();
  function abrirPagina(pagina) {
    window.location.href = pagina;
  }
</script>

<!-- FIRESTORE + CLASSIFICAÇÃO -->
<script type="module">
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDsbiLPBOda119Qr6Ji69j8TZLpiFixBWI",
    authDomain: "list-games-9bddd.firebaseapp.com",
    projectId: "list-games-9bddd",
    storageBucket: "list-games-9bddd.firebasestorage.app",
    messagingSenderId: "756898313156",
    appId: "1:756898313156:web:9bc660d0a2f4cd07882a91",
    measurementId: "G-GLM50YVLXP"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const mainContent = document.getElementById("main-content");
  const viewButtons = document.querySelectorAll(".view-btn");
  let allAnimes = [];
  let currentView = "detalhada";

  const views = {
    detalhada() {
      const sorted = [...allAnimes].sort((a,b) => b.NOTA_F - a.NOTA_F);

      const html = sorted.map((anime, index) => `
        <div 
          class="flex items-center gap-3 mb-3 bg-[#181818] p-3 rounded-lg shadow cursor-pointer hover:bg-[#222] transition-all"
          onclick="showAnime(${index})"
        >
          <!-- Imagem quadrada -->
          <div class="w-20 h-20 flex-shrink-0">
            <img src="${anime.IMAGEM}" 
                class="w-full h-full object-cover rounded-lg"
                alt="${anime.NOME}">
          </div>

          <!-- Informações -->
          <div class="flex-1 text-left overflow-hidden">

            <!-- Numeração + Nome -->
            <div class="flex items-center gap-2">
              <span class="bg-[#B9314F] text-white text-xs font-bold px-2 py-1 rounded-md">${index + 1}</span>

              <!-- Nome com limite maior antes de truncar -->
              <h3 class="font-bold text-lg truncate max-w-[350px]">
                ${anime.NOME}
              </h3>
            </div>

            <!-- Nota -->
            <p class="text-gray-300 text-sm mt-1">
              Nota: <span class="text-white font-semibold">${Number(anime.NOTA_F).toFixed(2)}</span>
            </p>

          </div>
        </div>
      `).join("");

      mainContent.innerHTML = html;
    },
    lista() {
      const sorted = [...allAnimes].sort((a,b) => b.NOTA_F - a.NOTA_F);

      const html = sorted.map((anime, index) => `
        <div class="border-b border-[#222] py-2 text-left cursor-pointer hover:bg-[#222] p-2 rounded-md"
            onclick="showAnime(${index})">
          <span class="text-[#B9314F] font-bold">${index + 1}.</span>
          <strong class="ml-2">${anime.NOME}</strong>
          <span class="opacity-70 ml-3">(${Number(anime.NOTA_F).toFixed(2)})</span>
        </div>
      `).join("");

      mainContent.innerHTML = html;
    },
    ano() {
      if (!allAnimes.length) return;

      let searchHTML = `
        <div class="w-full mb-4 mt-2">
          <input
            id="search-season-input"
            type="text"
            placeholder="Pesquisar temporada..."
            class="w-full px-3 py-2 bg-[#151515] border border-[#333] rounded-md text-white placeholder-gray-400 focus:outline-none focus:border-[#B9314F]"
          />
        </div>
      `;

      const grouped = {};

      allAnimes.forEach(anime => {
        const ano = anime.ANO;
        const tempStr = anime.TEMPORADA || "";
        let seasonName = "Outro";

        if (tempStr.includes("Inverno")) seasonName = "Inverno";
        else if (tempStr.includes("Primavera")) seasonName = "Primavera";
        else if (tempStr.includes("Verão")) seasonName = "Verão";
        else if (tempStr.includes("Outono")) seasonName = "Outono";

        const groupKey = (seasonName !== "Outro" && ano) ?
          `${seasonName} ${ano}` : "Outro";

        if (!grouped[groupKey]) {
          grouped[groupKey] = { total: 0, count: 0 };
        }

        grouped[groupKey].total += anime.NOTA_F;
        grouped[groupKey].count++;
      });

      const ranked = Object.entries(grouped)
        .map(([nome, info]) => ({
          nome,
          media: info.total / info.count,
          qtd: info.count
        }))
        .sort((a, b) => b.media - a.media);

      const html = ranked.map((t, index) => `
        <div 
          onclick="showSeason('${t.nome}')"
          class="border-b border-[#222] py-2 text-left cursor-pointer hover:bg-[#222] transition-all"
        >
          <span class="text-[#B9314F] font-bold">${index + 1}.</span>
          <strong class="ml-2">${t.nome}</strong>
          <span class="opacity-70 ml-3">(${t.media.toFixed(2)})</span>
          <span class="opacity-50 ml-2 text-xs">${t.qtd} animes</span>
        </div>
      `).join("");

      mainContent.innerHTML = `
        ${searchHTML}
        <div id="season-list">${html}</div>
      `;

      mainContent.innerHTML = `
        ${searchHTML}
        <div id="season-list">${html}</div>
      `;

      const searchInput = document.getElementById("search-season-input");
      const listContainer = document.getElementById("season-list");

      searchInput.addEventListener("input", () => {
        const text = searchInput.value.toLowerCase().trim();

        const filtered = ranked.filter(s =>
          s.nome.toLowerCase().includes(text)
        );

        const filteredHTML = filtered.map((t, index) => `
          <div 
            onclick="showSeason('${t.nome}')"
            class="border-b border-[#222] py-2 text-left cursor-pointer hover:bg-[#222] transition-all"
          >
            <span class="text-[#B9314F] font-bold">${index + 1}.</span>
            <strong class="ml-2">${t.nome}</strong>
            <span class="opacity-70 ml-3">(${t.media.toFixed(2)})</span>
            <span class="opacity-50 ml-2 text-xs">${t.qtd} animes</span>
          </div>
        `).join("");

        listContainer.innerHTML = filteredHTML || `<p class="text-gray-400 mt-4">Nenhuma temporada encontrada.</p>`;
      });
    },
  };

  function toggleMoreOptions(event) {
      event.stopPropagation(); // Previne que o clique feche imediatamente
      const dropdown = document.getElementById('more-options-dropdown');
      dropdown.classList.toggle('hidden');
  }

  // Função para fechar o dropdown se o usuário clicar fora dele
  document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('more-options-dropdown');
      const button = document.getElementById('more-options-btn');
      if (dropdown && button && !button.contains(e.target) && !dropdown.contains(e.target)) {
          dropdown.classList.add('hidden');
      }
  });
  
  window.toggleMoreOptions = toggleMoreOptions;
  function switchView(view) {
    currentView = view;
    window.currentView = view;
    viewButtons.forEach(btn => btn.classList.remove("bg-[#B9314F]", "font-bold"));
    document.querySelector(`[data-view="${view}"]`)
      .classList.add("bg-[#B9314F]", "font-bold");
    views[view]();
  }

  function showAnime(index) {
    const sorted = [...allAnimes].sort((a,b) => b.NOTA_F - a.NOTA_F);
    const anime = sorted[index];

    mainContent.innerHTML = `
      <div class="bg-[#181818] p-4 rounded-lg shadow-lg max-w-md mx-auto text-center">

        <img src="${anime.IMAGEM}"
          alt="${anime.NOME}"
          class="mx-auto object-cover rounded-md mb-3"
          style="width: 60%; aspect-ratio: 2/3;"
        >

        <h2 class="text-xl text-white font-bold mb-3">${anime.NOME}</h2>

        <div class="text-left text-sm text-gray-300 space-y-1">
          <p><span class="font-semibold text-white">Nota:</span> ${Number(anime.NOTA_F).toFixed(2)}</p>
          <p><span class="font-semibold text-white">Nota MAL:</span> ${anime.N_MAL || "-"}</p>
          <p><span class="font-semibold text-white">Stars:</span> ${anime.STARS || "-"}</p>
          <p><span class="font-semibold text-white">Temporada:</span> ${anime.TEMPORADA || "-"}</p>
          <p><span class="font-semibold text-white">Ano:</span> ${anime.ANO || "-"}</p>
        </div>

        <button onclick="window.switchView(currentView)"
          class="mt-4 px-4 py-1 bg-[#B9314F] rounded-md font-bold text-sm text-white hover:bg-[#992743]">
          Voltar
        </button>

      </div>
    `;
  }

  // Torna acessível no HTML:
  window.showAnime = showAnime;
  window.currentView = currentView;
  window.switchView = switchView;

  window.showSeason = function(seasonName) {
    const animes = allAnimes.filter(a => {
      const year = a.ANO;
      const temp = a.TEMPORADA || "";

      if (seasonName === "Outro") {
        return (!year || !temp ||
          (!temp.includes("Inverno") &&
          !temp.includes("Primavera") &&
          !temp.includes("Verão") &&
          !temp.includes("Outono")));
      }

      const tempGroup = `${temp.split(" (")[0]} ${year}`;
      return tempGroup === seasonName;
    });

    function showAnimeById(id) {
      // cria a mesma ordenação usada por showAnime (ordem por nota decrescente)
      const sorted = [...allAnimes].sort((a, b) => b.NOTA_F - a.NOTA_F);
      const idx = sorted.findIndex(a => a.id === id);
      if (idx === -1) {
        console.warn('Anime não encontrado por id:', id);
        return;
      }
      // chama a função existente que renderiza o anime pelo índice na lista ordenada
      showAnime(idx);
    }
    window.showAnimeById = showAnimeById;

    // --- Ordenar os animes pela nota (decrescente) ---
    animes.sort((a, b) => b.NOTA_F - a.NOTA_F);

    const html = `
      <div class="text-left mb-3">
        <h2 class="text-xl font-bold text-white">${seasonName}</h2>
      </div>

      ${animes.map((anime, index) => `
        <div 
          class="flex justify-between items-center border-b border-[#222] py-2 cursor-pointer hover:bg-[#222]"
          onclick="showAnimeById('${anime.id.replace(/'/g,"\\'")}')"
        >
          <span class="font-bold text-[#B9314F]">${index + 1}.</span>
          <span class="flex-1 ml-3 truncate text-left">${anime.NOME}</span>
          <span class="opacity-70 ml-3 font-semibold">${anime.NOTA_F.toFixed(2)}</span>
        </div>
      `).join("")}

      <button onclick="window.switchView('ano')"
        class="mt-4 px-4 py-1 bg-[#B9314F] rounded-md font-bold text-sm text-white hover:bg-[#992743]">
        Voltar
      </button>
    `;

    mainContent.innerHTML = html;
  }

  async function loadAll() {
    const user = auth.currentUser;
    if (!user) return;

    const ref = collection(db, "users", user.uid, "animes");
    const docs = await getDocs(ref);

    allAnimes = docs.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    switchView("detalhada");
  }

  window.switchView = switchView;

  onAuthStateChanged(auth, (user) => {
    const userEmailEl = document.getElementById("user-email");

    if (user) {
      userEmailEl.textContent = user.email;
    } else {
      // Se não estiver autenticado volta para Login
      window.location.href = "index.html";
    }
    loadAll();
  })

  viewButtons.forEach(btn => {
    btn.addEventListener("click", () => switchView(btn.dataset.view));
  });
</script>


</body>
</html>
