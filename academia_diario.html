<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gerenciador ‚Äî Di√°rio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: Inter, system-ui, sans-serif; background:#0b0b0b; color:#e6e6e6; }
    .card { background:#151515; border:1px solid #2a2a2a; transition:all .2s; }
    .card:hover { border-color:#B9314F; transform:translateY(-4px); }
    .btn-primary { background:#B9314F; }
    .btn-primary:hover { background:#99233b; }
  </style>
</head>
<body class="min-h-screen">
  <!-- LOADING -->
  <div id="loading" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60">
    <div class="animate-spin h-16 w-16 border-4 border-t-transparent border-[#B9314F] rounded-full"></div>
  </div>

  <!-- APP -->
  <div id="app" class="container mx-auto p-6 max-w-6xl hidden">
    <header class="flex flex-col sm:flex-row items-center justify-between mb-6 gap-3">
      <div>
        <h1 class="text-3xl font-bold">Di√°rio de Treino</h1>
        <div class="text-sm text-gray-400 mt-1">
          Usu√°rio: <span id="user-email" class="text-[#B9314F] font-mono"></span>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button onclick="window.location.href='home.html'" class="px-3 py-1 rounded btn-primary text-white">Home</button>
        <button id="logout-btn" class="px-3 py-1 rounded bg-red-600 hover:bg-red-700">Sair</button>
      </div>
    </header>

    <!-- NAV -->
    <nav class="flex gap-4 mb-6 border-b border-gray-800 pb-3 flex-wrap">
      <button class="text-lg font-medium" onclick="window.location.href='academia_exercicios.html'">Exerc√≠cios</button>
      <button class="text-lg font-medium" onclick="window.location.href='academia_grupos.html'">Grupos</button>
      <button class="text-lg font-medium text-[#B9314F]" onclick="window.location.href='academia_diario.html'">Di√°rio</button>
    </nav>

    <div class="flex justify-end mb-4">
      <button id="btn-registrar" class="px-3 py-1 rounded btn-primary hover:bg-[#99233b]">Registrar Treino</button>
    </div>

    <div id="treinos-lista" class="space-y-3"></div>
  </div>

  <!-- MODAL -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-70 z-50 overflow-auto">
    <div class="bg-gray-900 rounded-lg w-11/12 max-w-3xl p-6 mb-10">
      <h2 class="text-xl font-semibold text-white mb-4">Registrar Treino</h2>
      <form id="form-treino" class="space-y-4">
        <div>
          <label class="block text-sm mb-1">Data</label>
          <input id="treino-data" type="date" class="w-full p-2 rounded bg-gray-800 border border-gray-700 text-white">
        </div>
        <div>
          <label class="block text-sm mb-1">Grupo</label>
          <select id="treino-grupo" class="w-full p-2 rounded bg-gray-800 border border-gray-700 text-white"></select>
        </div>
        <div id="exercicios-detalhes" class="space-y-4 hidden"></div>
        <div class="flex flex-col sm:flex-row justify-end gap-3 mt-4">
          <button id="salvar-treino" class="px-4 py-2 rounded btn-primary hover:bg-[#99233b]">Salvar</button>
          <button id="cancelar" type="button" class="px-4 py-2 rounded bg-gray-700 hover:bg-gray-600">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import {
      getFirestore, collection, getDocs, addDoc, onSnapshot,
      query, doc, getDoc, where, orderBy, limit, deleteDoc
    } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDsbiLPBOda119Qr6Ji69j8TZLpiFixBWI",
      authDomain: "list-games-9bddd.firebaseapp.com",
      projectId: "list-games-9bddd",
      storageBucket: "list-games-9bddd.appspot.com",
      messagingSenderId: "756898313156",
      appId: "1:756898313156:web:9bc660d0a2f4cd07882a91",
      measurementId: "G-GLM50YVLXP"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const loading = document.getElementById('loading');
    const appEl = document.getElementById('app');
    const userEmailEl = document.getElementById('user-email');
    const logoutBtn = document.getElementById('logout-btn');
    const modal = document.getElementById('modal');
    const btnRegistrar = document.getElementById('btn-registrar');
    const cancelar = document.getElementById('cancelar');
    const treinoGrupo = document.getElementById('treino-grupo');
    const treinoData = document.getElementById('treino-data');
    const exerciciosDetalhes = document.getElementById('exercicios-detalhes');
    const listaTreinos = document.getElementById('treinos-lista');
    const formTreino = document.getElementById('form-treino');

    let uid = null;
    let grupos = [];

    // Busca √∫ltimo treino do grupo (com fallback seguro)
    async function buscarUltimoTreinoGrupo(grupoId) {
      try {
        const q = query(
          collection(db, 'users', uid, 'academia_diario'),
          where('groupId', '==', grupoId),
          orderBy('date', 'desc'),
          limit(1)
        );
        const snap = await getDocs(q);
        if (snap.empty) return null;
        return { id: snap.docs[0].id, ...snap.docs[0].data() };
      } catch (err) {
        console.warn('Query orderBy/where falhou (fallback). Erro:', err.message || err);
        // fallback: buscar todos os treinos e filtrar/ordenar no cliente
        const allSnap = await getDocs(collection(db, 'users', uid, 'academia_diario'));
        const arr = [];
        allSnap.forEach(d => arr.push({ id: d.id, ...d.data() }));
        const filtered = arr.filter(x => x.groupId === grupoId);
        if (!filtered.length) return null;
        filtered.sort((a,b) => new Date(b.date) - new Date(a.date));
        return filtered[0];
      }
    }

    async function carregarGrupos() {
      const snap = await getDocs(collection(db, 'users', uid, 'academia_grupos'));
      grupos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      treinoGrupo.innerHTML = '<option value="">Selecione um grupo</option>';
      grupos.forEach(g => {
        const opt = document.createElement('option');
        opt.value = g.id;
        opt.textContent = g.name;
        treinoGrupo.appendChild(opt);
      });
    }

    async function carregarExercicioPorId(id) {
      const ref = doc(db, 'users', uid, 'academia_exercicios', id);
      const snap = await getDoc(ref);
      return snap.exists() ? { id: snap.id, ...snap.data() } : null;
    }

    // Ao trocar de grupo, mostrar exerc√≠cios + √∫ltima repeti√ß√£o do √∫ltimo treino (fallback seguro)
    treinoGrupo.addEventListener('change', async () => {
      try {
        const grupo = grupos.find(g => g.id === treinoGrupo.value);
        if (!grupo) {
          exerciciosDetalhes.classList.add('hidden');
          exerciciosDetalhes.innerHTML = '';
          return;
        }
        exerciciosDetalhes.classList.remove('hidden');
        exerciciosDetalhes.innerHTML = '';

        // buscar √∫ltimo treino desse grupo (pode retornar null)
        const ultimoTreino = await buscarUltimoTreinoGrupo(grupo.id);

        for (const ex of (grupo.exercises || []).slice().sort((a,b)=> (a.order||0) - (b.order||0))) {
          const exData = await carregarExercicioPorId(ex.id);
          if (!exData) continue;

          // pegar √∫ltima repeti√ß√£o daquele exerc√≠cio (do √∫ltimo treino do grupo)
          let ultimaRepeticao = '-';
          if (ultimoTreino?.exercises) {
            const ultimoEx = ultimoTreino.exercises.find(e => e.id === ex.id);
            if (ultimoEx && Array.isArray(ultimoEx.repsDia) && ultimoEx.repsDia.length) {
              ultimaRepeticao = ultimoEx.repsDia.join(', ');
            }
          }

          const card = document.createElement('div');
          card.className = 'p-3 border border-gray-700 rounded flex gap-4 items-start flex-wrap sm:flex-nowrap';
          card.innerHTML = `
            <img src='${exData.image || 'https://placehold.co/100x100/2a2a2a/e0e0e0?text=IMG'}'
                 class='w-24 h-24 rounded object-cover border border-gray-700'>
            <div class='flex-1 min-w-[220px]'>
              <h4 class='text-lg font-semibold text-[#B9314F] mb-1'>${exData.name}</h4>
              <p class='text-sm text-gray-400'>Repeti√ß√µes padr√£o: ${exData.reps || exData.repeticoes || '-' } | S√©ries: ${exData.series || '-'}</p>
              <p class='text-sm text-gray-400'>Peso: ${exData.weight || exData.peso || '-'} kg | Tempo: ${exData.time || exData.tempo || '-'} s</p>
              <p class='text-sm text-gray-400'>√öltima Repeti√ß√£o: ${ultimaRepeticao}</p>
              <div id='reps-${ex.id}' class='mt-2 flex flex-wrap gap-2'></div>
            </div>`;

          exerciciosDetalhes.appendChild(card);

          // adicionar inputs para cada s√©rie (valores em branco para registrar o dia atual)
          const repsDiv = card.querySelector(`#reps-${ex.id}`);
          const seriesCount = parseInt(exData.series) || 1;
          for (let i = 0; i < seriesCount; i++) {
            const input = document.createElement('input');
            input.type = 'number';
            input.min = '0';
            input.placeholder = `S√©rie ${i+1}`;
            input.className = 'p-2 w-28 rounded bg-gray-800 border border-gray-700 text-white';
            input.dataset.exerciseId = ex.id;
            input.dataset.serieIndex = i;
            repsDiv.appendChild(input);
          }
        }
      } catch (err) {
        console.error('Erro ao renderizar exerc√≠cios do grupo:', err);
        exerciciosDetalhes.innerHTML = `<p class="text-sm text-red-400">Erro ao carregar exerc√≠cios: ${err.message || err}</p>`;
      }
    });

    // salvar treino
    formTreino.addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const grupo = grupos.find(g => g.id === treinoGrupo.value);
        if (!grupo) return alert('Selecione um grupo v√°lido.');

        const exerciciosSalvos = [];
        for (const ex of (grupo.exercises || []).slice().sort((a,b)=> (a.order||0)-(b.order||0))) {
          const exData = await carregarExercicioPorId(ex.id);
          if (!exData) continue;
          const repsInputs = Array.from(document.querySelectorAll(`#reps-${ex.id} input`));
          const repsDia = repsInputs.map(i => i.value ? parseInt(i.value) : 0);
          exerciciosSalvos.push({
            id: ex.id,
            name: exData.name,
            image: exData.image || null,
            weight: exData.weight || null,
            time: exData.time || null,
            series: exData.series || null,
            repsTemplate: exData.reps || null,
            repsDia
          });
        }

        await addDoc(collection(db, 'users', uid, 'academia_diario'), {
          date: treinoData.value || new Date().toISOString().slice(0,10),
          groupName: grupo.name,
          groupId: grupo.id,
          observation: '',
          exercises: exerciciosSalvos,
          createdAt: new Date()
        });

        modal.classList.add('hidden');
        formTreino.reset();
        exerciciosDetalhes.innerHTML = '';
        alert('Treino salvo com sucesso!');
      } catch (err) {
        console.error('Erro ao salvar treino:', err);
        alert('Erro ao salvar treino: ' + (err.message || err));
      }
    });

    // render card e listeners para editar/excluir
    function renderTreinoCard(t) {
      return `
        <div class="card p-3 sm:p-4 rounded-xl flex flex-wrap sm:flex-nowrap items-center justify-between gap-2 sm:gap-4">
          <div class="flex items-center gap-3 flex-wrap">
            <h3 class="text-base sm:text-lg font-semibold">${t.groupName}</h3>
            <span class="text-sm text-gray-400">${t.date}</span>
          </div>
          <div class="flex gap-2">
            <button class="px-3 py-1 rounded bg-blue-600 hover:bg-blue-700 text-white text-sm" data-edit="${t.id}">Editar</button>
            <button class="px-3 py-1 rounded bg-red-600 hover:bg-red-700 text-white text-sm" data-del="${t.id}">Excluir</button>
          </div>
        </div>`;
    }

    // carregar treinos e anexar listeners
    function carregarTreinos() {
      // uso onSnapshot para atualiza√ß√µes em tempo real
      onSnapshot(collection(db, 'users', uid, 'academia_diario'), (snap) => {
        listaTreinos.innerHTML = '';
        if (snap.empty) {
          listaTreinos.innerHTML = `<p class="text-gray-500 text-center">Nenhum treino registrado ainda.</p>`;
          return;
        }
        const arr = [];
        snap.forEach(d => arr.push({ id: d.id, ...d.data() }));
        // ordenar por data descendente (mais recente primeiro)
        arr.sort((a,b) => new Date(b.date) - new Date(a.date));
        arr.forEach(t => listaTreinos.insertAdjacentHTML('beforeend', renderTreinoCard(t)));

        // anexar listeners dinamicamente
        document.querySelectorAll('[data-del]').forEach(btn => {
          btn.onclick = async () => {
            const id = btn.dataset.del;
            if (!confirm('Deseja excluir este treino?')) return;
            try {
              await deleteDoc(doc(db, 'users', uid, 'academia_diario', id));
            } catch (err) {
              console.error('Erro excluir treino:', err);
              alert('Erro ao excluir: ' + (err.message || err));
            }
          };
        });

        document.querySelectorAll('[data-edit]').forEach(btn => {
            btn.onclick = async () => {
                const id = btn.dataset.edit;
                try {
                const ref = doc(db, 'users', uid, 'academia_diario', id);
                const snap = await getDoc(ref);
                if (!snap.exists()) { alert('Treino n√£o encontrado'); return; }
                const treino = snap.data();
                treinoData.value = treino.date;
                treinoGrupo.value = treino.groupId;
                modal.classList.remove('hidden');

                // üîπ Aguarda renderiza√ß√£o completa dos exerc√≠cios antes de preencher
                await new Promise(async (resolve) => {
                    await treinoGrupo.dispatchEvent(new Event('change'));
                    const checkInterval = setInterval(() => {
                    const ready = treino.exercises.every(ex => document.querySelector(`#reps-${ex.id}`));
                    if (ready) {
                        clearInterval(checkInterval);
                        resolve();
                    }
                    }, 150);
                });

                // üîπ Preenche os valores corretos em cada s√©rie de cada exerc√≠cio
                for (const exItem of (treino.exercises || [])) {
                    const inputs = Array.from(document.querySelectorAll(`#reps-${exItem.id} input`));
                    const repsDia = exItem.repsDia || [];
                    inputs.forEach((inp, idx) => {
                    inp.value = repsDia[idx] ?? '';
                    });
                }

                } catch (err) {
                console.error('Erro ao editar treino:', err);
                alert('Erro ao abrir edi√ß√£o: ' + (err.message || err));
                }
            };
        });
      }, (err) => {
        console.error('Erro onSnapshot treinos:', err);
        listaTreinos.innerHTML = `<p class="text-red-400">Erro ao carregar treinos: ${err.message || err}</p>`;
      });
    }

    // eventos do modal
    btnRegistrar.addEventListener('click', () => {
      formTreino.reset();
      exerciciosDetalhes.innerHTML = '';
      exerciciosDetalhes.classList.add('hidden');
      modal.classList.remove('hidden');
    });
    cancelar.addEventListener('click', () => modal.classList.add('hidden'));

    // auth init
    onAuthStateChanged(auth, async (user) => {
      if (!user) { window.location.href = 'index.html'; return; }
      uid = user.uid;
      userEmailEl.textContent = user.email || user.uid;
      try {
        await carregarGrupos();
        carregarTreinos();
      } catch (err) {
        console.error('Erro init:', err);
      } finally {
        loading.classList.add('hidden');
        appEl.classList.remove('hidden');
      }
    });

    logoutBtn.addEventListener('click', async () => { await signOut(auth); window.location.href = 'index.html'; });
  </script>
</body>
</html>
