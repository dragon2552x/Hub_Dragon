<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="referrer" content="no-referrer">
    
    <title>Gerenciador de Cards</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&display=swap');
        
        body { background: #0b0b0b; color: #e6e6e6; font-family: 'Inter', sans-serif; padding-bottom: 100px; user-select: none; }
        .container { max-width: 1600px; margin: 0 auto; padding: 2rem; }
        
        /* Navega√ß√£o */
        .page-nav { display: flex; gap: 1rem; justify-content: center; margin-bottom: 2rem; border-bottom: 1px solid #333; padding-bottom: 1rem; }
        .page-link { padding: 0.5rem 1.5rem; color: #888; text-decoration: none; border-radius: 8px; font-weight: bold; transition: 0.3s; }
        .page-link:hover { color: #fff; background: #222; }
        .page-link.active { color: #0b0b0b; background: #d4af37; }

        /* Inputs */
        input, select { width: 100%; background: #222; border: 1px solid #444; color: white; padding: 0.6rem; border-radius: 6px; outline: none; font-size: 0.9rem; }
        input:focus { border-color: #d4af37; }
        label { display: block; margin-bottom: 0.2rem; font-size: 0.75rem; color: #aaa; font-weight: bold; text-transform: uppercase; }
        
        /* Card Preview Wrapper */
        .preview-wrapper { 
            background: #111; 
            border-radius: 12px; 
            padding: 20px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            border: 1px solid #333; 
            min-height: 500px;
        }

        /* O CONTAINER DO CARD (A "FOLHA" DE PAPEL) */
        .card-preview-container { 
            position: relative; 
            overflow: hidden; 
            box-shadow: 0 0 40px rgba(0,0,0,0.5);
            border-radius: 12px; /* Arredondamento do card f√≠sico */
            transition: width 0.3s, height 0.3s;
            background-color: #1a1a1a; /* Cor base caso n√£o tenha imagem */
        }
        .card-preview-container.vertical { width: 340px; height: 476px; } /* Propor√ß√£o ~ 2.5/3.5 */
        .card-preview-container.horizontal { width: 476px; height: 340px; }

        /* CAMADAS (LAYERS) - ORDEM IMPORTA MUITO AQUI */
        .layer { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; }
        
        .layer-bg { z-index: 1; }     /* Fundo */
        .layer-char { z-index: 2; }   /* Personagem */
        .layer-frame { z-index: 3; }  /* Moldura */
        .layer-text { z-index: 4; }   /* Textos */
        .layer-overlay { z-index: 5; pointer-events: none; border: 1px solid rgba(255,255,255,0.1); } /* Brilho/Acabamento */

        /* Elementos de Texto */
        .text-element { 
            position: absolute; 
            white-space: nowrap; 
            text-shadow: 0 2px 3px rgba(0,0,0,0.9), 0 0 10px rgba(0,0,0,0.5); 
            cursor: grab; 
            pointer-events: auto; /* Permite arrastar */
            user-select: none;
            z-index: 10;
        }
        .text-element:active { cursor: grabbing; outline: 1px dashed rgba(255,255,255,0.3); }
        
        /* UI Auxiliar */
        .control-group { background: #151515; border: 1px solid #333; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
        .control-header { color: #d4af37; font-weight: bold; margin-bottom: 0.5rem; display: flex; justify-content: space-between; cursor: pointer; }
        .grid-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 1.5rem;
            grid-auto-flow: dense; /* Permite reorganiza√ß√£o inteligente */
        }
        .card-item { 
            background: #151515; 
            border: 1px solid #333; 
            border-radius: 12px; 
            overflow: hidden; 
            transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s; 
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }
        
        /* Cards horizontais ocupam 2 colunas */
        .card-item.horizontal-card {
            grid-column: span 2;
        }
        
        .card-item:hover { 
            transform: translateY(-5px); 
            border-color: #d4af37; 
            box-shadow: 0 8px 24px rgba(212, 175, 55, 0.3);
        }
        
        /* Preview do Card na Lista */
        .card-item-preview {
            position: relative;
            width: 100%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .card-item-preview.vertical {
            aspect-ratio: 2.5 / 3.5;
        }
        
        .card-item-preview.horizontal {
            aspect-ratio: 3.5 / 2.5;
        }
        
        .card-item-preview .layer {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
        }
        
        .card-item-info {
            padding: 1rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        /* Responsividade */
        @media (max-width: 1200px) {
            .grid-list {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
            .card-item.horizontal-card {
                grid-column: span 2;
            }
            .editor-grid {
                grid-template-columns: 300px 1fr 280px !important;
                gap: 1rem !important;
            }
        }
        
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .grid-list {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 1rem;
            }
            .card-item.horizontal-card {
                grid-column: span 2; /* Ainda ocupa 2 colunas */
            }
            .card-item-preview {
                min-height: 200px;
            }
            .editor-grid {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
            .editor-grid > div {
                height: auto !important;
                overflow-y: visible !important;
            }
            .preview-wrapper {
                min-height: 400px;
            }
        }
        
        @media (max-width: 480px) {
            .grid-list {
                grid-template-columns: 1fr; /* Uma coluna apenas */
            }
            .card-item.horizontal-card {
                grid-column: span 1; /* Ocupa 1 coluna em mobile */
            }
            .page-nav {
                flex-direction: column;
            }
            .card-item-preview {
                min-height: 250px;
            }
            .card-item-preview.horizontal {
                min-height: 180px; /* Menor altura para horizontais em mobile */
            }
            .preview-wrapper {
                min-height: 350px;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <button onclick="window.location.href='home.html'" style="position: absolute; top: 1rem; left: 1rem; color: #888;">‚¨Ö Voltar</button>

    <header style="text-align: center; margin-bottom: 2rem;">
        <h1 style="font-family: 'Cinzel'; font-size: 2.5rem; color: #d4af37;">Gerenciador de Cards</h1>
    </header>

    <nav class="page-nav">
        <a href="cards_manager.html" class="page-link active">üÉè Cards</a>
        <a href="frames.html" class="page-link">üñºÔ∏è Molduras</a>
        <a href="backgrounds.html" class="page-link">üåÑ Backgrounds</a>
    </nav>

    <div style="text-align: center; margin-bottom: 1rem;">
        <button onclick="toggleView('list')" class="px-4 py-2 bg-gray-800 rounded hover:bg-gray-700">Ver Lista</button>
        <button onclick="toggleView('create')" class="px-4 py-2 bg-gray-800 rounded hover:bg-gray-700">Criar Novo</button>
    </div>

    <div id="viewList">
        <!-- Barra de Busca e Filtros -->
        <div style="background: #151515; border: 1px solid #333; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                <div>
                    <label>üîç Buscar</label>
                    <input type="text" id="search" placeholder="Nome do card..." oninput="renderCardsList()">
                </div>
                <div>
                    <label>üé≠ Origem</label>
                    <select id="filterOrigin" onchange="renderCardsList()">
                        <option value="">Todas</option>
                    </select>
                </div>
                <div>
                    <label>‚≠ê Raridade</label>
                    <select id="filterRarity" onchange="renderCardsList()">
                        <option value="">Todas</option>
                        <option value="common">Comum</option>
                        <option value="rare">Raro</option>
                        <option value="epic">√âpico</option>
                        <option value="legendary">Lend√°rio</option>
                    </select>
                </div>
                <div>
                    <label>üìê Orienta√ß√£o</label>
                    <select id="filterOrient" onchange="renderCardsList()">
                        <option value="">Todas</option>
                        <option value="vertical">Vertical</option>
                        <option value="horizontal">Horizontal</option>
                    </select>
                </div>
                <div>
                    <label>üìö S√©rie</label>
                    <select id="filterSeries" onchange="renderCardsList()">
                        <option value="">Todas</option>
                    </select>
                </div>
            </div>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <button onclick="clearFilters()" class="px-3 py-2 bg-gray-800 rounded hover:bg-gray-700 text-sm">Limpar Filtros</button>
                <span id="cardCount" style="margin-left: auto; padding: 0.5rem; color: #888;"></span>
            </div>
        </div>
        
        <div id="cardsGrid" class="grid-list" style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));">Carregando...</div>
    </div>

    <div id="viewEditor" style="display: none;">
        <div style="display: grid; grid-template-columns: 350px 1fr 300px; gap: 2rem;" class="editor-grid">
            
            <div style="height: 80vh; overflow-y: auto; padding-right: 10px;">
                <form id="cardForm" onsubmit="event.preventDefault();">
                    <input type="hidden" id="cardId">
                    
                    <div class="control-group">
                        <div class="control-header">Informa√ß√µes B√°sicas</div>
                        <label>Nome do Card</label>
                        <input type="text" id="cardName" oninput="updateText('name', this.value)" placeholder="Nome do Personagem">
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <label>Raridade</label>
                                <select id="cardRarity" onchange="updateText('rarity', this.options[this.selectedIndex].text)">
                                    <option value="common">Comum</option>
                                    <option value="rare">Raro</option>
                                    <option value="epic">√âpico</option>
                                    <option value="legendary">Lend√°rio</option>
                                </select>
                            </div>
                            <div>
                                <label>Orienta√ß√£o</label>
                                <select id="cardOrient" onchange="updatePreview()">
                                    <option value="vertical">Vertical</option>
                                    <option value="horizontal">Horizontal</option>
                                </select>
                            </div>
                        </div>

                        <label>Origem (Anime/Jogo)</label>
                        <input type="text" id="cardOrigin" placeholder="Ex: Naruto Shippuden" oninput="updateText('origin', this.value)">
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <label>S√©rie/Cole√ß√£o</label>
                                <input type="text" id="cardSeries" placeholder="Series 1" oninput="updateText('series', this.value)">
                            </div>
                            <div>
                                <label>N¬∫ Edi√ß√£o</label>
                                <input type="text" id="cardEdition" placeholder="#001" oninput="updateText('edition', this.value)">
                            </div>
                        </div>
                    </div>

                    <div class="control-group">
                        <div class="control-header">Personagem (Camada Meio)</div>
                        <label>URL da Imagem</label>
                        <input type="url" id="charUrl" oninput="updatePreview()" placeholder="https://imgur.com/...">
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                            <div><label>Zoom</label><input type="number" id="charZoom" step="0.1" value="1" oninput="updatePreview()"></div>
                            <div><label>Rota√ß√£o</label><input type="number" id="charRot" value="0" oninput="updatePreview()"></div>
                            <div><label>X (%)</label><input type="number" id="charX" value="50" oninput="updatePreview()"></div>
                            <div><label>Y (%)</label><input type="number" id="charY" value="50" oninput="updatePreview()"></div>
                        </div>
                    </div>

                    <div class="control-group">
                        <div class="control-header">Moldura (Frente) & Fundo (Tr√°s)</div>
                        <label>Moldura</label>
                        <select id="selFrame" onchange="updatePreview()"></select>
                        
                        <div id="frameControls" style="margin-top: 10px; display: none;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                                <div><label>Zoom</label><input type="number" id="frameZoom" step="0.1" value="1" oninput="updatePreview()"></div>
                                <div><label>Rota√ß√£o</label><input type="number" id="frameRot" value="0" oninput="updatePreview()"></div>
                                <div><label>X (%)</label><input type="number" id="frameX" value="50" oninput="updatePreview()"></div>
                                <div><label>Y (%)</label><input type="number" id="frameY" value="50" oninput="updatePreview()"></div>
                            </div>
                        </div>
                        
                        <label style="margin-top: 10px;">Background</label>
                        <select id="selBg" onchange="updatePreview()"></select>
                        
                        <div style="margin-top: 5px; display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                            <div><label>Bg Zoom</label><input type="number" id="bgZoom" step="0.1" value="1" oninput="updatePreview()"></div>
                            <div><label>Bg Rot</label><input type="number" id="bgRot" value="0" oninput="updatePreview()"></div>
                            <div><label>Bg X (%)</label><input type="number" id="bgX" value="50" oninput="updatePreview()"></div>
                            <div><label>Bg Y (%)</label><input type="number" id="bgY" value="50" oninput="updatePreview()"></div>
                        </div>
                    </div>

                    <button onclick="saveCard()" class="w-full bg-[#d4af37] text-black font-bold py-3 rounded mt-4 hover:bg-[#b5952f] transition">Salvar Card</button>
                    <button onclick="resetForm()" class="w-full bg-[#333] text-white py-2 rounded mt-2 hover:bg-[#444] transition">Cancelar</button>
                </form>
            </div>

            <div class="preview-wrapper">
                <div id="previewContainer" class="card-preview-container vertical">
                    <div id="layerBg" class="layer layer-bg"></div>
                    
                    <div id="layerChar" class="layer layer-char"></div>
                    
                    <div id="layerFrame" class="layer layer-frame"></div>
                    
                    <div id="layerText" class="layer layer-text">
                        </div>

                    <div class="layer layer-overlay"></div>
                </div>
            </div>

            <div style="height: 80vh; overflow-y: auto;">
                <h3 style="color: #d4af37; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px;">üé® Editor de Textos</h3>
                <p style="font-size: 0.8rem; color: #888; margin-bottom: 1rem;">Clique e arraste os textos no preview para mover.</p>
                <div id="textControls">
                    </div>
            </div>

        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, query, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = { 
        apiKey: "AIzaSyDsbiLPBOda119Qr6Ji69j8TZLpiFixBWI", authDomain: "list-games-9bddd.firebaseapp.com", projectId: "list-games-9bddd", storageBucket: "list-games-9bddd.firebasestorage.app", messagingSenderId: "756898313156", appId: "1:756898313156:web:9bc660d0a2f4cd07882a91", measurementId: "G-GLM50YVLXP"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    let userId = null;

    // Cache
    let framesList = [];
    let bgsList = [];
    let cardsList = [];

    // Configura√ß√£o Inicial dos Textos
    const textFields = ['name', 'rarity', 'origin', 'series', 'edition'];
    let textConfig = {
        name: { x: 50, y: 85, size: 24, color: '#d4af37', font: 'Cinzel', label: 'Nome' },
        rarity: { x: 50, y: 92, size: 14, color: '#ffffff', font: 'Inter', label: 'Raridade' },
        origin: { x: 50, y: 80, size: 12, color: '#cccccc', font: 'Inter', label: 'Origem' },
        series: { x: 10, y: 96, size: 10, color: '#888888', font: 'Inter', label: 'S√©rie' },
        edition: { x: 90, y: 96, size: 10, color: '#888888', font: 'Inter', label: 'Edi√ß√£o' }
    };

    onAuthStateChanged(auth, u => {
        if(u) {
            userId = u.uid;
            loadData();
        } else window.location.href = 'home.html';
    });

    function loadData() {
        onSnapshot(query(collection(db, 'users', userId, 'frames')), snap => {
            framesList = [];
            snap.forEach(d => framesList.push({id: d.id, ...d.data()}));
            updateSelects();
        });
        onSnapshot(query(collection(db, 'users', userId, 'backgrounds')), snap => {
            bgsList = [];
            snap.forEach(d => bgsList.push({id: d.id, ...d.data()}));
            updateSelects();
        });
        onSnapshot(query(collection(db, 'users', userId, 'cards')), snap => {
            cardsList = [];
            snap.forEach(d => cardsList.push({id: d.id, ...d.data()}));
            updateFilterOptions();
            renderCardsList();
        });
        
        renderTextControls();
    }

    // --- RENDERIZADORES DO PREVIEW ---

    window.updatePreview = () => {
        // 1. Orienta√ß√£o do Container
        const orient = document.getElementById('cardOrient').value;
        const container = document.getElementById('previewContainer');
        container.className = `card-preview-container ${orient}`;

        // 2. BACKGROUND (Layer 1)
        const bgId = document.getElementById('selBg').value;
        const bgZoom = parseFloat(document.getElementById('bgZoom').value) || 1;
        const bgRot = parseFloat(document.getElementById('bgRot').value) || 0;
        const bgX = parseFloat(document.getElementById('bgX').value) || 50;
        const bgY = parseFloat(document.getElementById('bgY').value) || 50;
        const layerBg = document.getElementById('layerBg');
        
        const bgData = bgsList.find(b => b.id === bgId);
        
        if(bgData) {
            if(bgData.type === 'image') {
                // Aplicando zoom, rota√ß√£o e posi√ß√£o no background
                const imgZoom = (bgData.image.zoom || 1) * bgZoom;
                const imgRot = parseFloat(bgData.image.rotate || 0) + bgRot;
                const imgX = parseFloat(bgData.image.posX || 0);
                const imgY = parseFloat(bgData.image.posY || 0);
                
                layerBg.innerHTML = `<img src="${bgData.image.url}" style="
                    width:100%; 
                    height:100%; 
                    object-fit:cover; 
                    transform: scale(${imgZoom}) rotate(${imgRot}deg);
                    object-position: ${bgX}% ${bgY}%;
                ">`;
            } else {
                const g = bgData.gradient;
                const style = g.dir === 'radial' ? `radial-gradient(circle, ${g.colors.join(',')})` : `linear-gradient(${g.dir}, ${g.colors.join(',')})`;
                layerBg.innerHTML = `<div style="width:100%; height:100%; background: ${style}"></div>`;
            }
        } else {
            // Fundo padr√£o cinza escuro se n√£o houver background selecionado
            layerBg.innerHTML = `<div style="width:100%; height:100%; background: #222;"></div>`;
        }

        // 3. PERSONAGEM (Layer 2)
        const charUrl = document.getElementById('charUrl').value;
        const charZoom = parseFloat(document.getElementById('charZoom').value) || 1;
        const charRot = parseFloat(document.getElementById('charRot').value) || 0;
        const charX = parseFloat(document.getElementById('charX').value) || 50;
        const charY = parseFloat(document.getElementById('charY').value) || 50;
        
        const layerChar = document.getElementById('layerChar');
        if(charUrl) {
            // Usamos left/top com translate(-50%, -50%) para centralizar no ponto exato
            layerChar.innerHTML = `
                <img src="${charUrl}" 
                     style="
                        position: absolute;
                        left: ${charX}%;
                        top: ${charY}%;
                        width: auto; 
                        height: 100%; /* Ajuste inicial de altura */
                        min-width: 50%;
                        object-fit: contain; 
                        transform: translate(-50%, -50%) scale(${charZoom}) rotate(${charRot}deg);
                     "
                     onerror="this.style.display='none'; console.log('Erro ao carregar imagem');"
                >`;
        } else {
            layerChar.innerHTML = '';
        }

        // 4. MOLDURA (Layer 3)
        const frameId = document.getElementById('selFrame').value;
        const layerFrame = document.getElementById('layerFrame');
        const frameData = framesList.find(f => f.id === frameId);
        
        // Mostrar/ocultar controles de moldura se for imagem
        const frameControls = document.getElementById('frameControls');
        if(frameData && frameData.type === 'image') {
            frameControls.style.display = 'block';
        } else {
            frameControls.style.display = 'none';
        }
        
        if(frameData) {
            if(frameData.type === 'image') {
                const frameZoom = parseFloat(document.getElementById('frameZoom').value) || 1;
                const frameRot = parseFloat(document.getElementById('frameRot').value) || 0;
                const frameX = parseFloat(document.getElementById('frameX').value) || 50;
                const frameY = parseFloat(document.getElementById('frameY').value) || 50;
                
                layerFrame.innerHTML = `<img src="${frameData.imageUrl}" style="
                    position: absolute;
                    left: ${frameX}%;
                    top: ${frameY}%;
                    width: 100%;
                    height: 100%;
                    object-fit: contain;
                    transform: translate(-50%, -50%) scale(${frameZoom}) rotate(${frameRot}deg);
                    pointer-events: none;
                ">`;
            } else {
                // Renderizar Elementos Gr√°ficos
                const elsHTML = (frameData.elements || []).map(el => {
                    let css = `position:absolute; left:${el.x}px; top:${el.y}px; width:${el.w}px; height:${el.h}px; background:${el.color};`;
                    
                    if(el.type === 'circle') css += 'border-radius: 50%;';
                    if(el.type === 'rect') css += `border-radius: ${el.radius}px;`;
                    if(el.type === 'star') css += 'clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);';
                    if(el.type === 'triangle') css += 'clip-path: polygon(50% 0%, 0% 100%, 100% 100%);';

                    // Aplicar tema
                    if(frameData.styleTheme === 'neon') css += `box-shadow: 0 0 10px ${el.color};`;
                    if(frameData.styleTheme === 'pastel') css += `opacity: 0.8; mix-blend-mode: screen;`;

                    return `<div style="${css}"></div>`;
                }).join('');
                layerFrame.innerHTML = elsHTML;
            }
        } else {
            layerFrame.innerHTML = '';
        }

        renderTextLayers();
    };

    // --- TEXTOS ---

    window.updateText = (field, val) => {
        if(field === 'rarity') val = document.getElementById('cardRarity').options[document.getElementById('cardRarity').selectedIndex].text;
        
        // Atualiza apenas o conte√∫do do DOM se existir, sen√£o re-renderiza tudo
        const el = document.getElementById(`text-${field}`);
        if(el) el.innerText = val;
        else renderTextLayers();
    };

    function renderTextLayers() {
        const layer = document.getElementById('layerText');
        // N√£o limpamos tudo para n√£o perder refer√™ncia de drag se estiver arrastando
        // Mas como atualizamos configs, vamos reconstruir para garantir sincronia
        layer.innerHTML = '';
        
        textFields.forEach(field => {
            const cfg = textConfig[field];
            const div = document.createElement('div');
            div.id = `text-${field}`;
            div.className = 'text-element';
            
            // Valor
            let val = '';
            if(field === 'name') val = document.getElementById('cardName').value || 'Nome';
            else if(field === 'origin') val = document.getElementById('cardOrigin').value || 'Origem';
            else if(field === 'series') val = document.getElementById('cardSeries').value || 'S√©rie';
            else if(field === 'edition') val = document.getElementById('cardEdition').value || '#000';
            else if(field === 'rarity') val = document.getElementById('cardRarity').options[document.getElementById('cardRarity').selectedIndex]?.text || 'Raridade';

            div.innerText = val;
            
            // Estilos
            div.style.left = cfg.x + '%';
            div.style.top = cfg.y + '%';
            div.style.transform = 'translate(-50%, -50%)';
            div.style.fontSize = cfg.size + 'px';
            div.style.color = cfg.color;
            div.style.fontFamily = cfg.font === 'Cinzel' ? "'Cinzel', serif" : "'Inter', sans-serif";
            
            // Evento de Drag
            div.onmousedown = (e) => startDragText(e, field);
            
            layer.appendChild(div);
        });
    }

    // --- LOGICA DRAG TEXTO ---
    let isDraggingText = false;
    let currentTextField = null;

    function startDragText(e, field) {
        e.preventDefault();
        isDraggingText = true;
        currentTextField = field;
        
        // Ativar controles visuais desse texto
        const ctrl = document.getElementById(`ctrl-${field}`);
        if(ctrl && ctrl.style.display === 'none') toggleControl(field);

        document.addEventListener('mousemove', onDragText);
        document.addEventListener('mouseup', stopDragText);
    }

    function onDragText(e) {
        if(!isDraggingText) return;
        const container = document.getElementById('previewContainer');
        const rect = container.getBoundingClientRect();
        
        let x = ((e.clientX - rect.left) / rect.width) * 100;
        let y = ((e.clientY - rect.top) / rect.height) * 100;
        
        // Trava limites
        x = Math.max(0, Math.min(100, x));
        y = Math.max(0, Math.min(100, y));
        
        textConfig[currentTextField].x = Math.round(x);
        textConfig[currentTextField].y = Math.round(y);
        
        // Atualiza inputs visuais
        document.getElementById(`inp-x-${currentTextField}`).value = Math.round(x);
        document.getElementById(`inp-y-${currentTextField}`).value = Math.round(y);
        
        renderTextLayers();
    }

    function stopDragText() {
        isDraggingText = false;
        document.removeEventListener('mousemove', onDragText);
        document.removeEventListener('mouseup', stopDragText);
    }

    // --- RENDER CONTROLS ---

    function renderTextControls() {
        const container = document.getElementById('textControls');
        container.innerHTML = textFields.map(field => {
            const cfg = textConfig[field];
            return `
                <div class="control-group">
                    <div class="control-header" onclick="toggleControl('${field}')">
                        <span>${cfg.label}</span>
                        <i data-lucide="settings-2" style="width:14px;"></i>
                    </div>
                    <div id="ctrl-${field}" style="display:none; padding-top:10px;">
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                            <div><label>X (%)</label><input type="number" id="inp-x-${field}" value="${cfg.x}" oninput="updateTextConfig('${field}', 'x', this.value)"></div>
                            <div><label>Y (%)</label><input type="number" id="inp-y-${field}" value="${cfg.y}" oninput="updateTextConfig('${field}', 'y', this.value)"></div>
                        </div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                            <div><label>Tamanho</label><input type="number" value="${cfg.size}" oninput="updateTextConfig('${field}', 'size', this.value)"></div>
                            <div><label>Cor</label><input type="color" value="${cfg.color}" oninput="updateTextConfig('${field}', 'color', this.value)" style="height:35px;"></div>
                        </div>
                        <label>Fonte</label>
                        <select onchange="updateTextConfig('${field}', 'font', this.value)">
                            <option value="Cinzel" ${cfg.font==='Cinzel'?'selected':''}>Cinzel (T√≠tulo)</option>
                            <option value="Inter" ${cfg.font==='Inter'?'selected':''}>Inter (Padr√£o)</option>
                        </select>
                    </div>
                </div>
            `;
        }).join('');
        lucide.createIcons();
    }

    window.toggleControl = (id) => {
        const el = document.getElementById(`ctrl-${id}`);
        const current = el.style.display;
        // Fecha todos
        document.querySelectorAll('[id^="ctrl-"]').forEach(d => d.style.display = 'none');
        // Abre o clicado se estava fechado
        el.style.display = current === 'none' ? 'block' : 'none';
    };

    window.updateTextConfig = (field, prop, val) => {
        textConfig[field][prop] = val;
        renderTextLayers();
    };

    // --- FUN√á√ïES GERAIS ---

    function updateSelects() {
        const selF = document.getElementById('selFrame');
        const selB = document.getElementById('selBg');
        
        // Salva valor atual para n√£o perder na recarga
        const currF = selF.value;
        const currB = selB.value;

        selF.innerHTML = '<option value="">Sem Moldura</option>' + framesList.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
        selB.innerHTML = '<option value="">Padr√£o (Escuro)</option>' + bgsList.map(b => `<option value="${b.id}">${b.name}</option>`).join('');

        if(currF) selF.value = currF;
        if(currB) selB.value = currB;
        
        updatePreview();
    }

    window.toggleView = (view) => {
        document.getElementById('viewList').style.display = view === 'list' ? 'block' : 'none';
        document.getElementById('viewEditor').style.display = view === 'create' ? 'block' : 'none';
        if(view === 'create') updatePreview();
    };

    window.saveCard = async () => {
        const id = document.getElementById('cardId').value;
        const data = {
            name: document.getElementById('cardName').value,
            rarity: document.getElementById('cardRarity').value,
            orient: document.getElementById('cardOrient').value,
            origin: document.getElementById('cardOrigin').value,
            series: document.getElementById('cardSeries').value,
            edition: document.getElementById('cardEdition').value,
            charUrl: document.getElementById('charUrl').value,
            configChar: {
                zoom: document.getElementById('charZoom').value,
                rot: document.getElementById('charRot').value,
                x: document.getElementById('charX').value,
                y: document.getElementById('charY').value
            },
            frameId: document.getElementById('selFrame').value,
            configFrame: {
                zoom: document.getElementById('frameZoom').value,
                rot: document.getElementById('frameRot').value,
                x: document.getElementById('frameX').value,
                y: document.getElementById('frameY').value
            },
            bgId: document.getElementById('selBg').value,
            configBg: {
                zoom: document.getElementById('bgZoom').value,
                rot: document.getElementById('bgRot').value,
                x: document.getElementById('bgX').value,
                y: document.getElementById('bgY').value
            },
            textConfig: textConfig,
            updatedAt: new Date().toISOString()
        };

        try {
            if(id) {
                await updateDoc(doc(db, 'users', userId, 'cards', id), data);
                alert("Card Atualizado!");
            } else {
                data.createdAt = new Date().toISOString();
                await addDoc(collection(db, 'users', userId, 'cards'), data);
                alert("Card Criado!");
            }
            resetForm();
            toggleView('list');
        } catch(e) {
            alert("Erro: " + e.message);
        }
    };

    window.editCard = (id) => {
        const c = cardsList.find(x => x.id === id);
        if(!c) return;
        document.getElementById('cardId').value = c.id;
        document.getElementById('cardName').value = c.name;
        document.getElementById('cardRarity').value = c.rarity;
        document.getElementById('cardOrient').value = c.orient;
        document.getElementById('cardOrigin').value = c.origin || '';
        document.getElementById('cardSeries').value = c.series || '';
        document.getElementById('cardEdition').value = c.edition || '';
        document.getElementById('charUrl').value = c.charUrl || '';
        document.getElementById('charZoom').value = c.configChar?.zoom || 1;
        document.getElementById('charRot').value = c.configChar?.rot || 0;
        document.getElementById('charX').value = c.configChar?.x || 50;
        document.getElementById('charY').value = c.configChar?.y || 50;
        document.getElementById('selFrame').value = c.frameId || '';
        document.getElementById('frameZoom').value = c.configFrame?.zoom || 1;
        document.getElementById('frameRot').value = c.configFrame?.rot || 0;
        document.getElementById('frameX').value = c.configFrame?.x || 50;
        document.getElementById('frameY').value = c.configFrame?.y || 50;
        document.getElementById('selBg').value = c.bgId || '';
        document.getElementById('bgZoom').value = c.configBg?.zoom || 1;
        document.getElementById('bgRot').value = c.configBg?.rot || 0;
        document.getElementById('bgX').value = c.configBg?.x || 50;
        document.getElementById('bgY').value = c.configBg?.y || 50;

        if(c.textConfig) textConfig = c.textConfig;
        renderTextControls();
        toggleView('create');
        updatePreview();
    };

    window.resetForm = () => {
        // Limpa o formul√°rio
        document.getElementById('cardForm').reset();
        document.getElementById('cardId').value = '';
        
        // Reseta valores espec√≠ficos que podem n√£o ser limpos pelo reset
        document.getElementById('charZoom').value = '1';
        document.getElementById('charRot').value = '0';
        document.getElementById('charX').value = '50';
        document.getElementById('charY').value = '50';
        document.getElementById('bgZoom').value = '1';
        document.getElementById('bgRot').value = '0';
        document.getElementById('selFrame').value = '';
        document.getElementById('selBg').value = '';
        
        // Reseta configura√ß√£o de textos para valores padr√£o
        textConfig = {
            name: { x: 50, y: 85, size: 24, color: '#d4af37', font: 'Cinzel', label: 'Nome' },
            rarity: { x: 50, y: 92, size: 14, color: '#ffffff', font: 'Inter', label: 'Raridade' },
            origin: { x: 50, y: 80, size: 12, color: '#cccccc', font: 'Inter', label: 'Origem' },
            series: { x: 10, y: 96, size: 10, color: '#888888', font: 'Inter', label: 'S√©rie' },
            edition: { x: 90, y: 96, size: 10, color: '#888888', font: 'Inter', label: 'Edi√ß√£o' }
        };
        
        // Re-renderiza controles de texto e preview
        renderTextControls();
        updatePreview();
        
        // Volta para lista
        toggleView('list');
    };

    window.clearFilters = () => {
        document.getElementById('search').value = '';
        document.getElementById('filterOrigin').value = '';
        document.getElementById('filterRarity').value = '';
        document.getElementById('filterOrient').value = '';
        document.getElementById('filterSeries').value = '';
        renderCardsList();
    };

    function updateFilterOptions() {
        // Atualizar op√ß√µes de Origem
        const origins = [...new Set(cardsList.map(c => c.origin).filter(Boolean))];
        const filterOrigin = document.getElementById('filterOrigin');
        if(filterOrigin) {
            const currentOrigin = filterOrigin.value;
            filterOrigin.innerHTML = '<option value="">Todas</option>' + 
                origins.map(o => `<option value="${o}" ${o === currentOrigin ? 'selected' : ''}>${o}</option>`).join('');
        }
        
        // Atualizar op√ß√µes de S√©rie
        const series = [...new Set(cardsList.map(c => c.series).filter(Boolean))];
        const filterSeries = document.getElementById('filterSeries');
        if(filterSeries) {
            const currentSeries = filterSeries.value;
            filterSeries.innerHTML = '<option value="">Todas</option>' + 
                series.map(s => `<option value="${s}" ${s === currentSeries ? 'selected' : ''}>${s}</option>`).join('');
        }
    }

    function renderCardsList() {
        const grid = document.getElementById('cardsGrid');
        if(!grid) return;
        
        const searchInput = document.getElementById('search');
        const filterOriginEl = document.getElementById('filterOrigin');
        const filterRarityEl = document.getElementById('filterRarity');
        const filterOrientEl = document.getElementById('filterOrient');
        const filterSeriesEl = document.getElementById('filterSeries');
        const cardCountEl = document.getElementById('cardCount');
        
        const term = searchInput ? searchInput.value.toLowerCase() : '';
        const filterOrigin = filterOriginEl ? filterOriginEl.value : '';
        const filterRarity = filterRarityEl ? filterRarityEl.value : '';
        const filterOrient = filterOrientEl ? filterOrientEl.value : '';
        const filterSeries = filterSeriesEl ? filterSeriesEl.value : '';
        
        // Aplicar filtros
        let filtered = cardsList.filter(c => {
            const matchSearch = !term || (c.name && c.name.toLowerCase().includes(term));
            const matchOrigin = !filterOrigin || (c.origin && c.origin === filterOrigin);
            const matchRarity = !filterRarity || (c.rarity && c.rarity === filterRarity);
            const matchOrient = !filterOrient || (c.orient && c.orient === filterOrient);
            const matchSeries = !filterSeries || (c.series && c.series === filterSeries);
            return matchSearch && matchOrigin && matchRarity && matchOrient && matchSeries;
        });
        
        // Atualizar contador
        if(cardCountEl) {
            cardCountEl.innerText = `${filtered.length} card(s) encontrado(s)`;
        }
        
        if(filtered.length === 0) {
            grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 4rem; color: #666;"><p style="font-size: 3rem; margin-bottom: 1rem;">üé¥</p><p>Nenhum card encontrado</p></div>';
            return;
        }
        
        grid.innerHTML = filtered.map(c => {
            const rarityLabels = {
                common: 'Comum',
                rare: 'Raro',
                epic: '√âpico',
                legendary: 'Lend√°rio'
            };
            
            const rarityColors = {
                common: '#888',
                rare: '#3b82f6',
                epic: '#a855f7',
                legendary: '#f59e0b'
            };
            
            const orient = c.orient || 'vertical';
            const cardClass = orient === 'horizontal' ? 'card-item horizontal-card' : 'card-item';
            
            // Renderizar preview completo do card
            const previewHTML = renderCardPreview(c);
            
            return `
                <div class="${cardClass}" onclick="editCard('${c.id}')">
                    <div class="card-item-preview ${orient}">
                        ${previewHTML}
                    </div>
                    <div class="card-item-info">
                        <div style="font-weight: bold; font-size: 1.1rem; color: #d4af37; font-family: 'Cinzel';">${c.name || 'Sem Nome'}</div>
                        <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                            <span style="font-size: 0.85rem; color: ${rarityColors[c.rarity] || '#888'}; font-weight: 600;">${rarityLabels[c.rarity] || 'Comum'}</span>
                            ${c.series ? `<span style="font-size: 0.75rem; color: #666;">‚Ä¢</span><span style="font-size: 0.85rem; color: #aaa;">üìö ${c.series}</span>` : ''}
                        </div>
                        ${c.origin ? `<div style="font-size: 0.85rem; color: #888;">üì∫ ${c.origin}</div>` : ''}
                    </div>
                </div>
            `;
        }).join('');
    }
    
    function renderCardPreview(card) {
        // Buscar dados de background e frame
        const bgData = bgsList.find(b => b.id === card.bgId);
        const frameData = framesList.find(f => f.id === card.frameId);
        
        let html = '';
        
        // Layer 1: Background
        if(bgData) {
            if(bgData.type === 'image') {
                const bgZoom = (bgData.image.zoom || 1) * (card.configBg?.zoom || 1);
                const bgRot = parseFloat(bgData.image.rotate || 0) + parseFloat(card.configBg?.rot || 0);
                const bgX = card.configBg?.x || 50;
                const bgY = card.configBg?.y || 50;
                
                html += `<div class="layer" style="z-index: 1;">
                    <img src="${bgData.image.url}" style="
                        width: 100%; 
                        height: 100%; 
                        object-fit: cover; 
                        transform: scale(${bgZoom}) rotate(${bgRot}deg);
                        object-position: ${bgX}% ${bgY}%;
                    " onerror="this.style.display='none';">
                </div>`;
            } else {
                const g = bgData.gradient;
                const style = g.dir === 'radial' 
                    ? `radial-gradient(circle, ${g.colors.join(',')})` 
                    : `linear-gradient(${g.dir}, ${g.colors.join(',')})`;
                html += `<div class="layer" style="z-index: 1; background: ${style};"></div>`;
            }
        } else {
            html += `<div class="layer" style="z-index: 1; background: #222;"></div>`;
        }
        
        // Layer 2: Personagem
        if(card.charUrl) {
            const charZoom = card.configChar?.zoom || 1;
            const charRot = card.configChar?.rot || 0;
            const charX = card.configChar?.x || 50;
            const charY = card.configChar?.y || 50;
            
            html += `<div class="layer" style="z-index: 2;">
                <img src="${card.charUrl}" style="
                    position: absolute;
                    left: ${charX}%;
                    top: ${charY}%;
                    width: auto;
                    height: 100%;
                    min-width: 50%;
                    object-fit: contain;
                    transform: translate(-50%, -50%) scale(${charZoom}) rotate(${charRot}deg);
                " onerror="this.style.display='none';">
            </div>`;
        }
        
        // Layer 3: Moldura
        if(frameData) {
            if(frameData.type === 'image') {
                const frameZoom = card.configFrame?.zoom || 1;
                const frameRot = card.configFrame?.rot || 0;
                const frameX = card.configFrame?.x || 50;
                const frameY = card.configFrame?.y || 50;
                
                html += `<div class="layer" style="z-index: 3;">
                    <img src="${frameData.imageUrl}" style="
                        position: absolute;
                        left: ${frameX}%;
                        top: ${frameY}%;
                        width: 100%;
                        height: 100%;
                        object-fit: contain;
                        transform: translate(-50%, -50%) scale(${frameZoom}) rotate(${frameRot}deg);
                        pointer-events: none;
                    " onerror="this.style.display='none';">
                </div>`;
            } else if(frameData.elements) {
                const elsHTML = frameData.elements.map(el => {
                    let css = `position:absolute; left:${el.x}px; top:${el.y}px; width:${el.w}px; height:${el.h}px; background:${el.color};`;
                    
                    if(el.type === 'circle') css += 'border-radius: 50%;';
                    if(el.type === 'rect') css += `border-radius: ${el.radius || 0}px;`;
                    if(el.type === 'star') css += 'clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);';
                    if(el.type === 'triangle') css += 'clip-path: polygon(50% 0%, 0% 100%, 100% 100%);';
                    
                    if(frameData.styleTheme === 'neon') css += `box-shadow: 0 0 10px ${el.color};`;
                    if(frameData.styleTheme === 'pastel') css += `opacity: 0.8; mix-blend-mode: screen;`;
                    
                    return `<div style="${css}"></div>`;
                }).join('');
                html += `<div class="layer" style="z-index: 3;">${elsHTML}</div>`;
            }
        }
        
        // Layer 4: Textos
        if(card.textConfig) {
            const textFields = ['name', 'rarity', 'origin', 'series', 'edition'];
            const textsHTML = textFields.map(field => {
                const cfg = card.textConfig[field];
                if(!cfg) return '';
                
                let val = '';
                if(field === 'name') val = card.name || 'Nome';
                else if(field === 'origin') val = card.origin || '';
                else if(field === 'series') val = card.series || '';
                else if(field === 'edition') val = card.edition || '';
                else if(field === 'rarity') {
                    const rarityLabels = { common: 'Comum', rare: 'Raro', epic: '√âpico', legendary: 'Lend√°rio' };
                    val = rarityLabels[card.rarity] || 'Comum';
                }
                
                if(!val) return '';
                
                return `<div style="
                    position: absolute;
                    left: ${cfg.x}%;
                    top: ${cfg.y}%;
                    transform: translate(-50%, -50%);
                    font-size: ${cfg.size}px;
                    color: ${cfg.color};
                    font-family: ${cfg.font === 'Cinzel' ? "'Cinzel', serif" : "'Inter', sans-serif"};
                    white-space: nowrap;
                    text-shadow: 0 2px 3px rgba(0,0,0,0.9), 0 0 10px rgba(0,0,0,0.5);
                    pointer-events: none;
                ">${val}</div>`;
            }).join('');
            
            html += `<div class="layer" style="z-index: 4;">${textsHTML}</div>`;
        }
        
        return html;
    }
</script>
</body>
</html>
