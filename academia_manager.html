<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerenciador Academia</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
  <div class="container mx-auto p-6">
    <header class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
      <h1 class="text-3xl font-bold">Minha Academia</h1>
      <button id="logout-btn" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded">Sair</button>
    </header>

    <nav class="flex space-x-4 mb-6 border-b border-gray-700 pb-2">
      <button class="tab-btn text-lg font-semibold active" data-tab="exercicios">Exercícios</button>
      <button class="tab-btn text-lg font-semibold" data-tab="grupos">Grupos</button>
      <button class="tab-btn text-lg font-semibold" data-tab="diario">Diário</button>
    </nav>

    <div id="tab-exercicios" class="tab-content block">
      <div class="flex justify-end mb-4">
        <button class="add-btn bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded" data-type="exercicio">Adicionar Exercício</button>
      </div>
      <div id="ex-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      <p id="ex-empty" class="text-center text-gray-500 hidden">Nenhum exercício cadastrado.</p>
    </div>

    <div id="tab-grupos" class="tab-content hidden">
      <div class="flex justify-end mb-4">
        <button class="add-btn bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded" data-type="grupo">Adicionar Grupo</button>
      </div>
      <div id="grupo-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      <p id="grupo-empty" class="text-center text-gray-500 hidden">Nenhum grupo cadastrado.</p>
    </div>

    <div id="tab-diario" class="tab-content hidden">
      <div class="flex justify-end mb-4">
        <button class="add-btn bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded" data-type="diario">Registrar Treino</button>
      </div>
      <div id="diario-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      <p id="diario-empty" class="text-center text-gray-500 hidden">Nenhum registro encontrado.</p>
    </div>
  </div>

  <div id="modal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50">
    <div class="bg-gray-800 p-6 rounded-lg w-11/12 max-w-lg">
      <h2 id="modal-title" class="text-xl font-bold mb-4">Modal</h2>
      <form id="main-form" class="space-y-3"></form>
      <div class="flex justify-end space-x-3 pt-3">
        <button id="save-btn" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">Salvar</button>
        <button id="delete-btn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded hidden">Excluir</button>
        <button id="close-btn" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded">Cancelar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, query, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDsbiLPBOda119Qr6Ji69j8TZLpiFixBWI",
      authDomain: "list-games-9bddd.firebaseapp.com",
      projectId: "list-games-9bddd",
      storageBucket: "list-games-9bddd.appspot.com",
      messagingSenderId: "756898313156",
      appId: "1:756898313156:web:9bc660d0a2f4cd07882a91",
      measurementId: "G-GLM50YVLXP"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const logoutBtn = document.getElementById('logout-btn');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const mainForm = document.getElementById('main-form');
    const saveBtn = document.getElementById('save-btn');
    const deleteBtn = document.getElementById('delete-btn');
    const closeBtn = document.getElementById('close-btn');

    let currentUser = null;
    let tipoAtual = null;
    let editandoId = null;

    // Alternar abas
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('text-blue-400'));
        btn.classList.add('text-blue-400');

        const tab = btn.dataset.tab;
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.getElementById(`tab-${tab}`).classList.remove('hidden');
      });
    });

    onAuthStateChanged(auth, (user) => {
      if (!user) return window.location.href = 'index.html';
      currentUser = user;
      carregarColecoes();
    });

    logoutBtn.addEventListener('click', async () => {
      await signOut(auth);
      window.location.href = 'index.html';
    });

    function carregarColecoes() {
      const tabs = [
        { tipo: 'exercicio', nome: 'academia_exercicios', render: renderEx },
        { tipo: 'grupo', nome: 'academia_grupos', render: renderGr },
        { tipo: 'diario', nome: 'academia_diario', render: renderDi }
      ];

      tabs.forEach(({ tipo, nome, render }) => {
        const q = query(collection(db, 'users', currentUser.uid, nome));
        onSnapshot(q, snap => {
          const dados = [];
          snap.forEach(doc => dados.push({ id: doc.id, ...doc.data() }));
          render(dados);
        });
      });
    }

    document.querySelectorAll('.add-btn').forEach(btn => btn.addEventListener('click', () => abrirModal(btn.dataset.type)));
    closeBtn.addEventListener('click', () => modal.classList.add('hidden'));

    function abrirModal(tipo, data = null) {
      tipoAtual = tipo;
      editandoId = data ? data.id : null;
      mainForm.innerHTML = '';

      if (tipo === 'exercicio') {
        modalTitle.textContent = editandoId ? 'Editar Exercício' : 'Novo Exercício';
        mainForm.innerHTML = `
          <input id='nome' placeholder='Nome do exercício' class='w-full p-2 bg-gray-700 rounded'>
          <input id='grupo' placeholder='Grupo muscular' class='w-full p-2 bg-gray-700 rounded'>
          <input id='series' type='number' placeholder='Séries' class='w-full p-2 bg-gray-700 rounded'>
          <input id='reps' type='number' placeholder='Repetições' class='w-full p-2 bg-gray-700 rounded'>`;
      } else if (tipo === 'grupo') {
        modalTitle.textContent = editandoId ? 'Editar Grupo' : 'Novo Grupo';
        mainForm.innerHTML = `
          <input id='nome' placeholder='Nome do grupo' class='w-full p-2 bg-gray-700 rounded'>
          <textarea id='exercicios' placeholder='Exercícios separados por vírgula' class='w-full p-2 bg-gray-700 rounded'></textarea>`;
      } else if (tipo === 'diario') {
        modalTitle.textContent = editandoId ? 'Editar Registro' : 'Novo Registro';
        mainForm.innerHTML = `
          <input id='grupo' placeholder='Grupo' class='w-full p-2 bg-gray-700 rounded'>
          <input id='reps' type='number' placeholder='Repetições feitas' class='w-full p-2 bg-gray-700 rounded'>
          <input id='data' type='date' class='w-full p-2 bg-gray-700 rounded'>`;
      }

      if (data) {
        Object.keys(data).forEach(k => {
          const el = document.getElementById(k);
          if (el) el.value = data[k];
        });
        deleteBtn.classList.remove('hidden');
      } else deleteBtn.classList.add('hidden');

      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    saveBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      if (!currentUser) return alert('Usuário não autenticado.');
      const formData = Object.fromEntries([...mainForm.querySelectorAll('input, textarea')].map(el => [el.id, el.value]));
      const collName = tipoAtual === 'exercicio' ? 'academia_exercicios' : tipoAtual === 'grupo' ? 'academia_grupos' : 'academia_diario';
      try {
        if (editandoId) {
          await updateDoc(doc(db, 'users', currentUser.uid, collName, editandoId), formData);
        } else {
          await addDoc(collection(db, 'users', currentUser.uid, collName), formData);
        }
        modal.classList.add('hidden');
      } catch (err) {
        console.error('Erro ao salvar:', err);
        alert('Erro ao salvar no Firestore: ' + err.message);
      }
    });

    deleteBtn.addEventListener('click', async () => {
      if (!editandoId || !currentUser) return;
      const collName = tipoAtual === 'exercicio' ? 'academia_exercicios' : tipoAtual === 'grupo' ? 'academia_grupos' : 'academia_diario';
      try {
        await deleteDoc(doc(db, 'users', currentUser.uid, collName, editandoId));
        modal.classList.add('hidden');
      } catch (err) {
        console.error('Erro ao excluir:', err);
        alert('Erro ao excluir: ' + err.message);
      }
    });

    function addClickEvent(selector, tipo) {
      document.querySelectorAll(selector).forEach(card => {
        card.addEventListener('click', () => {
          const data = JSON.parse(decodeURIComponent(card.dataset.data));
          abrirModal(tipo, data);
        });
      });
    }

    function renderEx(lista) {
      const el = document.getElementById('ex-cards');
      const empty = document.getElementById('ex-empty');
      el.innerHTML = '';
      if (lista.length === 0) return empty.classList.remove('hidden');
      empty.classList.add('hidden');
      lista.forEach(d => {
        const safeData = encodeURIComponent(JSON.stringify(d));
        el.innerHTML += `<div class='ex-card bg-gray-800 border border-gray-700 p-4 rounded-lg cursor-pointer hover:bg-gray-700 transition' data-data='${safeData}'>
          <h3 class='text-xl font-semibold mb-1'>${d.nome || 'Sem nome'}</h3>
          <p class='text-gray-400 mb-1'>Grupo: ${d.grupo || '-'} </p>
          <p class='text-gray-400 mb-1'>Séries: ${d.series || '-'} </p>
          <p class='text-gray-400 mb-1'>Repetições: ${d.reps || '-'} </p>
        </div>`;
      });
      addClickEvent('.ex-card', 'exercicio');
    }

    function renderGr(lista) {
      const el = document.getElementById('grupo-cards');
      const empty = document.getElementById('grupo-empty');
      el.innerHTML = '';
      if (lista.length === 0) return empty.classList.remove('hidden');
      empty.classList.add('hidden');
      lista.forEach(d => {
        const safeData = encodeURIComponent(JSON.stringify(d));
        el.innerHTML += `<div class='gr-card bg-gray-800 border border-gray-700 p-4 rounded-lg cursor-pointer hover:bg-gray-700 transition' data-data='${safeData}'>
          <h3 class='text-xl font-semibold mb-1'>${d.nome || 'Sem nome'}</h3>
          <p class='text-gray-400'>${(d.exercicios || '').toString()}</p>
        </div>`;
      });
      addClickEvent('.gr-card', 'grupo');
    }

    function renderDi(lista) {
      const el = document.getElementById('diario-cards');
      const empty = document.getElementById('diario-empty');
      el.innerHTML = '';
      if (lista.length === 0) return empty.classList.remove('hidden');
      empty.classList.add('hidden');
      lista.forEach(d => {
        const safeData = encodeURIComponent(JSON.stringify(d));
        el.innerHTML += `<div class='di-card bg-gray-800 border border-gray-700 p-4 rounded-lg cursor-pointer hover:bg-gray-700 transition' data-data='${safeData}'>
          <h3 class='text-xl font-semibold mb-1'>${d.grupo || 'Sem grupo'}</h3>
          <p class='text-gray-400 mb-1'>${d.data || 'Sem data'}</p>
          <p class='text-gray-400 mb-1'>Reps: ${d.reps || '-'} </p>
        </div>`;
      });
      addClickEvent('.di-card', 'diario');
    }
  </script>
</body>
</html>